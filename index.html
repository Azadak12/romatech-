<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Subaccount Change Tracker</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Inter, system-ui, sans-serif; }
</style>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- ================= ROLE MODAL ================= -->
<div id="roleModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
    <h2 class="text-lg font-semibold mb-4">Join Workspace</h2>

    <label class="text-sm font-medium">Your Name</label>
    <input id="rmName" class="w-full border rounded-xl px-3 py-2 mt-1 mb-3">

    <label class="text-sm font-medium">Role</label>
    <select id="rmRole" class="w-full border rounded-xl px-3 py-2 mt-1 mb-3">
      <option value="builder">Builder (Admin)</option>
      <option value="client">Client</option>
    </select>

    <label class="text-sm font-medium">Workspace ID</label>
    <input id="rmWorkspace" class="w-full border rounded-xl px-3 py-2 mt-1 mb-4"
      placeholder="e.g. branham-board">

    <button onclick="enterApp()"
      class="w-full bg-indigo-600 text-white rounded-xl py-2 font-semibold">
      Enter
    </button>
  </div>
</div>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <div>
      <h1 class="font-semibold text-lg">Subaccount Change Tracker</h1>
      <p class="text-sm text-slate-500">
        Requested → Clarification → In Progress → Client Review → Done
      </p>
    </div>

    <div class="flex items-center gap-3 text-sm">
      <!-- Filter -->
      <select id="filterSubaccount"
        class="border rounded-xl px-3 py-2 bg-white">
        <option value="">All Subaccounts</option>
      </select>

      <!-- User badge -->
      <span id="userBadge" class="text-slate-600"></span>

      <!-- Logout -->
      <button onclick="logout()"
        class="border rounded-xl px-3 py-2 hover:bg-slate-100">
        Logout
      </button>
    </div>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-5">

  <!-- SIDEBAR -->
  <aside class="lg:col-span-3 bg-white rounded-2xl border p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-semibold">Subaccounts</h2>
      <button id="addSubBtn"
        onclick="addSubaccount()"
        class="text-sm border rounded-xl px-3 py-1">
        + Add
      </button>
    </div>

    <div id="subList" class="space-y-2"></div>
  </aside>

  <!-- BOARD -->
  <section class="lg:col-span-9">
    <div id="board"
      class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
    </div>
  </section>

</main>

<!-- ================= DETAILS MODAL ================= -->
<div id="detailsModal"
  class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl w-full max-w-2xl p-4">

    <div class="flex justify-between items-center mb-3">
      <h3 id="dTitle" class="font-semibold"></h3>
      <button onclick="closeDetails()">✕</button>
    </div>

    <div id="thread"
      class="space-y-2 max-h-64 overflow-auto border rounded-xl p-2 mb-3">
    </div>

    <div class="flex gap-2">
      <input id="msgText"
        placeholder="Write update…"
        class="flex-1 border rounded-xl px-3 py-2">
      <button onclick="addMessage()"
        class="bg-indigo-600 text-white px-3 rounded-xl">
        Send
      </button>
    </div>

    <div id="builderActions"
      class="mt-4 flex gap-2 hidden">
      <button onclick="builderMove('clarify')"
        class="border px-3 py-2 rounded-xl">
        Need Clarification
      </button>
      <button onclick="builderMove('review')"
        class="bg-slate-900 text-white px-3 py-2 rounded-xl">
        Send for Review
      </button>
      <button onclick="builderMove('done')"
        class="bg-emerald-600 text-white px-3 py-2 rounded-xl">
        Mark Done
      </button>
    </div>

    <div id="clientActions"
      class="mt-4 flex gap-2 hidden">
      <button onclick="clientApprove()"
        class="bg-emerald-600 text-white px-4 py-2 rounded-xl">
        Approve Done
      </button>
      <button onclick="clientRequestChanges()"
        class="border px-4 py-2 rounded-xl">
        Request Changes
      </button>
    </div>

  </div>
</div>

<!-- ================= APP SCRIPT ================= -->
<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= STATE ================= */
let USER = null;
let ROLE = null;
let WS = null;
let subaccounts = [];
let tasks = [];
let currentTask = null;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);
const isBuilder = () => ROLE === "builder";
const isClient  = () => ROLE === "client";

const STATUS = [
  {id:"requested",label:"Requested"},
  {id:"clarify",label:"Clarification"},
  {id:"progress",label:"In Progress"},
  {id:"review",label:"Client Review"},
  {id:"done",label:"Done"}
];

const subRef  = () => db.collection("workspaces").doc(WS).collection("subaccounts");
const taskRef = () => db.collection("workspaces").doc(WS).collection("tasks");

/* ================= AUTH ================= */
auth.signInAnonymously();

/* ================= ENTER ================= */
window.enterApp = function(){
  USER = $("rmName").value.trim();
  ROLE = $("rmRole").value;
  WS   = $("rmWorkspace").value.trim();

  if(!USER || !WS) return alert("Name & Workspace required");

  $("roleModal").classList.add("hidden");
  $("userBadge").textContent = `${USER} (${ROLE}) • ${WS}`;
  $("addSubBtn").style.display = isBuilder() ? "inline-flex" : "none";

  listenRealtime();
};

/* ================= LOGOUT ================= */
window.logout = async function(){
  if(!confirm("Logout from this workspace?")) return;
  await auth.signOut();
  location.reload();
};

/* ================= REALTIME ================= */
function listenRealtime(){
  subRef().onSnapshot(snap=>{
    subaccounts = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderSubaccounts();
    renderFilter();
    renderBoard();
  });

  taskRef().onSnapshot(snap=>{
    tasks = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderSubaccounts();
    renderBoard();
  });
}

/* ================= FILTER ================= */
$("filterSubaccount").addEventListener("change",renderBoard);

function renderFilter(){
  const sel = $("filterSubaccount");
  const current = sel.value;
  sel.innerHTML = `<option value="">All Subaccounts</option>` +
    subaccounts.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  sel.value = current || "";
}

/* ================= SUBACCOUNTS ================= */
window.addSubaccount = async function(){
  if(!isBuilder()) return alert("Only builder can add");
  const name = prompt("Subaccount name");
  if(!name) return;
  await subRef().add({
    name,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
};

function renderSubaccounts(){
  const wrap = $("subList");
  wrap.innerHTML = "";

  subaccounts.forEach(sa=>{
    const total = tasks.filter(t=>t.subaccountId===sa.id).length;
    const done  = tasks.filter(t=>t.subaccountId===sa.id && t.status==="done").length;
    const pct   = total ? Math.round((done/total)*100) : 0;

    const div = document.createElement("div");
    div.className="border rounded-xl p-3 cursor-pointer hover:bg-slate-50";
    div.innerHTML=`
      <div class="font-medium">${sa.name}</div>
      <div class="text-xs text-slate-500">${pct}% complete</div>
      <div class="h-2 bg-slate-100 rounded mt-2">
        <div class="h-2 bg-indigo-600 rounded" style="width:${pct}%"></div>
      </div>
    `;
    div.onclick=()=>{
      $("filterSubaccount").value=sa.id;
      renderBoard();
    };
    wrap.appendChild(div);
  });
}

/* ================= BOARD ================= */
function renderBoard(){
  const filter = $("filterSubaccount").value;
  const list = filter ? tasks.filter(t=>t.subaccountId===filter) : tasks;
  const board = $("board");
  board.innerHTML="";

  STATUS.forEach(col=>{
    const box=document.createElement("div");
    box.className="bg-white border rounded-2xl p-3 min-h-[320px]";
    const items=list.filter(t=>t.status===col.id);

    box.innerHTML=`
      <div class="flex justify-between mb-2">
        <h3 class="font-semibold">${col.label}</h3>
        <span class="text-xs">${items.length}</span>
      </div>
    `;

    items.forEach(t=>{
      const card=document.createElement("div");
      card.className="border rounded-xl p-2 mb-2 hover:bg-slate-50 cursor-pointer";
      card.textContent=t.title;
      card.onclick=()=>openDetails(t.id);
      box.appendChild(card);
    });

    board.appendChild(box);
  });
}

/* ================= DETAILS ================= */
function openDetails(id){
  currentTask = tasks.find(t=>t.id===id);
  $("detailsModal").classList.remove("hidden");
  $("dTitle").textContent=currentTask.title;
  renderThread();
  updatePanels();
}

window.closeDetails=function(){
  $("detailsModal").classList.add("hidden");
  currentTask=null;
};

function updatePanels(){
  $("builderActions").classList.toggle("hidden",!isBuilder());
  $("clientActions").classList.toggle("hidden",!(isClient() && currentTask.status==="review"));
}

function renderThread(){
  const t=$("thread");
  t.innerHTML="";
  (currentTask.messages||[]).forEach(m=>{
    const d=document.createElement("div");
    d.className="border rounded p-2 text-sm";
    d.innerHTML=`<b>${m.by}</b>: ${m.text}`;
    t.appendChild(d);
  });
}

/* ================= MESSAGES ================= */
window.addMessage=async function(){
  const text=$("msgText").value.trim();
  if(!text) return;
  await taskRef().doc(currentTask.id).update({
    messages: firebase.firestore.FieldValue.arrayUnion({
      text, by:USER, at:new Date().toISOString()
    })
  });
  $("msgText").value="";
};

/* ================= MOVES ================= */
window.builderMove=async function(s){
  await taskRef().doc(currentTask.id).update({status:s});
};

window.clientApprove=async function(){
  await taskRef().doc(currentTask.id).update({status:"done"});
};

window.clientRequestChanges=async function(){
  await taskRef().doc(currentTask.id).update({status:"progress"});
};
</script>

</body>
</html>
