<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agency Task Tracker (Branham & Co)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    ::-webkit-scrollbar{ width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); border-radius: 999px; }
    ::-webkit-scrollbar-track{ background: transparent; }

    .fade-in { animation: fadeIn .2s ease-out both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px) scale(.99);} to {opacity:1; transform:none;} }

    .glass { backdrop-filter: blur(10px); }
    
    .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
    .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
  </style>
</head>

<body class="min-h-screen text-slate-900 bg-[radial-gradient(1200px_600px_at_20%_0%,rgba(99,102,241,.10),transparent_55%),radial-gradient(900px_500px_at_85%_10%,rgba(168,85,247,.10),transparent_50%),linear-gradient(to_bottom,rgba(248,250,252,1),rgba(241,245,249,1))]">

<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] hidden">
  <div class="fade-in rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm shadow-xl flex items-center gap-2">
    <span id="toastText">Saved</span>
  </div>
</div>

<div id="authModal" class="fixed inset-0 z-50 bg-black/40 glass flex items-center justify-center p-4">
  <div class="fade-in w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-2xl overflow-hidden">
    <div class="p-5 border-b border-slate-100">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-lg"></div>
        <div class="min-w-0">
          <div class="font-extrabold leading-tight text-lg">Tracker Login</div>
          <div class="text-xs text-slate-500">Agency Operations</div>
        </div>
      </div>
    </div>
    <div class="p-5 space-y-4">
      <div>
        <label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Workspace</label>
        <input id="wsInput" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="e.g. AgencyName" autocomplete="off" />
      </div>
      <div>
        <label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Name (Username)</label>
        <input id="usernameInput" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="e.g. branham" autocomplete="username" />
      </div>
      <div>
        <label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Password</label>
        <input id="passwordInput" type="password" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Min 6 characters" autocomplete="current-password" />
      </div>
      <div>
        <label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Role</label>
        <select id="roleInput" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="client">Agency Owner (Branham)</option>
          <option value="ghl_expert">GHL Expert (Yashfa / Kalam)</option>
          <option value="builder">Builder (Admin)</option>
        </select>
      </div>
      <div id="authMsg" class="text-sm text-rose-600 font-medium hidden"></div>
      <div class="pt-2 flex gap-3">
        <button id="loginBtn" class="flex-1 rounded-xl bg-slate-900 text-white px-4 py-3 text-sm font-bold hover:bg-slate-800 active:scale-[.98] transition shadow-lg">Login</button>
        <button id="registerBtn" class="flex-1 rounded-xl bg-indigo-600 text-white px-4 py-3 text-sm font-bold hover:bg-indigo-700 active:scale-[.98] transition shadow-lg shadow-indigo-200">Register</button>
      </div>
    </div>
  </div>
</div>

<header class="sticky top-0 z-40 border-b border-slate-200/80 bg-white/80 glass backdrop-blur-md">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3 min-w-0">
      <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-md"></div>
      <div class="min-w-0 hidden sm:block">
        <h1 class="text-sm font-extrabold leading-tight text-slate-900">Task Tracker</h1>
        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wider">Agency Operations</p>
      </div>
    </div>

    <div class="flex items-center gap-3 flex-1 justify-end">
      <div class="relative hidden md:block max-w-md w-full">
        <input id="searchInput" type="text" placeholder="Search..." class="w-full rounded-xl border border-slate-200 bg-white/50 pl-10 pr-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition" />
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</div>
      </div>

      <select id="filterSubaccount" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 max-w-[150px] truncate">
        <option value="">All Subs</option>
      </select>

      <button id="newTaskBtn" style="display:none;" class="rounded-xl bg-indigo-600 px-4 py-2 text-sm font-bold text-white shadow-md shadow-indigo-200 hover:bg-indigo-700 active:scale-[.98] transition whitespace-nowrap">+ New Request</button>

      <div class="relative">
        <button id="notifBtn" class="h-9 w-9 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 active:scale-[.95] transition flex items-center justify-center relative">
          üîî <span id="notifCount" class="absolute -top-1 -right-1 h-4 w-4 flex items-center justify-center text-[9px] font-bold rounded-full bg-rose-500 text-white hidden">0</span>
        </button>
        <div id="notifPanel" class="hidden absolute right-0 mt-3 w-[360px] max-w-[90vw] rounded-2xl bg-white border border-slate-100 shadow-xl overflow-hidden z-50">
          <div class="p-3 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
            <div class="font-bold text-xs uppercase tracking-wider text-slate-500">Notifications</div>
            <button id="markAllReadBtn" class="text-[10px] font-bold text-indigo-600 hover:underline">Mark read</button>
          </div>
          <div id="notifList" class="max-h-[300px] overflow-y-auto"></div>
        </div>
      </div>

      <button id="logoutBtn" class="text-xs font-bold text-slate-500 hover:text-slate-800 px-2 transition">Logout</button>
    </div>
  </div>
</header>

<main class="max-w-[1600px] mx-auto px-4 sm:px-6 py-6 h-[calc(100vh-65px)] overflow-hidden flex flex-col lg:flex-row gap-6">
  <aside class="hidden lg:flex flex-col w-64 shrink-0 gap-4 h-full pb-2">
    <div class="flex-1 rounded-3xl bg-white border border-slate-200 shadow-sm overflow-hidden flex flex-col">
      <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
        <h2 class="font-bold text-sm text-slate-700">Subaccounts</h2>
        <button id="addSubBtn" style="display:none;" class="text-xs font-bold bg-white border border-slate-200 rounded-lg px-2 py-1 hover:bg-slate-50 transition">+ Add</button>
      </div>
      <div id="subList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>
    <div class="rounded-2xl bg-indigo-50 border border-indigo-100 p-4">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs" id="userInitials">U</div>
        <div class="min-w-0">
          <div id="userBadge" class="font-bold text-sm text-indigo-900 truncate">User</div>
          <div id="wsBadge" class="text-xs text-indigo-500 truncate">Workspace</div>
        </div>
      </div>
    </div>
  </aside>

  <section class="flex-1 h-full overflow-x-auto overflow-y-hidden pb-4">
    <div id="board" class="h-full flex gap-5 min-w-max px-1"></div>
  </section>
</main>

<div id="subModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-md rounded-3xl bg-white shadow-2xl p-6">
    <h3 class="font-bold text-lg mb-1">Add Subaccount</h3>
    <input id="subNameInput" class="w-full rounded-xl border border-slate-200 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500 mt-2" placeholder="e.g. Acme Solar" />
    <div class="mt-6 flex justify-end gap-3">
      <button id="closeSubModalBtn" class="px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-100">Cancel</button>
      <button id="saveSubBtn" class="px-6 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button>
    </div>
  </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-2xl rounded-3xl bg-white shadow-2xl flex flex-col max-h-[90vh]">
    <div class="p-6 border-b border-slate-100 flex items-center justify-between">
      <h3 class="font-bold text-xl">New Request</h3>
      <button id="closeTaskModal" class="h-8 w-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-500">‚úï</button>
    </div>
    <div class="p-6 overflow-y-auto space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Title</label><input id="tTitle" class="w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
        <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Subaccount</label><select id="tSub" class="w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"></select></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Assign Expert</label>
          <select id="tAssignee" class="w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
            <option value="kalam">Kalam</option>
            <option value="yashfa">Yashfa</option>
          </select>
        </div>
        <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Attachment URL</label><input id="tAttach" class="w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="https://..." /></div>
      </div>
      <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Details</label><textarea id="tDetails" rows="5" class="w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea></div>
    </div>
    <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-3xl flex justify-end gap-3">
      <button id="cancelTaskBtn" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm">Cancel</button>
      <button id="createTaskBtn" class="px-6 py-2.5 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200">Create & Notify</button>
    </div>
  </div>
</div>

<div id="detailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-6xl h-[85vh] rounded-3xl bg-white shadow-2xl flex overflow-hidden">
    <div class="w-full lg:w-1/3 bg-slate-50 border-r border-slate-200 flex flex-col">
      <div class="p-6 border-b border-slate-200">
        <div class="flex items-start justify-between">
            <h3 id="dTitle" class="font-bold text-xl text-slate-900 leading-tight"></h3>
            <button id="closeDetailsModal" class="text-slate-400 hover:text-slate-700">‚úï</button>
        </div>
        <div id="dMeta" class="mt-2 text-xs font-medium text-slate-500"></div>
        <a id="dAttachLink" href="#" target="_blank" class="hidden mt-3 inline-flex items-center gap-1 text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100 hover:bg-indigo-100">üìé Attachment</a>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-5">
        <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-500">Status</label><select id="dStatus" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></select></div>
        <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-500">Subaccount</label><select id="dSub" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></select></div>
        <div class="space-y-1"><label class="text-[10px] font-bold uppercase text-slate-500">Details</label><textarea id="dDetails" rows="8" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea></div>
        <div id="expertControls" class="grid grid-cols-2 gap-2 pt-2">
            <button onclick="updateStatus('clarify')" class="p-2 rounded-lg bg-white border border-slate-200 text-xs font-bold">‚ö†Ô∏è Clarify</button>
            <button onclick="updateStatus('progress')" class="p-2 rounded-lg bg-white border border-slate-200 text-xs font-bold">üî® In Progress</button>
            <button onclick="updateStatus('review')" class="col-span-2 p-2 rounded-lg bg-slate-800 text-white text-xs font-bold">üëÄ Send for Review</button>
            <button onclick="updateStatus('done')" class="col-span-2 p-2 rounded-lg bg-emerald-600 text-white text-xs font-bold">‚úÖ Mark Done</button>
        </div>
        <div id="clientControls" class="hidden grid grid-cols-2 gap-2 pt-2">
            <button onclick="updateStatus('done')" class="col-span-2 p-3 rounded-xl bg-emerald-600 text-white text-sm font-bold shadow-lg">Approve ‚úÖ</button>
            <button onclick="updateStatus('clarify')" class="col-span-2 p-2 rounded-xl border border-rose-200 text-rose-600 text-sm font-bold">Request Changes</button>
        </div>
        <button id="saveTaskBtn" class="w-full py-2.5 rounded-xl bg-indigo-600 text-white text-sm font-bold shadow-lg hover:bg-indigo-700">Save Changes</button>
      </div>
    </div>
    <div class="w-full lg:w-2/3 flex flex-col bg-white">
      <div class="p-4 border-b border-slate-100 bg-slate-50/30"><h4 class="font-bold text-sm text-slate-700">Discussion</h4></div>
      <div id="thread" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
      <div class="p-4 border-t border-slate-100 bg-slate-50">
        <div class="flex gap-2">
          <input id="msgInput" class="flex-1 rounded-xl border border-slate-200 px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Type a message..." />
          <button id="sendMsgBtn" class="bg-indigo-600 text-white px-5 rounded-xl font-bold hover:bg-indigo-700 transition">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =================================================================
   üî¥ CONFIGURATION: PASTE YOUR N8N URL HERE
   ================================================================= */
// IMPORTANT: Use the Production URL from n8n (not the Test URL) when going live
const EMAIL_WEBHOOK_URL = ""; 
const RECIPIENT_EMAIL = "kalamshar786@gmail.com";

/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a",
  measurementId: "G-7CWF4D2V3T"
};
if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   HELPERS & n8n LOGIC
========================= */
const $ = (id) => document.getElementById(id);
const clean = (s) => (s || "").trim();
const nowISO = () => new Date().toISOString();
const escapeHtml = (str) => (str ?? "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");

function linkify(text) {
  const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  return escapeHtml(text).replace(urlRegex, (url) => {
    return `<a href="${url}" target="_blank" class="text-indigo-600 font-medium hover:underline break-all relative z-10" onclick="event.stopPropagation()">${url}</a>`;
  });
}

function showToast(msg) {
  const t = $("toast");
  $("toastText").textContent = msg;
  t.classList.remove("hidden");
  setTimeout(() => t.classList.add("hidden"), 2000);
}

// ‚ö°Ô∏è CENTRAL WEBHOOK FUNCTION FOR N8N
async function notifyWebhook(actionType, taskTitle, details) {
    if(!EMAIL_WEBHOOK_URL) return;

    try {
        await fetch(EMAIL_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                recipient: RECIPIENT_EMAIL,
                subject: `[Task Tracker] ${actionType}: ${taskTitle}`,
                message: `Action by: ${USER} (${ROLE})\n\nDetails:\n${details}`,
                sentAt: new Date().toLocaleString()
            })
        });
        console.log("üìß Notification sent to n8n:", actionType);
    } catch(e) {
        console.error("Notification failed", e);
    }
}

// Global State
let WS = null, USER = null, ROLE = null, UID = null;
let subaccounts = [], tasks = [], notifications = [];
let currentTaskId = null;
const COLUMNS = [
  { id: "requested", label: "Requested", color: "bg-sky-500" },
  { id: "clarify", label: "Clarification", color: "bg-amber-500" },
  { id: "progress", label: "In Progress", color: "bg-indigo-500" },
  { id: "review", label: "Client Review", color: "bg-fuchsia-500" },
  { id: "done", label: "Done", color: "bg-emerald-500" }
];

const isBuilder = () => ROLE === "builder";
const isExpert = () => ROLE === "ghl_expert";
const isClient = () => ROLE === "client";
const canCreate = () => isClient() || isBuilder();
const canAddSub = () => true;

/* =========================
   AUTH
========================= */
async function authenticate(isRegister) {
  const ws = clean($("wsInput").value);
  const username = clean($("usernameInput").value).toLowerCase();
  const password = $("passwordInput").value;
  const role = $("roleInput").value;
  if (!ws || !username || !password) return alert("All fields required");
  const email = `${username}@${ws}.local`;
  try {
    let userCred;
    if (isRegister) {
      userCred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection("workspaces").doc(ws).collection("users").doc(userCred.user.uid).set({
        username, role, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } else {
      userCred = await auth.signInWithEmailAndPassword(email, password);
    }
    await loadUserProfile(ws, username, userCred.user.uid);
  } catch (e) {
    $("authMsg").textContent = e.message;
    $("authMsg").classList.remove("hidden");
  }
}

async function loadUserProfile(ws, username, uid) {
  WS = ws; USER = username; UID = uid;
  const snap = await db.collection("workspaces").doc(WS).collection("users").doc(UID).get();
  ROLE = snap.exists ? snap.data().role : "client";
  $("authModal").classList.add("hidden");
  $("userBadge").textContent = USER;
  $("wsBadge").textContent = WS + " ‚Ä¢ " + ROLE;
  $("userInitials").textContent = USER.substring(0,2).toUpperCase();
  $("newTaskBtn").style.display = canCreate() ? "block" : "none";
  $("addSubBtn").style.display = canAddSub() ? "block" : "none";
  initRealtime();
}

$("loginBtn").onclick = () => authenticate(false);
$("registerBtn").onclick = () => authenticate(true);
$("logoutBtn").onclick = () => { auth.signOut(); location.reload(); };

/* =========================
   DATA & RENDER
========================= */
function initRealtime() {
  const root = db.collection("workspaces").doc(WS);
  root.collection("subaccounts").orderBy("createdAt", "desc").onSnapshot(snap => {
    subaccounts = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderSubs(); renderBoard(); updateDropdowns();
  });
  root.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
    tasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderBoard();
    if (currentTaskId) {
      const t = tasks.find(x => x.id === currentTaskId);
      if (t) renderDetails(t);
    }
  });
  root.collection("notifications").where("toUsername", "==", USER).orderBy("createdAt", "desc").limit(20).onSnapshot(snap => {
    notifications = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderNotifs();
  });
}

function updateDropdowns() {
  const generateOptions = (includeCount) => {
      return subaccounts.map(s => {
          const count = tasks.filter(t => t.subaccountId === s.id && t.status !== 'done').length;
          const label = includeCount && count > 0 ? `${escapeHtml(s.name)} (${count} Open)` : escapeHtml(s.name);
          return `<option value="${s.id}">${label}</option>`;
      }).join("");
  };
  const currentFilter = $("filterSubaccount").value;
  $("filterSubaccount").innerHTML = `<option value="">All Subs</option>` + generateOptions(true);
  $("filterSubaccount").value = currentFilter;
  $("tSub").innerHTML = generateOptions(true);
  $("dSub").innerHTML = generateOptions(false);
  $("dStatus").innerHTML = COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join("");
}

function renderSubs() {
  const list = $("subList");
  list.innerHTML = "";
  if (subaccounts.length === 0) { list.innerHTML = `<div class="text-xs text-slate-400 p-2 italic">No subaccounts.</div>`; return; }
  subaccounts.forEach(s => {
     const total = tasks.filter(t => t.subaccountId === s.id).length;
     const open = tasks.filter(t => t.subaccountId === s.id && t.status !== 'done').length;
     const div = document.createElement("button");
     div.className = "w-full text-left px-3 py-2.5 rounded-xl text-sm hover:bg-slate-50 flex justify-between items-center group transition";
     div.innerHTML = `<span class="font-medium text-slate-700 group-hover:text-indigo-600 truncate mr-2">${escapeHtml(s.name)}</span>${open > 0 ? `<span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">${open}</span>` : `<span class="text-[10px] text-slate-300">${total}</span>`}`;
     div.onclick = () => { 
         $("filterSubaccount").value = s.id; renderBoard(); 
         Array.from(list.children).forEach(c => c.classList.remove("bg-indigo-50", "border-indigo-100"));
         div.classList.add("bg-indigo-50", "border", "border-indigo-100");
     };
     list.appendChild(div);
  });
}

function renderBoard() {
  const board = $("board");
  board.innerHTML = "";
  const filterSub = $("filterSubaccount").value;
  const search = $("searchInput").value.toLowerCase();
  const filtered = tasks.filter(t => {
    if (filterSub && t.subaccountId !== filterSub) return false;
    if (search && !t.title.toLowerCase().includes(search)) return false;
    return true;
  });
  COLUMNS.forEach(col => {
    const colTasks = filtered.filter(t => (t.status || 'requested') === col.id);
    const colDiv = document.createElement("div");
    colDiv.className = "w-[320px] shrink-0 flex flex-col h-full rounded-2xl bg-slate-50/50 border border-slate-200/60";
    colDiv.innerHTML = `<div class="p-4 flex items-center justify-between shrink-0"><div class="flex items-center gap-2"><div class="h-2 w-2 rounded-full ${col.color}"></div><h3 class="font-bold text-sm text-slate-700 uppercase">${col.label}</h3></div><span class="text-xs font-bold text-slate-400 bg-white px-2 py-0.5 rounded-md border border-slate-100">${colTasks.length}</span></div><div class="flex-1 overflow-y-auto px-2 pb-2 space-y-3" id="col_${col.id}" data-status="${col.id}"></div>`;
    const zone = colDiv.querySelector(`#col_${col.id}`);
    colTasks.forEach(t => {
       const subName = subaccounts.find(s => s.id === t.subaccountId)?.name || "‚Äî";
       const card = document.createElement("div");
       card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 cursor-pointer hover:shadow-md hover:border-indigo-100 transition group relative";
       card.setAttribute("data-id", t.id);
       card.innerHTML = `<div class="flex justify-between items-start mb-2"><span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100 truncate max-w-[120px]">${escapeHtml(subName)}</span><span class="text-[10px] text-slate-400">@${t.assigneeUsername}</span></div><h4 class="font-bold text-sm text-slate-800 leading-snug mb-2">${escapeHtml(t.title)}</h4>${t.attachmentUrl ? `<div class="mb-2 text-[10px] flex items-center gap-1 text-indigo-500 font-bold">üìé Attached</div>` : ''}<div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-50"><div class="text-[10px] text-slate-400">${new Date(t.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString()}</div><div class="text-[10px] font-bold text-slate-500 flex items-center gap-1">üí¨ ${(t.messages||[]).length}</div></div>`;
       card.addEventListener('click', () => openDetails(t.id));
       zone.appendChild(card);
    });
    board.appendChild(colDiv);
    new Sortable(zone, {
        group: 'shared', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true,
        onEnd: function (evt) {
            const taskId = evt.item.getAttribute('data-id');
            const newStatus = evt.to.getAttribute('data-status');
            if (newStatus !== evt.from.getAttribute('data-status')) {
                const t = tasks.find(x => x.id === taskId);
                db.collection("workspaces").doc(WS).collection("tasks").doc(taskId).update({status: newStatus});
                // üìß TRIGGER EMAIL (Drag & Drop)
                notifyWebhook("Status Change", t?.title || "Task", `Moved to ${newStatus}`);
                showToast(`Moved to ${newStatus}`);
            }
        }
    });
  });
}

function renderNotifs() {
  const list = $("notifList");
  list.innerHTML = "";
  const unread = notifications.filter(n => !n.read).length;
  $("notifCount").textContent = unread;
  $("notifCount").classList.toggle("hidden", unread===0);
  if(notifications.length === 0) { list.innerHTML = `<div class="p-4 text-center text-xs text-slate-400">All caught up!</div>`; return; }
  notifications.forEach(n => {
     const div = document.createElement("div");
     div.className = `p-3 border-b border-slate-50 text-xs cursor-pointer ${n.read ? 'bg-white opacity-60' : 'bg-indigo-50/50'}`;
     div.innerHTML = `<div class="font-bold ${n.read?'text-slate-700':'text-indigo-700'}">${escapeHtml(n.title)}</div><div class="text-slate-500 truncate mt-0.5">${escapeHtml(n.body)}</div>`;
     div.onclick = async () => { await db.collection("workspaces").doc(WS).collection("notifications").doc(n.id).update({read:true}); if(n.taskId) openDetails(n.taskId); };
     list.appendChild(div);
  });
}

$("addSubBtn").onclick = () => { $("subModal").classList.remove("hidden"); $("subModal").classList.add("flex"); };
$("closeSubModalBtn").onclick = () => $("subModal").classList.add("hidden");
$("saveSubBtn").onclick = async () => {
   const name = clean($("subNameInput").value);
   if(!name) return;
   await db.collection("workspaces").doc(WS).collection("subaccounts").add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
   $("subModal").classList.add("hidden");
   showToast("Subaccount added");
};

$("newTaskBtn").onclick = () => { 
    if(!isClient() && !isBuilder()) return alert("Only Clients can request.");
    $("taskModal").classList.remove("hidden"); $("taskModal").classList.add("flex"); 
};
$("closeTaskModal").onclick = () => $("taskModal").classList.add("hidden");
$("cancelTaskBtn").onclick = () => $("taskModal").classList.add("hidden");

/* CREATE TASK */
$("createTaskBtn").onclick = async () => {
    const title = clean($("tTitle").value);
    const subId = $("tSub").value;
    const assignee = clean($("tAssignee").value);
    const details = clean($("tDetails").value);
    const attachmentUrl = clean($("tAttach").value);
    if(!title || !subId || !assignee) return alert("Title, Subaccount, and Assignee are required.");
    const ref = await db.collection("workspaces").doc(WS).collection("tasks").add({
        title, details, subaccountId: subId, assigneeUsername: assignee, attachmentUrl,
        status: 'requested', createdBy: USER, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        messages: [{by: USER, role: ROLE, text: "Request created.", at: nowISO()}]
    });
    await db.collection("workspaces").doc(WS).collection("notifications").add({
        toUsername: assignee, title: "New Task", body: title, taskId: ref.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // üìß TRIGGER EMAIL (Create)
    notifyWebhook("New Task", title, details);
    $("taskModal").classList.add("hidden");
    $("tTitle").value = ""; $("tDetails").value = ""; $("tAttach").value = "";
    showToast("Task Created");
};

function openDetails(id) {
    currentTaskId = id;
    const t = tasks.find(x => x.id === id);
    if(!t) return;
    $("detailsModal").classList.remove("hidden"); $("detailsModal").classList.add("flex");
    $("dTitle").textContent = t.title;
    $("dMeta").textContent = `@${t.assigneeUsername} ‚Ä¢ Created by ${t.createdBy || '?'}`;
    $("dStatus").value = t.status;
    $("dSub").value = t.subaccountId;
    $("dDetails").value = t.details || "";
    if(t.attachmentUrl) { $("dAttachLink").href = t.attachmentUrl; $("dAttachLink").classList.remove("hidden"); $("dAttachLink").classList.add("inline-flex"); } else { $("dAttachLink").classList.add("hidden"); }
    if(isClient() && t.status === 'review') { $("clientControls").classList.remove("hidden"); $("expertControls").classList.add("hidden"); } 
    else { $("clientControls").classList.add("hidden"); $("expertControls").classList.remove("hidden"); }
    renderThread(t);
}

$("closeDetailsModal").onclick = () => { $("detailsModal").classList.add("hidden"); currentTaskId = null; };

function renderThread(t) {
    const div = $("thread"); div.innerHTML = "";
    if(t.details) {
        const d = document.createElement("div"); d.className = "p-4 rounded-xl bg-slate-50 border border-slate-100 mb-4";
        d.innerHTML = `<div class="text-[10px] font-bold uppercase text-slate-400 mb-1">Original Request</div><div class="text-sm text-slate-700 whitespace-pre-wrap">${linkify(t.details)}</div>`;
        div.appendChild(d);
    }
    (t.messages||[]).forEach(m => {
        const isMe = m.by === USER;
        const msg = document.createElement("div");
        msg.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
        msg.innerHTML = `<div class="max-w-[85%] p-3 rounded-2xl text-sm ${isMe ? 'bg-indigo-600 text-white rounded-tr-sm shadow-md' : 'bg-white border border-slate-200 rounded-tl-sm shadow-sm'}">${linkify(m.text)}</div><div class="text-[10px] text-slate-400 mt-1 px-1">${m.by}</div>`;
        div.appendChild(msg);
    });
    div.scrollTop = div.scrollHeight;
}

$("sendMsgBtn").onclick = async () => {
    const txt = clean($("msgInput").value);
    if(!txt || !currentTaskId) return;
    const t = tasks.find(x => x.id === currentTaskId);
    const msgs = [...(t.messages||[]), {by: USER, role: ROLE, text: txt, at: nowISO()}];
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({messages: msgs});
    $("msgInput").value = "";
    // üìß TRIGGER EMAIL (Comment)
    notifyWebhook("New Comment", t.title, `${USER}: ${txt}`);
    if(t.assigneeUsername !== USER) {
        await db.collection("workspaces").doc(WS).collection("notifications").add({
           toUsername: t.assigneeUsername, title: "New Comment", body: `${USER} commented on ${t.title}`, taskId: t.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
};

async function updateStatus(st) {
    if(!currentTaskId) return;
    const t = tasks.find(x => x.id === currentTaskId);
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({status: st});
    // üìß TRIGGER EMAIL (Button Status)
    notifyWebhook("Status Change", t.title, `Moved to ${st}`);
    showToast("Status: " + st);
    if(st === 'done') $("detailsModal").classList.add("hidden");
}

$("saveTaskBtn").onclick = async () => {
    if(!currentTaskId) return;
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({
        details: clean($("dDetails").value), subaccountId: $("dSub").value, status: $("dStatus").value
    });
    showToast("Changes Saved");
};

$("markAllReadBtn").onclick = async () => {
    const batch = db.batch();
    notifications.filter(n=>!n.read).forEach(n => batch.update(db.collection("workspaces").doc(WS).collection("notifications").doc(n.id), {read:true}));
    await batch.commit();
}

$("searchInput").addEventListener("input", renderBoard);
$("filterSubaccount").addEventListener("change", renderBoard);

auth.onAuthStateChanged(u => {
    if(!u) $("authModal").classList.remove("hidden");
    else if(localStorage.getItem('sct_session_v1')) { /* restore logic */ }
});
</script>
</body>
</html>
