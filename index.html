<!doctype html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Agency Task Tracker (Branham & Co)</title>

Â  <script src="https://cdn.tailwindcss.com"></script>

Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

Â  <style>
Â  Â  /* --- Modern Typography --- */
Â  Â  body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
Â  Â Â 
Â  Â  /* --- Custom Scrollbar --- */
Â  Â  ::-webkit-scrollbar { width: 6px; height: 6px; }
Â  Â  ::-webkit-scrollbar-track { background: transparent; }
Â  Â  ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.2); border-radius: 10px; }
Â  Â  ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }

Â  Â  /* --- Animations --- */
Â  Â  .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
Â  Â  .fade-in { animation: fadeIn 0.3s ease-out both; }
Â  Â Â 
Â  Â  @keyframes fadeInUp {Â 
Â  Â  Â  from { opacity: 0; transform: translateY(20px) scale(0.98); }Â 
Â  Â  Â  to { opacity: 1; transform: translateY(0) scale(1); }Â 
Â  Â  }
Â  Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

Â  Â  /* Subtle Background Pulse */
Â  Â  @keyframes bgPulse {
Â  Â  Â  Â  0% { background-position: 0% 50%; }
Â  Â  Â  Â  50% { background-position: 100% 50%; }
Â  Â  Â  Â  100% { background-position: 0% 50%; }
Â  Â  }
Â  Â  .animated-bg {
Â  Â  Â  Â  background-size: 200% 200%;
Â  Â  Â  Â  animation: bgPulse 15s ease infinite;
Â  Â  }

Â  Â  /* --- Glassmorphism --- */
Â  Â  .glass-panel {
Â  Â  Â  background: rgba(255, 255, 255, 0.65);
Â  Â  Â  backdrop-filter: blur(16px);
Â  Â  Â  -webkit-backdrop-filter: blur(16px);
Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.6);
Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
Â  Â  }
Â  Â Â 
Â  Â  .glass-card {
Â  Â  Â  background: rgba(255, 255, 255, 0.85);
Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.8);
Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
Â  Â  Â  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  }
Â  Â  .glass-card:hover {
Â  Â  Â  transform: translateY(-3px) scale(1.01);
Â  Â  Â  box-shadow: 0 15px 30px -5px rgba(99, 102, 241, 0.15), 0 8px 10px -2px rgba(99, 102, 241, 0.05);
Â  Â  Â  border-color: #a5b4fc;
Â  Â  }

Â  Â  /* --- Sidebar Item Active State --- */
Â  Â  .sub-item.active {
Â  Â  Â  Â  background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
Â  Â  Â  Â  border: none;
Â  Â  }
Â  Â  .sub-item:not(.active):hover {
Â  Â  Â  Â  background: rgba(255,255,255,0.8);
Â  Â  Â  Â  transform: translateX(4px);
Â  Â  }

Â  Â  /* --- Drag & Drop --- */
Â  Â  .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; transform: scale(0.95); }
Â  Â  .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.05) rotate(2deg); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 50; }
Â  </style>
</head>

<body class="min-h-screen text-slate-800 bg-gradient-to-br from-indigo-50 via-slate-50 to-purple-50 animated-bg selection:bg-indigo-100 selection:text-indigo-700">

<div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] hidden">
Â  <div class="fade-in-up flex items-center gap-3 px-6 py-3.5 rounded-full bg-slate-900/90 text-white shadow-2xl backdrop-blur-md">
Â  Â  <div class="bg-emerald-500 rounded-full p-1"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
Â  Â  <span id="toastText" class="font-medium text-sm tracking-wide">Action Successful</span>
Â  </div>
</div>

<div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-md p-4 hidden">
Â  <div class="fade-in-up w-full max-w-md bg-white/90 rounded-[2rem] shadow-2xl border border-white overflow-hidden">
Â  Â  <div class="p-8 pb-6 border-b border-slate-100 bg-slate-50/50">
Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  <div class="h-14 w-14 rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-600 shadow-lg shadow-indigo-200 flex items-center justify-center text-white text-2xl">ğŸš€</div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h2 class="font-bold text-2xl text-slate-900 tracking-tight">TaskFlow</h2>
Â  Â  Â  Â  Â  <p class="text-sm text-slate-500 font-medium">Agency Operations System</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="p-8 space-y-5">
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5">Workspace</label>
Â  Â  Â  Â  <input id="wsInput" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block p-3.5 outline-none transition-all" placeholder="e.g. BranhamCo" autocomplete="off">
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5">Username</label>
Â  Â  Â  Â  <input id="usernameInput" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block p-3.5 outline-none transition-all" placeholder="e.g. branham" autocomplete="username">
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5">Password</label>
Â  Â  Â  Â  <input id="passwordInput" type="password" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block p-3.5 outline-none transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5">Role</label>
Â  Â  Â  Â  <select id="roleInput" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block p-3.5 outline-none transition-all">
Â  Â  Â  Â  Â  <option value="client">Agency Owner (Branham)</option>
Â  Â  Â  Â  Â  <option value="ghl_expert">GHL Expert (Yashfa / Kalam)</option>
Â  Â  Â  Â  Â  <option value="builder">Builder (Admin)</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div id="authMsg" class="hidden p-3 rounded-xl bg-rose-50 text-rose-600 text-xs font-bold text-center border border-rose-100"></div>

Â  Â  Â  <div class="flex gap-3 pt-2">
Â  Â  Â  Â  <button id="loginBtn" class="flex-1 text-white bg-slate-900 hover:bg-slate-800 focus:ring-4 focus:ring-slate-200 font-bold rounded-xl text-sm px-5 py-3.5 text-center transition-all active:scale-95 shadow-lg">Login</button>
Â  Â  Â  Â  <button id="registerBtn" class="flex-1 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 focus:ring-4 focus:ring-indigo-100 font-bold rounded-xl text-sm px-5 py-3.5 text-center transition-all active:scale-95">Register</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<header class="glass-panel sticky top-0 z-40">
Â  <div class="max-w-[1920px] mx-auto px-4 sm:px-6 h-18 flex items-center justify-between gap-4 h-16">
Â  Â Â 
Â  Â  <div class="flex items-center gap-3 pl-2">
Â  Â  Â  <div class="h-9 w-9 rounded-xl bg-gradient-to-tr from-indigo-600 to-purple-600 shadow-md shadow-indigo-200 flex items-center justify-center text-white font-bold text-lg">âš¡</div>
Â  Â  Â  <div class="hidden md:block">
Â  Â  Â  Â  <h1 class="text-sm font-extrabold text-slate-900 leading-none tracking-tight">TaskFlow</h1>
Â  Â  Â  Â  <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5">Branham & Co</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="flex items-center gap-4 flex-1 justify-end">
Â  Â  Â Â 
Â  Â  Â  <div class="relative hidden md:block w-72 group">
Â  Â  Â  Â  <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors">
Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="searchInput" type="text" class="block w-full p-2.5 pl-10 text-sm text-slate-700 border border-slate-200 rounded-xl bg-white/50 focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all placeholder-slate-400 shadow-sm" placeholder="Search tasks, details...">
Â  Â  Â  </div>

Â  Â  Â  <select id="filterSubaccount" class="md:hidden bg-white border border-slate-200 text-slate-700 text-xs rounded-xl focus:ring-indigo-500 block p-2 outline-none max-w-[120px] shadow-sm">
Â  Â  Â  Â  <option value="">All Subs</option>
Â  Â  Â  </select>

Â  Â  Â  <button id="newTaskBtn" style="display:none;" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-2.5 px-5 rounded-xl text-xs shadow-lg shadow-slate-200 transition-all hover:-translate-y-0.5 active:scale-95 flex items-center gap-2">
Â  Â  Â  Â  <span class="bg-white/20 rounded-full p-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></span>
Â  Â  Â  Â  New Request
Â  Â  Â  </button>

Â  Â  Â  <div class="relative">
Â  Â  Â  Â  <button id="notifBtn" class="p-2.5 rounded-xl bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm relative active:scale-95">
Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
Â  Â  Â  Â  Â  <span id="notifCount" class="absolute top-2 right-2.5 h-2 w-2 rounded-full bg-rose-500 border border-white hidden"></span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <div id="notifPanel" class="hidden absolute right-0 mt-4 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 overflow-hidden z-50 fade-in-up origin-top-right ring-1 ring-black/5">
Â  Â  Â  Â  Â  <div class="px-4 py-3 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
Â  Â  Â  Â  Â  Â  <h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">Notifications</h3>
Â  Â  Â  Â  Â  Â  <button id="markAllReadBtn" class="text-[10px] text-indigo-600 font-bold hover:underline">Clear all</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="notifList" class="max-h-80 overflow-y-auto"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 border border-white shadow-sm flex items-center justify-center text-xs font-bold text-slate-600 cursor-pointer hover:ring-2 hover:ring-indigo-500 hover:ring-offset-2 transition-all" id="logoutBtn" title="Logout">
Â  Â  Â  Â  <span id="userInitials">?</span>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</header>

<main class="max-w-[1920px] mx-auto px-4 sm:px-6 py-6 h-[calc(100vh-64px)] flex flex-col lg:flex-row gap-6 overflow-hidden">
Â Â 
Â  <aside class="hidden lg:flex flex-col w-72 shrink-0 h-full gap-4 pb-2">
Â  Â  <div class="glass-panel flex-1 rounded-3xl flex flex-col overflow-hidden shadow-sm hover:shadow-md transition-shadow">
Â  Â  Â  <div class="p-5 border-b border-white/50 flex items-center justify-between bg-white/30 backdrop-blur-md">
Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  <span class="text-lg">ğŸ“‚</span>
Â  Â  Â  Â  Â  Â  <h2 class="font-bold text-sm text-slate-800">Subaccounts</h2>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="addSubBtn" class="text-[10px] font-bold bg-white/80 border border-white text-slate-600 hover:text-indigo-600 hover:bg-white rounded-lg px-2.5 py-1.5 transition-all shadow-sm">+ Add</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="subList" class="flex-1 overflow-y-auto p-3 space-y-1.5 custom-scrollbar">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="glass-panel p-4 rounded-2xl flex items-center gap-3 shadow-sm border border-white/60 bg-white/60">
Â  Â  Â  <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm shadow-md">ğŸ‘¤</div>
Â  Â  Â  <div class="min-w-0">
Â  Â  Â  Â  <div id="userBadge" class="font-bold text-sm text-slate-900 truncate">Loading...</div>
Â  Â  Â  Â  <div id="wsBadge" class="text-xs text-slate-500 truncate opacity-80">Workspace</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </aside>

Â  <section class="flex-1 h-full overflow-x-auto overflow-y-hidden pb-4">
Â  Â  <div id="board" class="h-full flex gap-6 min-w-max px-2">
Â  Â  Â  </div>
Â  </section>

</main>

<div id="subModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden">
Â  <div class="fade-in-up w-full max-w-sm bg-white rounded-3xl shadow-2xl p-6 border border-white">
Â  Â  <h3 class="font-bold text-lg mb-1">Add Subaccount</h3>
Â  Â  <p class="text-xs text-slate-500 mb-4">Create a new client bucket.</p>
Â  Â  <input id="subNameInput" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-xl p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g. Acme Solar - Texas" />
Â  Â  <div class="mt-6 flex justify-end gap-2">
Â  Â  Â  <button id="closeSubModalBtn" class="px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50">Cancel</button>
Â  Â  Â  <button id="saveSubBtn" class="px-5 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200">Create</button>
Â  Â  </div>
Â  </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden">
Â  <div class="fade-in-up w-full max-w-2xl bg-white rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-white/50">
Â  Â  <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  <div class="h-8 w-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg">ğŸ“</div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg text-slate-900">New Request</h3>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-500">Submit a task for the GHL Expert</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <button id="closeTaskModal" class="h-8 w-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-rose-500 transition">âœ•</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="p-6 overflow-y-auto space-y-5">
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Task Title</label>
Â  Â  Â  Â  Â  <input id="tTitle" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" placeholder="Short summary..." />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Subaccount</label>
Â  Â  Â  Â  Â  <select id="tSub" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white transition-shadow"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Assign Expert</label>
Â  Â  Â  Â  Â  <select id="tAssignee" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white transition-shadow">
Â  Â  Â  Â  Â  Â  <option value="kalam">Kalam</option>
Â  Â  Â  Â  Â  Â  <option value="yashfa">Yashfa</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Upload File (Image/PDF/Video)</label>
Â  Â  Â  Â  Â  <input type="file" id="tFile" class="w-full border border-slate-200 rounded-xl px-3.5 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Details</label>
Â  Â  Â  Â  <textarea id="tDetails" rows="4" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-shadow" placeholder="Describe what needs to be done..."></textarea>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
Â  Â  Â  <button id="cancelTaskBtn" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition">Cancel</button>
Â  Â  Â  <button id="createTaskBtn" class="px-6 py-2.5 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition transform active:scale-95">Create & Notify</button>
Â  Â  </div>
Â  </div>
</div>

<div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden">
Â  <div class="fade-in-up w-full max-w-5xl h-[85vh] bg-white rounded-3xl shadow-2xl flex overflow-hidden border border-white/50">
Â  Â Â 
Â  Â  <div class="w-full lg:w-1/3 bg-slate-50/80 border-r border-slate-200 flex flex-col">
Â  Â  Â  <div class="p-6 border-b border-slate-200 bg-white/50">
Â  Â  Â  Â  <div class="flex justify-between items-start mb-1">
Â  Â  Â  Â  Â  <div class="flex flex-col">
Â  Â  Â  Â  Â  Â  Â <h3 id="dTitle" class="font-bold text-lg text-slate-900 leading-tight">Task Title</h3>
Â  Â  Â  Â  Â  Â  Â <div id="dMeta" class="text-xs font-medium text-slate-500 mt-1 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="h-2 w-2 rounded-full bg-slate-300"></span> Meta info
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â <button id="btnDeleteTask" class="p-1.5 rounded-lg text-slate-400 hover:text-rose-600 hover:bg-rose-50 transition" title="Delete Task">
Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â <button id="closeDetailsModal" class="p-2 text-slate-400 hover:text-slate-700 transition">âœ•</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <a id="dAttachLink" href="#" target="_blank" class="hidden mt-3 inline-flex items-center gap-2 px-3 py-2 bg-white text-indigo-600 text-xs font-bold rounded-xl border border-indigo-100 hover:border-indigo-300 shadow-sm transition-all hover:-translate-y-0.5">
Â  Â  Â  Â  Â  <span>ğŸ”—</span> View Attachment
Â  Â  Â  Â  </a>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex-1 overflow-y-auto p-6 space-y-5 custom-scrollbar">
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Status</label>
Â  Â  Â  Â  Â  <select id="dStatus" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Subaccount</label>
Â  Â  Â  Â  Â  <select id="dSub" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Description</label>
Â  Â  Â  Â  Â  <textarea id="dDetails" rows="6" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 resize-none transition-shadow"></textarea>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="expertControls" class="grid grid-cols-2 gap-2 pt-2">
Â  Â  Â  Â  Â  <button onclick="updateStatus('clarify')" class="p-2.5 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-600 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200 transition shadow-sm">âš ï¸ Clarify</button>
Â  Â  Â  Â  Â  <button onclick="updateStatus('progress')" class="p-2.5 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition shadow-sm">ğŸ”¨ In Progress</button>
Â  Â  Â  Â  Â  <button onclick="updateStatus('review')" class="col-span-2 p-3 rounded-xl bg-slate-800 text-white text-xs font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200">ğŸ‘€ Send for Review</button>
Â  Â  Â  Â  Â  <button onclick="updateStatus('done')" class="col-span-2 p-3 rounded-xl bg-emerald-600 text-white text-xs font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">âœ… Mark Done</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="clientControls" class="hidden grid grid-cols-2 gap-2 pt-2">
Â  Â  Â  Â  Â  <button onclick="updateStatus('done')" class="col-span-2 p-3 rounded-xl bg-emerald-600 text-white text-sm font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition">Approve & Close âœ…</button>
Â  Â  Â  Â  Â  <button onclick="updateStatus('clarify')" class="col-span-2 p-3 rounded-xl border border-rose-200 text-rose-600 bg-rose-50 text-sm font-bold hover:bg-rose-100 transition">Request Changes</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button id="saveTaskBtn" class="w-full py-3 rounded-xl bg-white border border-indigo-100 text-indigo-600 text-sm font-bold hover:bg-indigo-50 transition mt-2 shadow-sm">Save Edits</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="w-full lg:w-2/3 flex flex-col bg-white">
Â  Â  Â  <div class="p-4 border-b border-slate-100 bg-slate-50/30 flex items-center gap-2">
Â  Â  Â  Â  <span class="text-lg">ğŸ’¬</span>
Â  Â  Â  Â  <h4 class="font-bold text-sm text-slate-700">Discussion Log</h4>
Â  Â  Â  </div>
Â  Â  Â  <div id="thread" class="flex-1 overflow-y-auto p-5 space-y-4 bg-white custom-scrollbar"></div>
Â  Â  Â  <div class="p-4 border-t border-slate-100 bg-slate-50">
Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  <input id="msgInput" class="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition shadow-sm" placeholder="Write a comment..." />
Â  Â  Â  Â  Â  <button id="sendMsgBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 rounded-xl font-bold transition shadow-md shadow-indigo-200 active:scale-95">Send</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<script>
/* =================================================================
Â  Â âš¡ï¸ CONFIGURATION
Â  Â ================================================================= */
const EMAIL_WEBHOOK_URL = "https://jalil3-sherani.app.n8n.cloud/webhook/task-notification";Â 

const EXPERT_EMAILS = {
Â  Â  "kalam": "kalamshar786@gmail.com",
Â  Â  "yashfa": "missperfect.mine@gmail.com"
};

/* =========================
Â  Â FIREBASE INIT
========================= */
const firebaseConfig = {
Â  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
Â  authDomain: "romatech-system.firebaseapp.com",
Â  projectId: "romatech-system",
Â  storageBucket: "romatech-system.firebasestorage.app",
Â  messagingSenderId: "368102739583",
Â  appId: "1:368102739583:web:92baa7b3abf14e7653b94a",
Â  measurementId: "G-7CWF4D2V3T"
};
if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* =========================
Â  Â HELPERS & UTILS
========================= */
const $ = (id) => document.getElementById(id);
const clean = (s) => (s || "").trim();
const nowISO = () => new Date().toISOString();
const escapeHtml = (str) => (str ?? "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");

function linkify(text) {
Â  const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
Â  return escapeHtml(text).replace(urlRegex, (url) => {
Â  Â  return `<a href="${url}" target="_blank" class="text-indigo-600 font-semibold hover:underline break-all relative z-10" onclick="event.stopPropagation()">${url}</a>`;
Â  });
}

function showToast(msg) {
Â  const t = $("toast");
Â  $("toastText").textContent = msg;
Â  t.classList.remove("hidden");
Â  clearTimeout(window.toastTimer);
Â  window.toastTimer = setTimeout(() => t.classList.add("hidden"), 2500);
}

async function notifyWebhook(actionType, taskTitle, details, targetUser, attachmentUrl) {
Â  Â  if(!EMAIL_WEBHOOK_URL) return;

Â  Â  const recipient = EXPERT_EMAILS[targetUser] || "kalamshar786@gmail.com";
Â  Â  const bodyText = `Action by: ${USER} (${ROLE})\n\n${details}\n\n${attachmentUrl ? "ğŸ“ File: " + attachmentUrl : ""}`;

Â  Â  try {
Â  Â  Â  Â  await fetch(EMAIL_WEBHOOK_URL, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  recipient: recipient,
Â  Â  Â  Â  Â  Â  Â  Â  subject: `[Tracker] ${actionType}: ${taskTitle}`,
Â  Â  Â  Â  Â  Â  Â  Â  message: bodyText,
Â  Â  Â  Â  Â  Â  Â  Â  sentAt: new Date().toLocaleString()
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log(`ğŸ“§ Email triggered to: ${recipient}`);
Â  Â  } catch(e) { console.error(e); }
}

// Global State
let WS = null, USER = null, ROLE = null, UID = null;
let subaccounts = [], tasks = [], notifications = [];
let currentTaskId = null;

const COLUMNS = [
Â  { id: "requested", label: "Requested", color: "bg-sky-500", light: "bg-sky-50" },
Â  { id: "clarify", label: "Clarification", color: "bg-amber-500", light: "bg-amber-50" },
Â  { id: "progress", label: "In Progress", color: "bg-indigo-500", light: "bg-indigo-50" },
Â  { id: "review", label: "Client Review", color: "bg-fuchsia-500", light: "bg-fuchsia-50" },
Â  { id: "done", label: "Done", color: "bg-emerald-500", light: "bg-emerald-50" }
];

const isBuilder = () => ROLE === "builder";
const isExpert = () => ROLE === "ghl_expert";
const isClient = () => ROLE === "client";
const canCreate = () => isClient() || isBuilder();
const canAddSub = () => true;

/* =========================
Â  Â AUTH
========================= */
async function authenticate(isRegister) {
Â  const ws = clean($("wsInput").value);
Â  const username = clean($("usernameInput").value).toLowerCase();
Â  const password = $("passwordInput").value;
Â  const role = $("roleInput").value;

Â  if (!ws || !username || !password) return alert("All fields required");
Â  const email = `${username}@${ws}.local`;
Â Â 
Â  try {
Â  Â  let userCred;
Â  Â  if (isRegister) {
Â  Â  Â  userCred = await auth.createUserWithEmailAndPassword(email, password);
Â  Â  Â  await db.collection("workspaces").doc(ws).collection("users").doc(userCred.user.uid).set({
Â  Â  Â  Â  username, role, createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  }, { merge: true });
Â  Â  } else {
Â  Â  Â  userCred = await auth.signInWithEmailAndPassword(email, password);
Â  Â  }
Â  Â  await loadUserProfile(ws, username, userCred.user.uid);
Â  } catch (e) {
Â  Â  $("authMsg").textContent = e.message;
Â  Â  $("authMsg").classList.remove("hidden");
Â  }
}

async function loadUserProfile(ws, username, uid) {
Â  WS = ws; USER = username; UID = uid;
Â  const snap = await db.collection("workspaces").doc(WS).collection("users").doc(UID).get();
Â  ROLE = snap.exists ? snap.data().role : "client";

Â  $("authModal").classList.add("hidden");
Â  $("userBadge").textContent = USER;
Â  $("wsBadge").textContent = WS;
Â  $("userInitials").textContent = USER.substring(0,2).toUpperCase();

Â  $("newTaskBtn").style.display = canCreate() ? "flex" : "none";
Â  $("addSubBtn").style.display = canAddSub() ? "block" : "none";
Â Â 
Â  initRealtime();
}

$("loginBtn").onclick = () => authenticate(false);
$("registerBtn").onclick = () => authenticate(true);
$("logoutBtn").onclick = () => { auth.signOut(); location.reload(); };

/* =========================
Â  Â DATA & RENDER
========================= */
function initRealtime() {
Â  const root = db.collection("workspaces").doc(WS);
Â Â 
Â  // SUBS
Â  root.collection("subaccounts").orderBy("createdAt", "desc").onSnapshot(snap => {
Â  Â  subaccounts = snap.docs.map(d => ({id: d.id, ...d.data()}));
Â  Â  renderSubs(); renderBoard(); updateDropdowns();
Â  });

Â  // TASKS
Â  root.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
Â  Â  tasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
Â  Â  renderBoard();
Â  Â  renderSubs();Â 
Â  Â  if (currentTaskId) {
Â  Â  Â  const t = tasks.find(x => x.id === currentTaskId);
Â  Â  Â  if (t) renderDetails(t);
Â  Â  Â  else {
Â  Â  Â  Â  Â  $("detailsModal").classList.add("hidden");
Â  Â  Â  Â  Â  currentTaskId = null;
Â  Â  Â  }
Â  Â  }
Â  });

Â  // NOTIFS
Â  root.collection("notifications").where("toUsername", "==", USER).orderBy("createdAt", "desc").limit(20).onSnapshot(snap => {
Â  Â  notifications = snap.docs.map(d => ({id: d.id, ...d.data()}));
Â  Â  renderNotifs();
Â  });
}

function updateDropdowns() {
Â  const opts = subaccounts.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
Â  $("filterSubaccount").innerHTML = `<option value="">All Subs</option>` + opts;
Â  $("tSub").innerHTML = opts;
Â  $("dSub").innerHTML = opts;
Â  $("dStatus").innerHTML = COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join("");
}

function renderSubs() {
Â  const list = $("subList");
Â  list.innerHTML = "";
Â Â 
Â  if (subaccounts.length === 0) {Â 
Â  Â  list.innerHTML = `<div class="text-xs text-slate-400 p-4 text-center italic border-2 border-dashed border-slate-200 rounded-xl m-2">No subaccounts yet.</div>`;Â 
Â  Â  return;Â 
Â  }

Â  const currentFilter = $("filterSubaccount").value;

Â  subaccounts.forEach(s => {
Â  Â  Â const open = tasks.filter(t => t.subaccountId === s.id && t.status !== 'done').length;
Â  Â  Â const isActive = currentFilter === s.id;

Â  Â  Â const btn = document.createElement("button");
Â  Â  Â btn.className = `sub-item w-full text-left px-4 py-3.5 rounded-2xl text-sm font-medium flex justify-between items-center transition-all duration-300 group ${isActive ? 'active' : 'text-slate-600 bg-white/50 border border-white/50 hover:bg-white hover:shadow-md'}`;
Â  Â  Â 
Â  Â  Â btn.innerHTML = `
Â  Â  Â  Â  <span class="truncate mr-2 font-semibold tracking-tight ${isActive ? 'text-white' : 'group-hover:text-indigo-600'}">${escapeHtml(s.name)}</span>Â 
Â  Â  Â  Â  ${open > 0Â 
Â  Â  Â  Â  Â  Â ? `<span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold shadow-sm ${isActive ? 'bg-white text-indigo-600' : 'bg-indigo-600 text-white'}">${open}</span>`Â 
Â  Â  Â  Â  Â  Â : `<span class="h-5 w-5 rounded-full flex items-center justify-center ${isActive ? 'bg-indigo-500/30' : 'bg-slate-100'}"><svg class="w-3 h-3 ${isActive ? 'text-white' : 'text-slate-300'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></span>`
Â  Â  Â  Â  }
Â  Â  Â `;
Â  Â  Â 
Â  Â  Â btn.onclick = () => {Â 
Â  Â  Â  Â  Â $("filterSubaccount").value = s.id;Â 
Â  Â  Â  Â  Â renderBoard();Â 
Â  Â  Â  Â  Â renderSubs();
Â  Â  Â };
Â  Â  Â list.appendChild(btn);
Â  });
}

function renderBoard() {
Â  const board = $("board");
Â  board.innerHTML = "";
Â  const filterSub = $("filterSubaccount").value;
Â  const search = $("searchInput").value.toLowerCase();
Â Â 
Â  const filtered = tasks.filter(t => {
Â  Â  if (filterSub && t.subaccountId !== filterSub) return false;
Â  Â  if (search && !t.title.toLowerCase().includes(search)) return false;
Â  Â  return true;
Â  });

Â  COLUMNS.forEach(col => {
Â  Â  const colTasks = filtered.filter(t => (t.status || 'requested') === col.id);
Â  Â Â 
Â  Â  const colDiv = document.createElement("div");
Â  Â  colDiv.className = "w-80 shrink-0 flex flex-col h-full rounded-[1.5rem] bg-white/40 border border-white/60 shadow-inner overflow-hidden backdrop-blur-sm";
Â  Â Â 
Â  Â  colDiv.innerHTML = `
Â  Â  Â  <div class="p-4 flex items-center justify-between shrink-0 border-b border-white/40">
Â  Â  Â  Â  Â <div class="flex items-center gap-2.5">
Â  Â  Â  Â  Â  Â  <div class="h-3 w-3 rounded-full ${col.color} shadow-sm ring-2 ring-white"></div>
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-xs text-slate-700 uppercase tracking-widest">${col.label}</h3>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <span class="text-[10px] font-bold text-slate-500 bg-white/80 px-2.5 py-1 rounded-full shadow-sm ring-1 ring-slate-100">${colTasks.length}</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="flex-1 overflow-y-auto px-3 pb-3 space-y-3 pt-3 scroll-smooth custom-scrollbar" id="col_${col.id}" data-status="${col.id}">
Â  Â  Â  </div>
Â  Â  `;
Â  Â Â 
Â  Â  const zone = colDiv.querySelector(`#col_${col.id}`);
Â  Â Â 
Â  Â  colTasks.forEach(t => {
Â  Â  Â  Â const subName = subaccounts.find(s => s.id === t.subaccountId)?.name || "â€”";
Â  Â  Â  Â const card = document.createElement("div");
Â  Â  Â  Â card.className = "glass-card p-4 rounded-2xl cursor-pointer relative group";
Â  Â  Â  Â card.setAttribute("data-id", t.id);
Â  Â  Â  Â 
Â  Â  Â  Â card.innerHTML = `
Â  Â  Â  Â  Â <div class="flex justify-between items-start mb-2.5">
Â  Â  Â  Â  Â  Â  <span class="text-[9px] font-bold text-indigo-600 bg-indigo-50/80 px-2 py-1 rounded-lg border border-indigo-100 truncate max-w-[140px] uppercase tracking-wide backdrop-blur-sm">${escapeHtml(subName)}</span>
Â  Â  Â  Â  Â  Â  <div class="h-6 w-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500 border border-white shadow-sm ring-1 ring-slate-100" title="Assignee">
Â  Â  Â  Â  Â  Â  Â  Â  ${t.assigneeUsername ? t.assigneeUsername.charAt(0).toUpperCase() : '?'}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <h4 class="font-bold text-sm text-slate-800 leading-snug mb-3 pr-2 group-hover:text-indigo-600 transition-colors">${escapeHtml(t.title)}</h4>
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â <div class="flex items-center justify-between pt-3 border-t border-slate-100/50">
Â  Â  Â  Â  Â  Â  Â <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  ${t.attachmentUrl ? `<span class="text-xs bg-slate-100 p-1 rounded-md" title="Has attachment">ğŸ“</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[10px] text-slate-400 font-medium">${new Date(t.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â <div class="flex items-center gap-1.5 text-slate-400 group-hover:text-indigo-500 transition-colors bg-slate-50 px-2 py-0.5 rounded-full">
Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[10px] font-bold">${(t.messages||[]).length}</span>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â `;
Â  Â  Â  Â card.addEventListener('click', () => openDetails(t.id));
Â  Â  Â  Â zone.appendChild(card);
Â  Â  });
Â  Â Â 
Â  Â  board.appendChild(colDiv);

Â  Â  new Sortable(zone, {
Â  Â  Â  Â  group: 'shared', animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true,
Â  Â  Â  Â  onEnd: function (evt) {
Â  Â  Â  Â  Â  Â  const taskId = evt.item.getAttribute('data-id');
Â  Â  Â  Â  Â  Â  const newStatus = evt.to.getAttribute('data-status');
Â  Â  Â  Â  Â  Â  if (newStatus !== evt.from.getAttribute('data-status')) {
Â  Â  Â  Â  Â  Â  Â  Â  const t = tasks.find(x => x.id === taskId);
Â  Â  Â  Â  Â  Â  Â  Â  db.collection("workspaces").doc(WS).collection("tasks").doc(taskId).update({status: newStatus});
Â  Â  Â  Â  Â  Â  Â  Â  const target = t.assigneeUsername || "kalam";
Â  Â  Â  Â  Â  Â  Â  Â  notifyWebhook("Status Change", t?.title || "Task", `Moved to ${newStatus}`, target, t.attachmentUrl);
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Moved to ${newStatus}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
Â  });
}

function renderNotifs() {
Â  const list = $("notifList");
Â  list.innerHTML = "";
Â  const unread = notifications.filter(n => !n.read).length;
Â  const badge = $("notifCount");
Â Â 
Â  if (unread > 0) {
Â  Â  Â  badge.textContent = "";Â 
Â  Â  Â  badge.classList.remove("hidden");
Â  Â  Â  badge.classList.add("animate-pulse");
Â  } else {
Â  Â  Â  badge.classList.add("hidden");
Â  }

Â  if(notifications.length === 0) {Â 
Â  Â  Â  list.innerHTML = `<div class="p-6 text-center text-xs text-slate-400 italic">No notifications yet.</div>`;Â 
Â  Â  Â  return;Â 
Â  }

Â  notifications.forEach(n => {
Â  Â  Â const div = document.createElement("div");
Â  Â  Â div.className = `p-3 border-b border-slate-50 text-xs cursor-pointer transition-colors hover:bg-slate-50 ${n.read ? 'opacity-60 bg-white' : 'bg-indigo-50/30'}`;
Â  Â  Â div.innerHTML = `
Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  <div class="mt-0.5 h-2 w-2 rounded-full ${n.read ? 'bg-transparent' : 'bg-indigo-500'} shrink-0"></div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold ${n.read?'text-slate-700':'text-indigo-700'}">${escapeHtml(n.title)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-500 truncate mt-0.5">${escapeHtml(n.body)}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  Â div.onclick = async () => { await db.collection("workspaces").doc(WS).collection("notifications").doc(n.id).update({read:true}); if(n.taskId) openDetails(n.taskId); };
Â  Â  Â list.appendChild(div);
Â  });
}

/* =========================
Â  Â ACTIONS
========================= */
$("addSubBtn").onclick = () => { $("subModal").classList.remove("hidden"); $("subModal").classList.add("flex"); };
$("closeSubModalBtn").onclick = () => $("subModal").classList.add("hidden");
$("saveSubBtn").onclick = async () => {
Â  Â const name = clean($("subNameInput").value);
Â  Â if(!name) return;
Â  Â await db.collection("workspaces").doc(WS).collection("subaccounts").add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
Â  Â $("subModal").classList.add("hidden");
Â  Â showToast("Subaccount added");
};

$("newTaskBtn").onclick = () => {Â 
Â  Â  if(!isClient() && !isBuilder()) return alert("Only Clients can request.");
Â  Â  $("taskModal").classList.remove("hidden"); $("taskModal").classList.add("flex");Â 
};
$("closeTaskModal").onclick = () => $("taskModal").classList.add("hidden");
$("cancelTaskBtn").onclick = () => $("taskModal").classList.add("hidden");

// ğŸŸ¢ UPLOAD + CREATE TASK
$("createTaskBtn").onclick = async () => {
Â  Â  const title = clean($("tTitle").value);
Â  Â  const subId = $("tSub").value;
Â  Â  const assignee = clean($("tAssignee").value);
Â  Â  const details = clean($("tDetails").value);
Â  Â  const file = $("tFile").files[0];
Â  Â  let attachmentUrl = "";

Â  Â  if(!title || !subId || !assignee) return alert("Title, Subaccount, and Assignee are required.");

Â  Â  // Disable button to prevent double-clicks
Â  Â  const btn = $("createTaskBtn");
Â  Â  btn.disabled = true;
Â  Â  btn.textContent = "Processing...";

Â  Â  if (file) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const ref = storage.ref(`workspaces/${WS}/files/${Date.now()}_${file.name}`);
Â  Â  Â  Â  Â  Â  await ref.put(file);
Â  Â  Â  Â  Â  Â  attachmentUrl = await ref.getDownloadURL();
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error("Upload failed", e);
Â  Â  Â  Â  Â  Â  alert("File upload failed. Task created without file.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const ref = await db.collection("workspaces").doc(WS).collection("tasks").add({
Â  Â  Â  Â  title, details, subaccountId: subId, assigneeUsername: assignee, attachmentUrl,
Â  Â  Â  Â  status: 'requested', createdBy: USER, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  messages: [{by: USER, role: ROLE, text: "Request created.", at: nowISO()}]
Â  Â  });

Â  Â  await db.collection("workspaces").doc(WS).collection("notifications").add({
Â  Â  Â  Â  toUsername: assignee, title: "New Task", body: title, taskId: ref.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  });

Â  Â  notifyWebhook("New Task", title, details, assignee, attachmentUrl);
Â  Â Â 
Â  Â  $("taskModal").classList.add("hidden");
Â  Â  $("tTitle").value = ""; $("tDetails").value = ""; $("tFile").value = "";
Â  Â  btn.disabled = false;
Â  Â  btn.textContent = "Create & Notify";
Â  Â  showToast("Task Created");
};

function openDetails(id) {
Â  Â  currentTaskId = id;
Â  Â  const t = tasks.find(x => x.id === id);
Â  Â  if(!t) return;
Â  Â  $("detailsModal").classList.remove("hidden"); $("detailsModal").classList.add("flex");
Â  Â  $("dTitle").textContent = t.title;
Â  Â  $("dMeta").textContent = `@${t.assigneeUsername} â€¢ Created by ${t.createdBy || '?'}`;
Â  Â  $("dStatus").value = t.status;
Â  Â  $("dSub").value = t.subaccountId;
Â  Â  $("dDetails").value = t.details || "";
Â  Â  if(t.attachmentUrl) { $("dAttachLink").href = t.attachmentUrl; $("dAttachLink").classList.remove("hidden"); $("dAttachLink").classList.add("inline-flex"); } else { $("dAttachLink").classList.add("hidden"); }
Â  Â Â 
Â  Â  if(isClient() && t.status === 'review') { $("clientControls").classList.remove("hidden"); $("expertControls").classList.add("hidden"); }Â 
Â  Â  else { $("clientControls").classList.add("hidden"); $("expertControls").classList.remove("hidden"); }
Â  Â  renderThread(t);
}

$("closeDetailsModal").onclick = () => { $("detailsModal").classList.add("hidden"); currentTaskId = null; };

// ğŸ”´ DELETE ACTION
$("btnDeleteTask").onclick = async () => {
Â  Â  if(!currentTaskId) return;
Â  Â  if(confirm("Are you sure you want to delete this task permanently?")) {
Â  Â  Â  Â  const t = tasks.find(x => x.id === currentTaskId);
Â  Â  Â  Â  notifyWebhook("Task Deleted", t?.title || "Deleted Task", "Task was permanently deleted.", t?.assigneeUsername, "");
Â  Â  Â  Â Â 
Â  Â  Â  Â  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).delete();
Â  Â  Â  Â  showToast("Task Deleted");
Â  Â  Â  Â  $("detailsModal").classList.add("hidden");
Â  Â  Â  Â  currentTaskId = null;
Â  Â  }
};

function renderThread(t) {
Â  Â  const div = $("thread"); div.innerHTML = "";
Â  Â  if(t.details) {
Â  Â  Â  Â  const d = document.createElement("div"); d.className = "p-4 rounded-2xl bg-slate-50/80 border border-slate-100 mb-6";
Â  Â  Â  Â  d.innerHTML = `<div class="text-[10px] font-bold uppercase text-slate-400 mb-2">Original Request</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${linkify(t.details)}</div>`;
Â  Â  Â  Â  div.appendChild(d);
Â  Â  }
Â  Â  (t.messages||[]).forEach(m => {
Â  Â  Â  Â  const isMe = m.by === USER;
Â  Â  Â  Â  const msg = document.createElement("div");
Â  Â  Â  Â  msg.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-3`;
Â  Â  Â  Â  msg.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="max-w-[85%] px-4 py-3 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-100 rounded-tl-none text-slate-700'}">
Â  Â  Â  Â  Â  Â  Â  Â ${linkify(m.text)}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="text-[10px] text-slate-400 mt-1 px-1 font-medium">${m.by}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  div.appendChild(msg);
Â  Â  });
Â  Â  div.scrollTop = div.scrollHeight;
}

$("sendMsgBtn").onclick = async () => {
Â  Â  const txt = clean($("msgInput").value);
Â  Â  if(!txt || !currentTaskId) return;
Â  Â  const t = tasks.find(x => x.id === currentTaskId);
Â  Â  const msgs = [...(t.messages||[]), {by: USER, role: ROLE, text: txt, at: nowISO()}];
Â  Â  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({messages: msgs});
Â  Â  $("msgInput").value = "";
Â  Â Â 
Â  Â  // Notify target
Â  Â  const target = t.assigneeUsername || "kalam";
Â  Â  notifyWebhook("New Comment", t.title, `${USER}: ${txt}`, target, "");

Â  Â  if(t.assigneeUsername !== USER) {
Â  Â  Â  Â  await db.collection("workspaces").doc(WS).collection("notifications").add({
Â  Â  Â  Â  Â  Â toUsername: t.assigneeUsername, title: "New Comment", body: `${USER} commented on ${t.title}`, taskId: t.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  });
Â  Â  }
};

async function updateStatus(st) {
Â  Â  if(!currentTaskId) return;
Â  Â  const t = tasks.find(x => x.id === currentTaskId);
Â  Â  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({status: st});
Â  Â Â 
Â  Â  const target = t.assigneeUsername || "kalam";
Â  Â  notifyWebhook("Status Change", t.title, `Moved to ${st}`, target, "");
Â  Â Â 
Â  Â  showToast("Status Updated");
Â  Â  if(st === 'done') $("detailsModal").classList.add("hidden");
}

$("saveTaskBtn").onclick = async () => {
Â  Â  if(!currentTaskId) return;
Â  Â  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({
Â  Â  Â  Â  details: clean($("dDetails").value), subaccountId: $("dSub").value, status: $("dStatus").value
Â  Â  });
Â  Â  showToast("Changes Saved");
};

$("markAllReadBtn").onclick = async () => {
Â  Â  const batch = db.batch();
Â  Â  notifications.filter(n=>!n.read).forEach(n => batch.update(db.collection("workspaces").doc(WS).collection("notifications").doc(n.id), {read:true}));
Â  Â  await batch.commit();
}

$("searchInput").addEventListener("input", renderBoard);
$("filterSubaccount").addEventListener("change", renderBoard);
$("notifBtn").onclick = () => $("notifPanel").classList.toggle("hidden");

auth.onAuthStateChanged(u => {
Â  Â  if(!u) $("authModal").classList.remove("hidden");
Â  Â  else if(localStorage.getItem('sct_session_v1')) { /* restore logic */ }
});
</script>
</body>
</html>
