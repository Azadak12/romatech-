<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subaccount Change Tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Compat ‚Äì stable + simple) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(100,116,139,.35); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* subtle fade/scale */
    .fade-in { animation: fadeIn .18s ease-out both; }
    @keyframes fadeIn { from {opacity:.0; transform: translateY(6px) scale(.99);} to {opacity:1; transform:none;} }

    /* modal backdrop click shield */
    .modal-backdrop { backdrop-filter: blur(6px); }

    /* toast animation */
    .toast-in { animation: toastIn .18s ease-out both; }
    @keyframes toastIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform:none;} }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 10px 25px rgba(15, 23, 42, .08)",
            lift: "0 14px 35px rgba(15, 23, 42, .14)"
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- ===================== TOAST ===================== -->
<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] hidden">
  <div class="toast-in rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm shadow-soft flex items-center gap-2">
    <span id="toastText">Saved</span>
  </div>
</div>

<!-- ===================== AUTH MODAL ===================== -->
<div id="authModal" class="fixed inset-0 z-50 bg-black/40 modal-backdrop flex items-center justify-center p-4">
  <div class="fade-in w-full max-w-xl rounded-2xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-5 border-b border-slate-200">
      <div class="flex items-center gap-3">
        <div class="h-11 w-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
        <div>
          <h2 class="text-lg font-semibold leading-tight">Workspace Task Tracker</h2>
          <p class="text-sm text-slate-500">Login + Workspace + Role (Builder / GHL Expert / Client)</p>
        </div>
      </div>
    </div>

    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Workspace ID</label>
        <input id="wsInput"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., branham-board" />
        <p class="text-xs text-slate-500 mt-1">Same Workspace ID = shared board for you + client.</p>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Username (no spaces)</label>
        <input id="usernameInput"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul, branham, martyna" />
        <p class="text-xs text-slate-500 mt-1">Auto email: username@workspace.local</p>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Password</label>
        <input id="passwordInput" type="password"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="min 6 chars" />
      </div>

      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Role</label>
        <select id="roleInput"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
          <option value="builder">Builder / Admin</option>
          <option value="ghl_expert">GHL Expert</option>
          <option value="client">Client</option>
        </select>
        <p class="text-xs text-slate-500 mt-1">Builder can create tasks + subaccounts. Client can approve in ‚ÄúClient Review‚Äù.</p>
      </div>

      <div class="md:col-span-2 flex flex-col md:flex-row gap-2">
        <button id="loginBtn"
          class="flex-1 rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-800 active:scale-[.99] transition">
          Login
        </button>
        <button id="registerBtn"
          class="flex-1 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
          Register
        </button>
      </div>

      <div class="md:col-span-2">
        <div id="authMsg" class="text-sm text-rose-600"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== HEADER ===================== -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
      <div>
        <h1 class="text-lg font-semibold leading-tight">Subaccount Change Tracker</h1>
        <p class="text-sm text-slate-500">Requested ‚Üí Clarification ‚Üí In Progress ‚Üí Client Review ‚Üí Done</p>
      </div>
    </div>

    <div class="flex flex-col md:flex-row gap-2 md:items-center">
      <div class="relative">
        <input id="searchInput" type="text" placeholder="Search tasks..."
          class="w-full md:w-72 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
        <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">‚åòK</div>
      </div>

      <select id="filterSubaccount"
        class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
        <option value="">All Subaccounts</option>
      </select>

      <button id="newTaskBtn"
        class="rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-soft hover:bg-indigo-700 active:scale-[.99] transition">
        + New Task
      </button>

      <!-- Notifications -->
      <div class="relative">
        <button id="notifBtn"
          class="rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition flex items-center gap-2">
          üîî <span id="notifCount" class="hidden text-xs font-bold px-2 py-0.5 rounded-full bg-rose-600 text-white">0</span>
        </button>

        <div id="notifPanel" class="hidden absolute right-0 mt-2 w-[360px] max-w-[90vw] rounded-2xl bg-white border border-slate-200 shadow-lift overflow-hidden">
          <div class="p-3 border-b border-slate-200 flex items-center justify-between">
            <div class="font-semibold">Notifications</div>
            <button id="markAllReadBtn" class="text-xs font-semibold px-2 py-1 rounded-xl border border-slate-200 hover:bg-slate-50">
              Mark all read
            </button>
          </div>
          <div id="notifList" class="max-h-[360px] overflow-auto bg-slate-50 p-2 space-y-2"></div>
          <div class="p-2 border-t border-slate-200 bg-white text-xs text-slate-500">
            In-app notifications (reliable). Push notifications need FCM later.
          </div>
        </div>
      </div>

      <button id="logoutBtn"
        class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
        Logout
      </button>

      <div class="text-sm text-slate-600 md:ml-2 whitespace-nowrap">
        <span id="userBadge" class="font-semibold"></span>
        <span id="wsBadge" class="text-slate-400"></span>
      </div>
    </div>
  </div>
</header>

<!-- ===================== MAIN ===================== -->
<main class="max-w-7xl mx-auto px-4 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">

    <!-- SIDEBAR -->
    <aside class="lg:col-span-3">
      <div class="bg-white rounded-2xl border border-slate-200 shadow-soft overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Subaccounts</h2>
            <p class="text-sm text-slate-500">Shared across workspace</p>
          </div>
          <button id="addSubBtn"
            class="rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
            + Add
          </button>
        </div>

        <div id="subList" class="p-3 space-y-2"></div>

        <div class="p-4 border-t border-slate-200">
          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-3 text-sm text-slate-600">
            Tip: Client can approve only when a task is in <b>Client Review</b>.
          </div>
        </div>
      </div>
    </aside>

    <!-- BOARD -->
    <section class="lg:col-span-9">
      <div id="board" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4"></div>
    </section>

  </div>
</main>

<!-- ===================== ADD SUBACCOUNT MODAL ===================== -->
<div id="subModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 modal-backdrop p-4">
  <div class="fade-in w-full max-w-lg rounded-2xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">Add Subaccount</h3>
        <p class="text-sm text-slate-500">Example: VIP Tires - Ohio</p>
      </div>
      <button id="closeSubModalBtn" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
    </div>

    <div class="p-4">
      <label class="text-xs font-semibold text-slate-600">Subaccount name</label>
      <input id="subNameInput"
        class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
        placeholder="Type subaccount name..." />

      <div id="subErr" class="mt-2 text-sm text-rose-600 hidden"></div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="cancelSubBtn"
          class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
          Cancel
        </button>
        <button id="saveSubBtn"
          class="rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== NEW TASK MODAL ===================== -->
<div id="taskModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 modal-backdrop p-4">
  <div class="fade-in w-full max-w-2xl rounded-2xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">New Task</h3>
        <p class="text-sm text-slate-500">Log a client change request</p>
      </div>
      <button id="closeTaskModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
    </div>

    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Title</label>
        <input id="tTitle"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., Remove promo messages after appointment booked" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Subaccount</label>
        <select id="tSub"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Assignee (username)</label>
        <input id="tAssignee"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul" />
        <p class="text-xs text-slate-500 mt-1">This triggers notification for that username.</p>
      </div>

      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Details (paste exact message)</label>
        <textarea id="tDetails" rows="4"
          class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="Paste the client message + what to change..."></textarea>
      </div>

      <div id="taskErr" class="md:col-span-2 text-sm text-rose-600 hidden"></div>

      <div class="md:col-span-2 flex items-center justify-end gap-2">
        <button id="cancelTaskBtn"
          class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
          Cancel
        </button>
        <button id="createTaskBtn"
          class="rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">
          Create
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== DETAILS MODAL (CLEAN) ===================== -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 modal-backdrop p-4">
  <div class="fade-in w-full max-w-5xl rounded-2xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex items-start justify-between gap-3">
      <div class="min-w-0">
        <h3 id="dTitle" class="font-semibold text-lg truncate">Task</h3>
        <p id="dMeta" class="text-sm text-slate-500 truncate">‚Äî</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="closeDetailsModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-0">
      <!-- LEFT PANEL -->
      <div class="lg:col-span-4 border-b lg:border-b-0 lg:border-r border-slate-200 p-4">
        <div class="space-y-3">
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="grid grid-cols-2 gap-2">
              <div class="col-span-2">
                <div class="text-xs font-semibold text-slate-500">Status</div>
                <select id="dStatus"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>
              </div>

              <div class="col-span-2">
                <div class="text-xs font-semibold text-slate-500">Subaccount</div>
                <select id="dSub"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>
              </div>

              <div class="col-span-2">
                <div class="text-xs font-semibold text-slate-500">Assignee (username)</div>
                <input id="dAssignee"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
              </div>
            </div>

            <div class="mt-3 flex flex-col gap-2">
              <div id="builderControls" class="flex flex-col gap-2">
                <button id="btnClarify" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">
                  Need Clarification
                </button>
                <button id="btnProgress" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">
                  Move to In Progress
                </button>
                <button id="btnReview" class="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800 transition">
                  Send for Review
                </button>
                <button id="btnDone" class="rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition">
                  Mark Done
                </button>
              </div>

              <div id="clientControls" class="hidden flex flex-col gap-2">
                <button id="btnApprove" class="rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition">
                  Approve Done ‚úÖ
                </button>
                <button id="btnChanges" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">
                  Request Changes
                </button>
              </div>

              <button id="saveTaskBtn" class="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm font-semibold hover:bg-indigo-700 transition">
                Save Changes
              </button>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-500">Client Request / Details</div>
            <textarea id="dDetails" rows="7"
              class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></textarea>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="lg:col-span-8 p-4">
        <div class="rounded-2xl border border-slate-200 overflow-hidden">
          <div class="p-3 border-b border-slate-200 flex items-center justify-between">
            <div>
              <div class="font-semibold">Conversation</div>
              <div class="text-sm text-slate-500">Questions, replies, notes (clean thread)</div>
            </div>
          </div>

          <div id="thread" class="p-3 space-y-2 max-h-[520px] overflow-auto bg-slate-50"></div>

          <div class="p-3 border-t border-slate-200 bg-white">
            <div class="flex gap-2">
              <input id="msgInput"
                class="flex-1 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
                placeholder="Write an update..." />
              <button id="sendMsgBtn"
                class="rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 transition">
                Send
              </button>
            </div>
            <div class="mt-2 text-xs text-slate-500">Press Enter to send.</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a",
  measurementId: "G-7CWF4D2V3T"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   DOM
========================= */
const $ = (id) => document.getElementById(id);

const toast = $("toast");
const toastText = $("toastText");
function showToast(msg){
  toastText.textContent = msg || "Done";
  toast.classList.remove("hidden");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.add("hidden"), 1600);
}

const authModal = $("authModal");
const wsInput = $("wsInput");
const usernameInput = $("usernameInput");
const passwordInput = $("passwordInput");
const roleInput = $("roleInput");
const loginBtn = $("loginBtn");
const registerBtn = $("registerBtn");
const authMsg = $("authMsg");

const userBadge = $("userBadge");
const wsBadge = $("wsBadge");
const logoutBtn = $("logoutBtn");

const searchInput = $("searchInput");
const filterSubaccount = $("filterSubaccount");
const newTaskBtn = $("newTaskBtn");
const addSubBtn = $("addSubBtn");

const subList = $("subList");
const board = $("board");

const subModal = $("subModal");
const subNameInput = $("subNameInput");
const closeSubModalBtn = $("closeSubModalBtn");
const cancelSubBtn = $("cancelSubBtn");
const saveSubBtn = $("saveSubBtn");
const subErr = $("subErr");

const taskModal = $("taskModal");
const closeTaskModal = $("closeTaskModal");
const cancelTaskBtn = $("cancelTaskBtn");
const createTaskBtn = $("createTaskBtn");
const tTitle = $("tTitle");
const tSub = $("tSub");
const tAssignee = $("tAssignee");
const tDetails = $("tDetails");
const taskErr = $("taskErr");

const detailsModal = $("detailsModal");
const closeDetailsModal = $("closeDetailsModal");
const dTitle = $("dTitle");
const dMeta = $("dMeta");
const dStatus = $("dStatus");
const dSub = $("dSub");
const dAssignee = $("dAssignee");
const dDetails = $("dDetails");
const saveTaskBtn = $("saveTaskBtn");

const builderControls = $("builderControls");
const clientControls = $("clientControls");
const btnClarify = $("btnClarify");
const btnProgress = $("btnProgress");
const btnReview = $("btnReview");
const btnDone = $("btnDone");
const btnApprove = $("btnApprove");
const btnChanges = $("btnChanges");

const thread = $("thread");
const msgInput = $("msgInput");
const sendMsgBtn = $("sendMsgBtn");

const notifBtn = $("notifBtn");
const notifPanel = $("notifPanel");
const notifList = $("notifList");
const notifCount = $("notifCount");
const markAllReadBtn = $("markAllReadBtn");

/* =========================
   STATE
========================= */
let WS = null;
let USER = null;
let ROLE = null;
let UID = null;

let subaccounts = [];
let tasks = [];
let currentTaskId = null;
let notifications = [];

const STATUS = [
  { id:"requested", label:"Requested" },
  { id:"clarify", label:"Clarification" },
  { id:"progress", label:"In Progress" },
  { id:"review", label:"Client Review" },
  { id:"done", label:"Done" }
];

function isBuilder(){ return ROLE === "builder"; }
function isExpert(){ return ROLE === "ghl_expert"; }
function isClient(){ return ROLE === "client"; }
function canCreate(){ return isBuilder(); }
function canMove(){ return isBuilder() || isExpert(); } // you can tighten later
function canApprove(){ return isClient(); }

function clean(str){ return (str||"").trim(); }
function escapeHtml(str){
  return (str??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   FIRESTORE REFS
========================= */
function wsDoc(){ return db.collection("workspaces").doc(WS); }
function usersRef(){ return wsDoc().collection("users"); }
function subRef(){ return wsDoc().collection("subaccounts"); }
function taskRef(){ return wsDoc().collection("tasks"); }
function notifRef(){ return wsDoc().collection("notifications"); }

/* =========================
   AUTH UTIL
========================= */
function makeEmail(username, ws){
  return `${username.toLowerCase()}@${ws.toLowerCase()}.local`;
}
function setAuthError(msg){ authMsg.textContent = msg || ""; }

async function doRegister(){
  setAuthError("");
  const ws = clean(wsInput.value);
  const username = clean(usernameInput.value).replace(/\s+/g,"");
  const password = passwordInput.value;
  const role = roleInput.value;

  if(!ws || !username || !password) return setAuthError("Workspace, Username, Password required.");
  if(password.length < 6) return setAuthError("Password must be at least 6 characters.");

  const email = makeEmail(username, ws);

  try{
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    await afterAuth(ws, username, role, cred.user.uid);
  }catch(e){
    console.error(e);
    setAuthError(e.message || "Register failed");
  }
}

async function doLogin(){
  setAuthError("");
  const ws = clean(wsInput.value);
  const username = clean(usernameInput.value).replace(/\s+/g,"");
  const password = passwordInput.value;
  const role = roleInput.value;

  if(!ws || !username || !password) return setAuthError("Workspace, Username, Password required.");

  const email = makeEmail(username, ws);

  try{
    const cred = await auth.signInWithEmailAndPassword(email, password);
    await afterAuth(ws, username, role, cred.user.uid);
  }catch(e){
    console.error(e);
    setAuthError(e.message || "Login failed");
  }
}

async function afterAuth(ws, username, role, uid){
  WS = ws; USER = username; ROLE = role; UID = uid;

  await usersRef().doc(uid).set({
    username,
    role,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  authModal.classList.add("hidden");
  userBadge.textContent = `${USER} (${ROLE})`;
  wsBadge.textContent = ` ‚Ä¢ WS: ${WS}`;

  addSubBtn.style.display = isBuilder() ? "inline-flex" : "none";
  newTaskBtn.style.display = canCreate() ? "inline-flex" : "none";

  dStatus.innerHTML = STATUS.map(s=>`<option value="${s.id}">${s.label}</option>`).join("");

  bindRealtime();
  showToast("Welcome!");
}

/* =========================
   REALTIME LISTENERS
========================= */
let unsubSubs = null;
let unsubTasks = null;
let unsubNotifs = null;

function bindRealtime(){
  if(unsubSubs) unsubSubs();
  if(unsubTasks) unsubTasks();
  if(unsubNotifs) unsubNotifs();

  unsubSubs = subRef().orderBy("createdAt","desc").onSnapshot(snap=>{
    subaccounts = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderSubaccounts();
    renderDropdowns();
    renderBoard();
  });

  unsubTasks = taskRef().orderBy("createdAt","desc").onSnapshot(snap=>{
    tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderSubaccounts();
    renderBoard();

    if(currentTaskId){
      const t = tasks.find(x=>x.id===currentTaskId);
      if(t) renderDetails(t);
    }
  });

  // notifications to current username
  unsubNotifs = notifRef()
    .where("toUsername","==", USER)
    .orderBy("createdAt","desc")
    .limit(50)
    .onSnapshot(snap=>{
      notifications = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderNotifications();
    });
}

/* =========================
   UI RENDER
========================= */
function renderDropdowns(){
  // filter dropdown
  const cur = filterSubaccount.value;
  filterSubaccount.innerHTML = `<option value="">All Subaccounts</option>` + subaccounts.map(sa =>
    `<option value="${sa.id}">${escapeHtml(sa.name||"‚Äî")}</option>`
  ).join("");

  const exists = [...filterSubaccount.options].some(o=>o.value===cur);
  filterSubaccount.value = exists ? cur : "";

  // task create + details dropdowns
  tSub.innerHTML = subaccounts.map(sa=>`<option value="${sa.id}">${escapeHtml(sa.name||"‚Äî")}</option>`).join("");
  dSub.innerHTML = subaccounts.map(sa=>`<option value="${sa.id}">${escapeHtml(sa.name||"‚Äî")}</option>`).join("");
}

function renderSubaccounts(){
  subList.innerHTML = "";
  if(subaccounts.length===0){
    subList.innerHTML = `<div class="text-sm text-slate-500">No subaccounts yet.</div>`;
    return;
  }

  subaccounts.forEach(sa=>{
    const total = tasks.filter(t=>t.subaccountId===sa.id).length;
    const done = tasks.filter(t=>t.subaccountId===sa.id && t.status==="done").length;
    const open = total - done;
    const pct = total===0 ? 0 : Math.round((done/total)*100);

    const card = document.createElement("button");
    card.className = "w-full text-left rounded-2xl border border-slate-200 bg-white hover:shadow-soft hover:border-slate-300 p-3 transition active:scale-[.99]";
    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${escapeHtml(sa.name||"‚Äî")}</div>
          <div class="text-xs text-slate-500 mt-0.5">${open} open ‚Ä¢ ${total} total ‚Ä¢ ${pct}% done</div>
        </div>
        <div class="text-xs font-bold px-2 py-1 rounded-xl border bg-slate-50">${pct}%</div>
      </div>
      <div class="mt-2 h-2 bg-slate-100 rounded-full overflow-hidden">
        <div class="h-2 bg-gradient-to-r from-indigo-600 to-violet-600" style="width:${pct}%"></div>
      </div>
    `;
    card.onclick = ()=>{
      filterSubaccount.value = sa.id;
      renderBoard();
    };
    subList.appendChild(card);
  });
}

function getFilteredTasks(){
  const q = clean(searchInput.value).toLowerCase();
  const f = filterSubaccount.value;

  return tasks.filter(t=>{
    if(f && t.subaccountId !== f) return false;
    if(!q) return true;
    const saName = (subaccounts.find(s=>s.id===t.subaccountId)?.name || "").toLowerCase();
    return (
      (t.title||"").toLowerCase().includes(q) ||
      (t.details||"").toLowerCase().includes(q) ||
      (t.assigneeUsername||"").toLowerCase().includes(q) ||
      (t.createdByUsername||"").toLowerCase().includes(q) ||
      saName.includes(q)
    );
  });
}

function renderBoard(){
  board.innerHTML = "";
  const list = getFilteredTasks();

  STATUS.forEach(col=>{
    const colTasks = list.filter(t=>t.status===col.id);
    const wrap = document.createElement("div");
    wrap.className = "rounded-2xl border border-slate-200 bg-white shadow-soft overflow-hidden flex flex-col";

    wrap.innerHTML = `
      <div class="p-3 border-b border-slate-200 flex items-start justify-between">
        <div>
          <div class="font-semibold">${col.label}</div>
          <div class="text-xs text-slate-500">${colTasks.length} task(s)</div>
        </div>
      </div>
      <div class="p-3 space-y-2 bg-slate-50 min-h-[260px] flex-1"></div>
    `;

    const zone = wrap.querySelector(".p-3.space-y-2");
    colTasks.forEach(t=>{
      const saName = subaccounts.find(s=>s.id===t.subaccountId)?.name || "‚Äî";
      const msgCount = Array.isArray(t.messages) ? t.messages.length : 0;

      const card = document.createElement("div");
      card.className = "rounded-2xl border border-slate-200 bg-white p-3 cursor-pointer hover:border-slate-300 hover:shadow-soft transition active:scale-[.99]";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="font-semibold leading-snug">${escapeHtml(t.title||"Untitled")}</div>
            <div class="mt-1 text-xs text-slate-500 truncate">${escapeHtml(saName)}</div>
          </div>
          <div class="shrink-0 text-xs font-semibold px-2 py-1 rounded-xl bg-indigo-50 border border-indigo-200 text-indigo-800">
            ${escapeHtml(t.status||"")}
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
          <div>üë§ ${escapeHtml(t.assigneeUsername||"‚Äî")}</div>
          <div class="flex items-center gap-2">
            <span>üí¨ ${msgCount}</span>
            <span class="text-slate-300">‚Ä¢</span>
            <span>üßæ ${escapeHtml(t.createdByUsername||"‚Äî")}</span>
          </div>
        </div>
      `;
      card.onclick = ()=>openDetails(t.id);
      zone.appendChild(card);
    });

    board.appendChild(wrap);
  });
}

/* =========================
   NOTIFICATIONS
========================= */
function renderNotifications(){
  notifList.innerHTML = "";

  const unread = notifications.filter(n=>!n.read).length;
  if(unread > 0){
    notifCount.textContent = unread;
    notifCount.classList.remove("hidden");
  }else{
    notifCount.classList.add("hidden");
  }

  if(notifications.length===0){
    notifList.innerHTML = `<div class="p-3 text-sm text-slate-500">No notifications yet.</div>`;
    return;
  }

  notifications.forEach(n=>{
    const item = document.createElement("button");
    item.className = `w-full text-left rounded-2xl border p-3 transition hover:shadow-soft active:scale-[.99] ${n.read ? "border-slate-200 bg-white" : "border-indigo-200 bg-indigo-50"}`;
    item.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-sm font-semibold ${n.read ? "text-slate-900" : "text-indigo-900"}">
            ${escapeHtml(n.title||"Notification")}
          </div>
          <div class="mt-1 text-xs text-slate-600 whitespace-pre-wrap">${escapeHtml(n.body||"")}</div>
          <div class="mt-2 text-xs text-slate-400">${escapeHtml(n.createdAtText||"")}</div>
        </div>
        ${n.read ? "" : `<div class="h-2 w-2 rounded-full bg-indigo-600 mt-1"></div>`}
      </div>
    `;

    item.onclick = async ()=>{
      // mark read
      if(!n.read){
        await notifRef().doc(n.id).update({ read:true });
      }
      // open task if present
      if(n.taskId){
        const t = tasks.find(x=>x.id===n.taskId);
        if(t) openDetails(n.taskId);
      }
    };

    notifList.appendChild(item);
  });
}

async function createNotification(toUsername, title, body, taskId=null){
  if(!toUsername) return;
  if(toUsername.toLowerCase() === USER.toLowerCase()) return; // don't notify yourself

  const now = new Date();
  await notifRef().add({
    toUsername: toUsername.toLowerCase(),
    title,
    body,
    taskId: taskId || null,
    read: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAtText: now.toLocaleString()
  });
}

async function markAllRead(){
  const unread = notifications.filter(n=>!n.read);
  const batch = db.batch();
  unread.forEach(n=>{
    batch.update(notifRef().doc(n.id), { read:true });
  });
  await batch.commit();
  showToast("Marked all as read");
}

/* =========================
   SUBACCOUNT MODAL
========================= */
function openSubModal(){
  subErr.classList.add("hidden");
  subErr.textContent = "";
  subNameInput.value = "";
  subModal.classList.remove("hidden");
  subModal.classList.add("flex");
  setTimeout(()=>subNameInput.focus(), 50);
}
function closeSubModal(){
  subModal.classList.add("hidden");
  subModal.classList.remove("flex");
}

closeSubModalBtn.onclick = closeSubModal;
cancelSubBtn.onclick = closeSubModal;
subModal.addEventListener("click",(e)=>{ if(e.target===subModal) closeSubModal(); });

saveSubBtn.onclick = async ()=>{
  if(!isBuilder()) return alert("Only Builder/Admin can add subaccounts.");

  const name = clean(subNameInput.value);
  if(!name){
    subErr.textContent = "Please enter a subaccount name.";
    subErr.classList.remove("hidden");
    return;
  }

  try{
    await subRef().add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeSubModal();
    showToast("Subaccount added");
  }catch(e){
    console.error(e);
    subErr.textContent = e.message || "Failed (check Firestore rules)";
    subErr.classList.remove("hidden");
  }
};
subNameInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") saveSubBtn.click(); });

/* =========================
   TASK MODAL
========================= */
function openTaskModal(){
  if(!canCreate()) return alert("Only Builder/Admin can create tasks.");
  if(subaccounts.length===0) return alert("Add at least 1 subaccount first.");

  taskErr.classList.add("hidden");
  taskErr.textContent = "";

  tTitle.value = "";
  tDetails.value = "";
  tAssignee.value = USER.toLowerCase();
  tSub.value = subaccounts[0].id;

  taskModal.classList.remove("hidden");
  taskModal.classList.add("flex");
  setTimeout(()=>tTitle.focus(), 50);
}
function closeTaskModalFn(){
  taskModal.classList.add("hidden");
  taskModal.classList.remove("flex");
}

closeTaskModal.onclick = closeTaskModalFn;
cancelTaskBtn.onclick = closeTaskModalFn;
taskModal.addEventListener("click",(e)=>{ if(e.target===taskModal) closeTaskModalFn(); });

createTaskBtn.onclick = async ()=>{
  if(!canCreate()) return;

  const title = clean(tTitle.value);
  const details = clean(tDetails.value);
  const subId = tSub.value;
  const assigneeUsername = clean(tAssignee.value).toLowerCase();

  if(!title){
    taskErr.textContent = "Title required.";
    taskErr.classList.remove("hidden");
    return;
  }
  if(!subId){
    taskErr.textContent = "Select a subaccount.";
    taskErr.classList.remove("hidden");
    return;
  }
  if(!assigneeUsername){
    taskErr.textContent = "Assignee username required.";
    taskErr.classList.remove("hidden");
    return;
  }

  const nowISO = new Date().toISOString();

  try{
    const docRef = await taskRef().add({
      title,
      details,
      subaccountId: subId,
      status: "requested",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdByUsername: USER.toLowerCase(),
      createdByUid: UID,
      assigneeUsername,
      messages: [
        { by: USER.toLowerCase(), role: ROLE, text: "Task created.", at: nowISO }
      ]
    });

    // Notifications
    await createNotification(
      assigneeUsername,
      "New task assigned",
      `Task: "${title}"\nAssigned by: ${USER}\nStatus: Requested`,
      docRef.id
    );

    closeTaskModalFn();
    showToast("Task created");
  }catch(e){
    console.error(e);
    taskErr.textContent = e.message || "Failed (check Firestore rules)";
    taskErr.classList.remove("hidden");
  }
};

/* =========================
   DETAILS MODAL (CLEAN)
========================= */
function openDetails(taskId){
  const t = tasks.find(x=>x.id===taskId);
  if(!t) return;
  currentTaskId = taskId;

  detailsModal.classList.remove("hidden");
  detailsModal.classList.add("flex");
  renderDetails(t);
}
function closeDetails(){
  detailsModal.classList.add("hidden");
  detailsModal.classList.remove("flex");
  currentTaskId = null;
  msgInput.value = "";
}
closeDetailsModal.onclick = closeDetails;
detailsModal.addEventListener("click",(e)=>{ if(e.target===detailsModal) closeDetails(); });

function renderDetails(t){
  const saName = subaccounts.find(s=>s.id===t.subaccountId)?.name || "‚Äî";
  dTitle.textContent = t.title || "Task";
  dMeta.textContent = `${saName} ‚Ä¢ Created by ${t.createdByUsername||"‚Äî"} ‚Ä¢ Assigned to ${t.assigneeUsername||"‚Äî"} ‚Ä¢ Status: ${t.status||"‚Äî"}`;

  dStatus.value = t.status || "requested";
  dSub.value = t.subaccountId || "";
  dAssignee.value = t.assigneeUsername || "";
  dDetails.value = t.details || "";

  // permissions UI
  builderControls.style.display = canMove() ? "flex" : "none";

  const showClient = canApprove() && (t.status === "review");
  clientControls.classList.toggle("hidden", !showClient);

  // thread render
  thread.innerHTML = "";
  const msgs = Array.isArray(t.messages) ? t.messages.slice() : [];
  msgs.sort((a,b)=> (a.at>b.at ? 1 : -1));
  if(msgs.length===0){
    thread.innerHTML = `<div class="text-sm text-slate-500">No updates yet.</div>`;
  }else{
    msgs.forEach(m=>{
      const mine = (m.by||"").toLowerCase() === USER.toLowerCase();
      const bubble = document.createElement("div");
      bubble.className = `rounded-2xl border p-3 ${mine ? "bg-white border-indigo-200" : "bg-white border-slate-200"} shadow-sm`;
      bubble.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-semibold">
                    ${escapeHtml(m.by || "‚Äî")}
          <span class="text-xs font-medium text-slate-400">(${escapeHtml(m.role || "‚Äî")})</span>
        </div>
        <div class="text-xs text-slate-400">${escapeHtml(new Date(m.at || Date.now()).toLocaleString())}</div>
      </div>
      <div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${escapeHtml(m.text || "")}</div>
      `;
      thread.appendChild(bubble);
    });
    // auto scroll bottom
    thread.scrollTop = thread.scrollHeight;
  }
}

// Save changes (status/sub/assignee/details)
async function saveTaskChanges(){
  if(!currentTaskId) return;
  const t = tasks.find(x=>x.id===currentTaskId);
  if(!t) return;

  const newStatus = dStatus.value;
  const newSub = dSub.value;
  const newAssignee = clean(dAssignee.value).toLowerCase();
  const newDetails = dDetails.value || "";

  // permissions:
  // - builder/expert can change status
  // - builder can change subaccount/assignee/details
  if(!canMove() && newStatus !== (t.status||"requested")) {
    return alert("You cannot change status.");
  }
  if(!isBuilder()){
    // lock fields for non-builder
    if(newSub !== (t.subaccountId||"")) return alert("Only Builder can change subaccount.");
    if(newAssignee !== (t.assigneeUsername||"")) return alert("Only Builder can change assignee.");
    if(newDetails !== (t.details||"")) return alert("Only Builder can change details.");
  }

  const updates = {
    status: newStatus,
    subaccountId: newSub,
    assigneeUsername: newAssignee,
    details: newDetails,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await taskRef().doc(currentTaskId).update(updates);

    // notify assignee if changed
    if(newAssignee && newAssignee !== (t.assigneeUsername||"").toLowerCase()){
      await createNotification(
        newAssignee,
        "Task assigned to you",
        `Task: "${t.title}"\nAssigned by: ${USER}\nStatus: ${newStatus}`,
        currentTaskId
      );
    }

    // notify previous assignee (optional) if unassigned/changed
    const oldAssignee = (t.assigneeUsername||"").toLowerCase();
    if(oldAssignee && oldAssignee !== newAssignee){
      await createNotification(
        oldAssignee,
        "Task reassigned",
        `Task: "${t.title}" is no longer assigned to you.`,
        currentTaskId
      );
    }

    // notify creator + assignee when status changes
    if(newStatus !== (t.status||"")){
      const title = "Task status updated";
      const body = `Task: "${t.title}"\nNew Status: ${newStatus}\nUpdated by: ${USER}`;
      await createNotification((t.createdByUsername||"").toLowerCase(), title, body, currentTaskId);
      await createNotification(newAssignee, title, body, currentTaskId);
    }

    showToast("Saved");
  }catch(e){
    console.error(e);
    alert(e.message || "Save failed");
  }
}

saveTaskBtn.onclick = saveTaskChanges;

// quick move buttons
async function quickMove(newStatus){
  if(!currentTaskId) return;
  if(!canMove()) return alert("You cannot move status.");
  dStatus.value = newStatus;
  await saveTaskChanges();
}

btnClarify.onclick = ()=>quickMove("clarify");
btnProgress.onclick = ()=>quickMove("progress");
btnReview.onclick = ()=>quickMove("review");
btnDone.onclick = ()=>quickMove("done");

// client approve / request changes
btnApprove.onclick = async ()=>{
  if(!currentTaskId) return;
  const t = tasks.find(x=>x.id===currentTaskId);
  if(!t) return;

  if(!(canApprove() && t.status==="review")){
    return alert("You can only approve in Client Review.");
  }
  dStatus.value = "done";
  await saveTaskChanges();

  // add a message
  await addMessageToTask("Approved ‚úÖ");
};

btnChanges.onclick = async ()=>{
  if(!currentTaskId) return;
  const t = tasks.find(x=>x.id===currentTaskId);
  if(!t) return;

  if(!(canApprove() && t.status==="review")){
    return alert("You can only request changes in Client Review.");
  }
  dStatus.value = "progress";
  await saveTaskChanges();
  await addMessageToTask("Requested changes (moved back to In Progress).");
};

// send message
async function addMessageToTask(text){
  if(!currentTaskId) return;
  const msg = clean(text || msgInput.value);
  if(!msg) return;

  const atISO = new Date().toISOString();
  try{
    await taskRef().doc(currentTaskId).update({
      messages: firebase.firestore.FieldValue.arrayUnion({
        by: USER.toLowerCase(),
        role: ROLE,
        text: msg,
        at: atISO
      }),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // notify creator + assignee on new message (except yourself)
    const t = tasks.find(x=>x.id===currentTaskId);
    if(t){
      const title = "New message on task";
      const body = `Task: "${t.title}"\nFrom: ${USER}\nMessage: ${msg}`;
      await createNotification((t.createdByUsername||"").toLowerCase(), title, body, currentTaskId);
      await createNotification((t.assigneeUsername||"").toLowerCase(), title, body, currentTaskId);
    }

    msgInput.value = "";
  }catch(e){
    console.error(e);
    alert(e.message || "Message failed");
  }
}

sendMsgBtn.onclick = ()=>addMessageToTask();
msgInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addMessageToTask();
  }
});

/* =========================
   NOTIF UI
========================= */
notifBtn.onclick = ()=>{
  notifPanel.classList.toggle("hidden");
};

markAllReadBtn.onclick = markAllRead;

// close notif on outside click
document.addEventListener("click",(e)=>{
  const inside = notifPanel.contains(e.target) || notifBtn.contains(e.target);
  if(!inside) notifPanel.classList.add("hidden");
});

/* =========================
   NAV / BUTTONS
========================= */
filterSubaccount.onchange = renderBoard;
searchInput.addEventListener("input", renderBoard);

addSubBtn.onclick = ()=>{
  if(!isBuilder()) return alert("Only Builder/Admin can add subaccounts.");
  openSubModal();
};

newTaskBtn.onclick = openTaskModal;

logoutBtn.onclick = async ()=>{
  try{
    await auth.signOut();
  }catch(e){}
  // reset UI
  WS=null; USER=null; ROLE=null; UID=null;
  subaccounts=[]; tasks=[]; notifications=[]; currentTaskId=null;

  userBadge.textContent = "";
  wsBadge.textContent = "";
  notifPanel.classList.add("hidden");
  authModal.classList.remove("hidden");
  showToast("Logged out");
};

/* =========================
   KEYBOARD SHORTCUTS
========================= */
document.addEventListener("keydown",(e)=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==="k"){
    e.preventDefault();
    searchInput.focus();
  }
  if(e.key==="Escape"){
    // close modals/panels
    notifPanel.classList.add("hidden");
    if(!detailsModal.classList.contains("hidden")) closeDetails();
    if(!taskModal.classList.contains("hidden")) closeTaskModalFn();
    if(!subModal.classList.contains("hidden")) closeSubModal();
  }
});

/* =========================
   AUTH BUTTONS
========================= */
loginBtn.onclick = doLogin;
registerBtn.onclick = doRegister;

// If already logged-in session exists (optional)
auth.onAuthStateChanged(async (user)=>{
  // keep it simple: always show auth modal until user logs in via UI (workspace+role required)
  // This avoids confusion with workspace routing.
  // You can enhance later by storing WS/ROLE in localStorage and auto-enter.
});

/* =========================
   INITIAL UI STATE
========================= */
function lockUIUntilAuth(){
  // hide risky buttons until login
  addSubBtn.style.display = "none";
  newTaskBtn.style.display = "none";
}
lockUIUntilAuth();
</script>

</body>
</html>
