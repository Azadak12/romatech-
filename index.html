<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subaccount Change Tracker</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    ::-webkit-scrollbar{ width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); border-radius: 999px; }
    ::-webkit-scrollbar-track{ background: transparent; }

    .fade-in { animation: fadeIn .18s ease-out both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px) scale(.99);} to {opacity:1; transform:none;} }

    .toast-in { animation: toastIn .18s ease-out both; }
    @keyframes toastIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform:none;} }

    .glass { backdrop-filter: blur(10px); }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 10px 30px rgba(2, 6, 23, .08)",
            lift: "0 18px 45px rgba(2, 6, 23, .14)"
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen text-slate-900 bg-[radial-gradient(1200px_600px_at_20%_0%,rgba(99,102,241,.10),transparent_55%),radial-gradient(900px_500px_at_85%_10%,rgba(168,85,247,.10),transparent_50%),linear-gradient(to_bottom,rgba(248,250,252,1),rgba(241,245,249,1))]">

<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] hidden">
  <div class="toast-in rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm shadow-soft flex items-center gap-2">
    <span id="toastText">Saved</span>
  </div>
</div>

<div id="authModal" class="fixed inset-0 z-50 bg-black/40 glass flex items-center justify-center p-4">
  <div class="fade-in w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-5 border-b border-slate-100">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
        <div class="min-w-0">
          <div class="font-extrabold leading-tight">Subaccount Change Tracker</div>
          <div class="text-xs text-slate-500">Login/Register</div>
        </div>
      </div>
    </div>

    <div class="p-5 space-y-3">
      <div>
        <label class="text-xs font-semibold text-slate-600">Workspace</label>
        <input id="wsInput" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., romatech" autocomplete="off" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Username</label>
        <input id="usernameInput" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul" autocomplete="username" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Password</label>
        <input id="passwordInput" type="password"
          class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="Min 6 characters" autocomplete="current-password" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Role</label>
        <select id="roleInput"
          class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
          <option value="client">Agency Owner (Creates Requests)</option>
          <option value="ghl_expert">GHL Expert (Processes Tasks)</option>
          <option value="builder">Builder (Admin)</option>
        </select>
        <div class="mt-1 text-[11px] text-slate-500">
          <b>Owner:</b> Requests changes. <b>Expert:</b> Does the work. <b>Both:</b> Add Subaccounts.
        </div>
      </div>

      <div id="authMsg" class="text-sm text-rose-600 hidden"></div>

      <div class="pt-1 flex gap-2">
        <button id="loginBtn"
          class="flex-1 rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm font-bold hover:bg-slate-800 active:scale-[.99] transition">
          Login
        </button>
        <button id="registerBtn"
          class="flex-1 rounded-2xl bg-indigo-600 text-white px-4 py-2.5 text-sm font-bold hover:bg-indigo-700 active:scale-[.99] transition">
          Register
        </button>
      </div>
    </div>
  </div>
</div>

<header class="sticky top-0 z-40 border-b border-slate-200/70 bg-white/70 glass">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
      <div class="min-w-0">
        <h1 class="text-base font-extrabold leading-tight truncate">Subaccount Change Tracker</h1>
        <p class="text-xs text-slate-500 truncate">Requested â†’ Clarification â†’ In Progress â†’ Client Review â†’ Done</p>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div class="relative hidden lg:block">
        <input id="searchInput" type="text" placeholder="Search tasks, users, notesâ€¦"
          class="w-[360px] rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
      </div>

      <select id="filterSubaccount"
        class="rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
        <option value="">All</option>
      </select>

      <button id="newTaskBtn" style="display:none;"
        class="rounded-2xl bg-indigo-600 px-4 py-2.5 text-sm font-bold text-white shadow-soft hover:bg-indigo-700 active:scale-[.99] transition">
        + Task
      </button>

      <div class="relative">
        <button id="notifBtn"
          class="rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition flex items-center gap-2">
          ðŸ”” <span id="notifCount" class="hidden text-xs font-bold px-2 py-0.5 rounded-full bg-rose-600 text-white">0</span>
        </button>

        <div id="notifPanel" class="hidden absolute right-0 mt-2 w-[380px] max-w-[92vw] rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
          <div class="p-3 border-b border-slate-100 flex items-center justify-between">
            <div class="font-semibold">Notifications</div>
            <button id="markAllReadBtn" class="text-xs font-semibold px-2 py-1 rounded-2xl border border-slate-200 hover:bg-slate-50">
              Mark all read
            </button>
          </div>
          <div id="notifList" class="max-h-[380px] overflow-auto bg-slate-50 p-2 space-y-2"></div>
        </div>
      </div>

      <button id="logoutBtn"
        class="rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
        Logout
      </button>

      <div class="hidden xl:block text-sm text-slate-600 whitespace-nowrap">
        <span id="userBadge" class="font-semibold"></span>
        <span id="wsBadge" class="text-slate-400"></span>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 pb-4 lg:hidden">
    <input id="searchInputMobile" type="text" placeholder="Search tasksâ€¦"
      class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
  </div>
</header>

<main class="max-w-7xl mx-auto px-5 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <aside class="lg:col-span-3">
      <div class="rounded-3xl bg-white border border-slate-100 shadow-soft overflow-hidden">
        <div class="p-4 flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Subaccounts</h2>
            <p class="text-xs text-slate-500">Click to filter</p>
          </div>
          <button id="addSubBtn" style="display:none;"
            class="rounded-2xl border border-slate-200 px-3 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
            + Add
          </button>
        </div>

        <div id="subList" class="px-3 pb-3 space-y-1"></div>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
          <div class="rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-600">
            <div class="font-bold mb-1">Roles:</div>
            <ul class="list-disc pl-4 space-y-1 text-xs">
                <li><b>Owner:</b> Creates Tasks</li>
                <li><b>Expert:</b> Processes Tasks</li>
                <li><b>Both:</b> Add/View Subs</li>
            </ul>
          </div>
        </div>
      </div>
    </aside>

    <section class="lg:col-span-9">
      <div class="overflow-x-auto pb-2">
        <div id="board" class="min-w-max grid grid-flow-col auto-cols-max gap-4"></div>
      </div>
    </section>

  </div>
</main>

<div id="subModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-lg rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">Add Subaccount</h3>
        <p class="text-sm text-slate-500">Example: VIP Tires - Ohio</p>
      </div>
      <button id="closeSubModalBtn" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="p-4">
      <label class="text-xs font-semibold text-slate-600">Subaccount name</label>
      <input id="subNameInput"
        class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
        placeholder="Type subaccount name..." />

      <div id="subErr" class="mt-2 text-sm text-rose-600 hidden"></div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="cancelSubBtn" class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
          Cancel
        </button>
        <button id="saveSubBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-2xl rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">New Task Request</h3>
        <p class="text-sm text-slate-500">Request a change for the Expert</p>
      </div>
      <button id="closeTaskModal" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Task Name</label>
        <input id="tTitle" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., Fix automation trigger" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Subaccount</label>
        <select id="tSub" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Assign to (Expert Username)</label>
        <input id="tAssignee" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul" />
      </div>

      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Details</label>
        <textarea id="tDetails" rows="4" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="Paste the client message + what to change..."></textarea>
      </div>

      <div id="taskErr" class="md:col-span-2 text-sm text-rose-600 hidden"></div>

      <div class="md:col-span-2 flex items-center justify-end gap-2">
        <button id="cancelTaskBtn" class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">Cancel</button>
        <button id="createTaskBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">Create & Notify</button>
      </div>
    </div>
  </div>
</div>

<div id="detailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-5xl rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-start justify-between gap-3">
      <div class="min-w-0">
        <h3 id="dTitle" class="font-semibold text-lg truncate">Task</h3>
        <p id="dMeta" class="text-sm text-slate-500 truncate">â€”</p>
      </div>
      <button id="closeDetailsModal" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12">
      <div class="lg:col-span-4 border-b lg:border-b-0 lg:border-r border-slate-100 p-4 bg-slate-50">
        <div class="space-y-3">
          <div class="rounded-3xl bg-white border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-500">Status</div>
            <select id="dStatus" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>

            <div class="mt-3 text-xs font-semibold text-slate-500">Subaccount</div>
            <select id="dSub" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>

            <div class="mt-3 text-xs font-semibold text-slate-500">Assignee</div>
            <input id="dAssignee" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />

            <div id="expertControls" class="mt-3 grid grid-cols-2 gap-2">
              <button id="btnClarify" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">Clarify</button>
              <button id="btnProgress" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">In Progress</button>
              <button id="btnReview" class="rounded-2xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800 transition col-span-2">Send to Review</button>
              <button id="btnDone" class="rounded-2xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition col-span-2">Mark Done</button>
            </div>

            <div id="clientControls" class="hidden mt-3 grid grid-cols-2 gap-2">
              <button id="btnApprove" class="rounded-2xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition col-span-2">Approve Done âœ…</button>
              <button id="btnChanges" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition col-span-2">Request Changes</button>
            </div>

            <button id="saveTaskBtn" class="mt-3 w-full rounded-2xl bg-indigo-600 text-white px-3 py-2 text-sm font-semibold hover:bg-indigo-700 transition">Save Changes</button>
          </div>

          <div class="rounded-3xl bg-white border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-500">Details</div>
            <textarea id="dDetails" rows="7" class="mt-2 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></textarea>
          </div>
        </div>
      </div>

      <div class="lg:col-span-8 p-4">
        <div class="rounded-3xl border border-slate-200 overflow-hidden bg-white">
          <div class="p-3 border-b border-slate-100 flex items-center justify-between">
            <div>
              <div class="font-semibold">Conversation</div>
              <div class="text-sm text-slate-500">Clean thread, easy for client</div>
            </div>
          </div>

          <div id="thread" class="p-3 space-y-2 max-h-[520px] overflow-auto bg-slate-50"></div>

          <div class="p-3 border-t border-slate-100 bg-white">
            <div class="flex gap-2">
              <input id="msgInput" class="flex-1 rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
                placeholder="Write an update..." />
              <button id="sendMsgBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 transition">Send</button>
            </div>
            <div class="mt-2 text-xs text-slate-500">Press Enter to send.</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================
   CONFIGURATION
========================= */
// âš¡ï¸ PASTE YOUR ZAPIER OR MAKE WEBHOOK URL HERE TO ENABLE EMAILS
// Example: "https://hooks.zapier.com/hooks/catch/12345/abcde/"
const EMAIL_WEBHOOK_URL = ""; 

const RECIPIENT_EMAIL = "kalamshar786@gmail.com";
const EMAIL_SUBJECT = "please give me updataed i copy paste in the gituhb";

/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a",
  measurementId: "G-7CWF4D2V3T"
};

if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   DOM HELPERS
========================= */
const $ = (id) => document.getElementById(id);

/* Toast */
const toast = $("toast");
const toastText = $("toastText");
function showToast(msg) {
  if (!toast || !toastText) return;
  toastText.textContent = msg || "Done";
  toast.classList.remove("hidden");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toast.classList.add("hidden"), 1600);
}

/* Auth modal */
const authModal = $("authModal");
const wsInput = $("wsInput");
const usernameInput = $("usernameInput");
const passwordInput = $("passwordInput");
const roleInput = $("roleInput");
const loginBtn = $("loginBtn");
const registerBtn = $("registerBtn");
const authMsg = $("authMsg");

/* Header UI */
const userBadge = $("userBadge");
const wsBadge = $("wsBadge");
const logoutBtn = $("logoutBtn");

const searchInput = $("searchInput");
const searchInputMobile = $("searchInputMobile");
const filterSubaccount = $("filterSubaccount");
const newTaskBtn = $("newTaskBtn");
const addSubBtn = $("addSubBtn");

const subList = $("subList");
const board = $("board");

/* Sub modal */
const subModal = $("subModal");
const subNameInput = $("subNameInput");
const closeSubModalBtn = $("closeSubModalBtn");
const cancelSubBtn = $("cancelSubBtn");
const saveSubBtn = $("saveSubBtn");
const subErr = $("subErr");

/* Task modal */
const taskModal = $("taskModal");
const closeTaskModal = $("closeTaskModal");
const cancelTaskBtn = $("cancelTaskBtn");
const createTaskBtn = $("createTaskBtn");
const tTitle = $("tTitle");
const tSub = $("tSub");
const tAssignee = $("tAssignee");
const tDetails = $("tDetails");
const taskErr = $("taskErr");

/* Details modal */
const detailsModal = $("detailsModal");
const closeDetailsModal = $("closeDetailsModal");
const dTitle = $("dTitle");
const dMeta = $("dMeta");
const dStatus = $("dStatus");
const dSub = $("dSub");
const dAssignee = $("dAssignee");
const dDetails = $("dDetails");
const saveTaskBtn = $("saveTaskBtn");

const expertControls = $("expertControls");
const btnClarify = $("btnClarify");
const btnProgress = $("btnProgress");
const btnReview = $("btnReview");
const btnDone = $("btnDone");
const btnApprove = $("btnApprove");
const btnChanges = $("btnChanges");
const clientControls = $("clientControls");

const thread = $("thread");
const msgInput = $("msgInput");
const sendMsgBtn = $("sendMsgBtn");

/* Notifications panel */
const notifBtn = $("notifBtn");
const notifPanel = $("notifPanel");
const notifList = $("notifList");
const notifCount = $("notifCount");
const markAllReadBtn = $("markAllReadBtn");

/* =========================
   STATE & ROLES
========================= */
let WS = null, USER = null, ROLE = null, UID = null;
let subaccounts = [], tasks = [], notifications = [];
let currentTaskId = null;

const STATUS = [
  { id: "requested", label: "Requested" },
  { id: "clarify", label: "Clarification" },
  { id: "progress", label: "In Progress" },
  { id: "review", label: "Client Review" },
  { id: "done", label: "Done" }
];

/* ROLE LOGIC 
   Client (Agency Owner): Creates tasks, adds subs.
   Expert (Worker): Moves tasks, adds subs.
   Builder: Admin access.
*/
function isBuilder() { return ROLE === "builder"; }
function isExpert() { return ROLE === "ghl_expert"; }
function isClient() { return ROLE === "client"; }

function canCreate() { return isClient() || isBuilder(); }
function canMove() { return isExpert() || isBuilder(); }
function canAddSub() { return isClient() || isExpert() || isBuilder(); }
function canApprove() { return isClient() || isBuilder(); }

function clean(str) { return (str || "").trim(); }
function nowISO() { return new Date().toISOString(); }
function escapeHtml(str) {
  return (str ?? "").toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function formatRole(r) {
  if (r === "builder") return "Builder";
  if (r === "ghl_expert") return "Expert";
  if (r === "client") return "Owner";
  return r || "";
}

/* =========================
   SESSION & AUTH
========================= */
const SESSION_KEY = "sct_session_v1";
function saveSession() {
  try { localStorage.setItem(SESSION_KEY, JSON.stringify({ WS, USER, ROLE })); } catch (e) { }
}
function loadSession() {
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    const v = JSON.parse(raw);
    if (!v?.WS || !v?.USER || !v?.ROLE) return null;
    return v;
  } catch (e) { return null; }
}
function clearSession() {
  try { localStorage.removeItem(SESSION_KEY); } catch (e) { }
}

function makeEmail(username, ws) {
  return `${username.toLowerCase()}@${ws.toLowerCase()}.local`;
}

function setAuthError(msg) {
  if (!authMsg) return;
  if (!msg) {
    authMsg.classList.add("hidden");
    authMsg.textContent = "";
    return;
  }
  authMsg.textContent = msg;
  authMsg.classList.remove("hidden");
}

async function doRegister() {
  setAuthError("");
  const ws = clean(wsInput?.value);
  const username = clean(usernameInput?.value).replace(/\s+/g, "").toLowerCase();
  const password = passwordInput?.value || "";
  const selectedRole = roleInput?.value || "client";

  if (!ws || !username || !password) return setAuthError("Workspace, Username, Password required.");
  if (password.length < 6) return setAuthError("Password must be at least 6 characters.");

  const email = makeEmail(username, ws);

  try {
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    await db.collection("workspaces").doc(ws).collection("users").doc(cred.user.uid).set({
      username,
      role: selectedRole,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    await afterAuthSecure(ws, username, cred.user.uid);
  } catch (e) {
    console.error(e);
    setAuthError(e.message || "Register failed");
  }
}

async function doLogin() {
  setAuthError("");
  const ws = clean(wsInput?.value);
  const username = clean(usernameInput?.value).replace(/\s+/g, "").toLowerCase();
  const password = passwordInput?.value || "";

  if (!ws || !username || !password) return setAuthError("Workspace, Username, Password required.");
  const email = makeEmail(username, ws);

  try {
    const cred = await auth.signInWithEmailAndPassword(email, password);
    await afterAuthSecure(ws, username, cred.user.uid);
  } catch (e) {
    console.error(e);
    setAuthError(e.message || "Login failed");
  }
}

async function afterAuthSecure(ws, username, uid) {
  WS = ws;
  USER = (username || "").toLowerCase();
  UID = uid;

  const uSnap = await db.collection("workspaces").doc(WS).collection("users").doc(uid).get();
  let firestoreRole = uSnap.exists ? (uSnap.data()?.role || "") : "";
  
  // Fallback
  if (!firestoreRole) {
    firestoreRole = "client";
    await db.collection("workspaces").doc(WS).collection("users").doc(uid).set({ username: USER, role: firestoreRole }, { merge: true });
  }

  ROLE = firestoreRole;
  saveSession();

  authModal?.classList.add("hidden");
  if (userBadge) userBadge.textContent = `${USER} (${formatRole(ROLE)})`;
  if (wsBadge) wsBadge.textContent = ` â€¢ WS: ${WS}`;

  // UPDATE BUTTON VISIBILITY BASED ON ROLES
  if (addSubBtn) addSubBtn.style.display = canAddSub() ? "inline-flex" : "none";
  if (newTaskBtn) newTaskBtn.style.display = canCreate() ? "inline-flex" : "none";

  if (dStatus) dStatus.innerHTML = STATUS.map(s => `<option value="${s.id}">${s.label}</option>`).join("");

  bindRealtime();
  showToast("Welcome!");
}

/* =========================
   REALTIME DATA
========================= */
let unsubSubs = null, unsubTasks = null, unsubNotifs = null;

function bindRealtime() {
  if (!WS || !USER) return;
  if(unsubSubs) unsubSubs();
  if(unsubTasks) unsubTasks();
  if(unsubNotifs) unsubNotifs();

  const wsRef = db.collection("workspaces").doc(WS);

  unsubSubs = wsRef.collection("subaccounts").orderBy("createdAt", "desc").onSnapshot(snap => {
    subaccounts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderDropdowns();
    renderSubaccounts();
    renderBoard();
  });

  unsubTasks = wsRef.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
    tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSubaccounts();
    renderBoard();
    if (currentTaskId) {
      const t = tasks.find(x => x.id === currentTaskId);
      if (t) renderDetails(t);
    }
  });

  unsubNotifs = wsRef.collection("notifications")
    .where("toUsername", "==", USER)
    .orderBy("createdAt", "desc")
    .limit(50)
    .onSnapshot(snap => {
      notifications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderNotifications();
    });
}

/* =========================
   UI RENDERING
========================= */
function renderDropdowns() {
  if (!filterSubaccount || !tSub || !dSub) return;
  const cur = filterSubaccount.value;
  const opts = subaccounts.map(sa => `<option value="${sa.id}">${escapeHtml(sa.name || "â€”")}</option>`).join("");
  
  filterSubaccount.innerHTML = `<option value="">All</option>` + opts;
  filterSubaccount.value = [...filterSubaccount.options].some(o => o.value === cur) ? cur : "";
  
  tSub.innerHTML = opts;
  dSub.innerHTML = opts;
}

function getFilteredTasks() {
  const q = (clean(searchInput?.value) || clean(searchInputMobile?.value)).toLowerCase();
  const f = filterSubaccount?.value || "";

  return tasks.filter(t => {
    if (f && t.subaccountId !== f) return false;
    if (!q) return true;
    const saName = (subaccounts.find(s => s.id === t.subaccountId)?.name || "").toLowerCase();
    return (
      (t.title || "").toLowerCase().includes(q) ||
      (t.details || "").toLowerCase().includes(q) ||
      saName.includes(q)
    );
  });
}

function renderSubaccounts() {
  if (!subList) return;
  subList.innerHTML = "";
  if (subaccounts.length === 0) {
    subList.innerHTML = `<div class="text-sm text-slate-500 px-1 pb-2">No subaccounts yet.</div>`;
    return;
  }
  subaccounts.forEach(sa => {
    const total = tasks.filter(t => t.subaccountId === sa.id).length;
    const done = tasks.filter(t => t.subaccountId === sa.id && t.status === "done").length;
    const pct = total === 0 ? 0 : Math.round((done / total) * 100);

    const item = document.createElement("button");
    item.className = "w-full text-left px-3 py-2 rounded-2xl hover:bg-slate-50 transition flex items-center justify-between gap-3";
    item.innerHTML = `
      <div class="min-w-0">
        <div class="font-semibold truncate">${escapeHtml(sa.name || "â€”")}</div>
        <div class="text-xs text-slate-500">${total} tasks</div>
      </div>
      <div class="text-xs font-semibold text-slate-500">${pct}%</div>
    `;
    item.onclick = () => { filterSubaccount.value = sa.id; renderBoard(); };
    subList.appendChild(item);
  });
}

function renderBoard() {
  if (!board) return;
  board.innerHTML = "";
  const list = getFilteredTasks();

  STATUS.forEach(col => {
    const colTasks = list.filter(t => (t.status || "requested") === col.id);
    const dot = col.id === "requested" ? "bg-sky-500" : col.id === "clarify" ? "bg-amber-500" : col.id === "progress" ? "bg-indigo-500" : col.id === "review" ? "bg-fuchsia-500" : "bg-emerald-500";

    const wrap = document.createElement("div");
    wrap.className = "snap-start min-w-[300px] w-[300px] rounded-3xl bg-white border border-slate-200 shadow-soft overflow-hidden flex flex-col";
    wrap.innerHTML = `
      <div class="px-4 pt-4 pb-3 border-b border-slate-200 bg-white flex justify-between">
        <div class="flex items-center gap-2">
          <span class="h-2.5 w-2.5 rounded-full ${dot}"></span>
          <div class="font-extrabold text-slate-900">${col.label}</div>
        </div>
        <div class="text-xs font-bold px-2 py-1 rounded-full bg-slate-900 text-white">${colTasks.length}</div>
      </div>
      <div class="p-3 bg-slate-50 flex-1 overflow-auto space-y-2 min-h-[400px]"></div>
    `;

    const zone = wrap.querySelector(".p-3.bg-slate-50");
    if (colTasks.length === 0) zone.innerHTML = `<div class="text-sm text-slate-400 italic text-center mt-4">Empty</div>`;

    colTasks.forEach(t => {
      const saName = subaccounts.find(s => s.id === t.subaccountId)?.name || "â€”";
      const card = document.createElement("button");
      card.className = "w-full text-left rounded-3xl bg-white border border-slate-200 hover:shadow-soft transition px-4 py-3";
      card.innerHTML = `
        <div class="font-bold text-slate-900 text-sm line-clamp-2">${escapeHtml(t.title)}</div>
        <div class="mt-2 flex items-center gap-2">
            <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">${escapeHtml(saName)}</span>
            <span class="text-[10px] text-slate-400">@${t.assigneeUsername || "?"}</span>
        </div>
      `;
      card.onclick = () => openDetails(t.id);
      zone.appendChild(card);
    });
    board.appendChild(wrap);
  });
}

function renderNotifications() {
  if (!notifList || !notifCount) return;
  notifList.innerHTML = "";
  const unread = notifications.filter(n => !n.read).length;
  notifCount.textContent = unread;
  notifCount.classList.toggle("hidden", unread === 0);

  if (notifications.length === 0) {
    notifList.innerHTML = `<div class="p-3 text-sm text-slate-500">No notifications.</div>`;
    return;
  }

  notifications.forEach(n => {
    const item = document.createElement("button");
    item.className = `w-full text-left rounded-3xl border p-3 mb-1 ${n.read ? "bg-white border-slate-200" : "bg-indigo-50 border-indigo-200"}`;
    item.innerHTML = `<div class="text-sm font-semibold">${escapeHtml(n.title)}</div><div class="text-xs text-slate-500">${escapeHtml(n.body)}</div>`;
    item.onclick = async () => {
      if (!n.read) await db.collection("workspaces").doc(WS).collection("notifications").doc(n.id).update({ read: true });
      if (n.taskId) openDetails(n.taskId);
    };
    notifList.appendChild(item);
  });
}

/* =========================
   TASK / SUB CREATION
========================= */
function openSubModal() {
  if (!canAddSub()) return alert("Role cannot add subaccounts.");
  subModal.classList.remove("hidden");
  subModal.classList.add("flex");
}
closeSubModalBtn.onclick = () => { subModal.classList.add("hidden"); subModal.classList.remove("flex"); };
saveSubBtn.onclick = async () => {
  const name = clean(subNameInput.value);
  if (!name) return;
  await db.collection("workspaces").doc(WS).collection("subaccounts").add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  closeSubModalBtn.click();
  showToast("Subaccount Added");
};

function openTaskModal() {
  if (!canCreate()) return alert("Only Clients/Owners can create request tasks.");
  taskModal.classList.remove("hidden");
  taskModal.classList.add("flex");
}
closeTaskModal.onclick = () => { taskModal.classList.add("hidden"); taskModal.classList.remove("flex"); };

/* ---------------------------------------------------------
   EMAIL LOGIC TRIGGER (WEBHOOK)
--------------------------------------------------------- */
async function sendEmailNotification(title, subName, details) {
  // If no webhook configured, we just log to console
  if (!EMAIL_WEBHOOK_URL) {
    console.log("âš ï¸ No Webhook URL set. Email simulation:", {
        to: RECIPIENT_EMAIL,
        subject: EMAIL_SUBJECT,
        body: `Task: ${title} | Sub: ${subName} | Details: ${details}`
    });
    return;
  }

  // Send payload to Zapier/Make
  try {
    fetch(EMAIL_WEBHOOK_URL, {
        method: "POST",
        mode: "no-cors", // Standard for simple webhooks to avoid CORS errors
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            recipient: RECIPIENT_EMAIL,
            subject: EMAIL_SUBJECT,
            taskName: title,
            subaccount: subName,
            details: details,
            sentAt: new Date().toISOString()
        })
    });
    console.log("Email Webhook Triggered");
  } catch (e) {
    console.error("Webhook failed", e);
  }
}

createTaskBtn.onclick = async () => {
  const title = clean(tTitle.value);
  const details = clean(tDetails.value);
  const subId = tSub.value;
  const assigneeUsername = clean(tAssignee.value).toLowerCase();
  
  // Get Subaccount Name for the Email
  const subIdx = subaccounts.findIndex(s => s.id === subId);
  const subName = subIdx > -1 ? subaccounts[subIdx].name : "Unknown";

  if (!title || !subId || !assigneeUsername) return alert("Missing fields");

  // 1. Create in Firestore
  const ref = await db.collection("workspaces").doc(WS).collection("tasks").add({
    title, details, subaccountId: subId, status: "requested",
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdByUsername: USER, assigneeUsername,
    messages: [{ by: USER, role: ROLE, text: "Task requested.", at: nowISO() }]
  });

  // 2. Notify Assignee internally
  await db.collection("workspaces").doc(WS).collection("notifications").add({
    toUsername: assigneeUsername, title: "New Request", body: `Request: ${title}`, taskId: ref.id, read: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // 3. TRIGGER EXTERNAL EMAIL VIA WEBHOOK
  sendEmailNotification(title, subName, details);

  closeTaskModal.click();
  showToast("Task Requested & Email Triggered");
};

/* =========================
   DETAILS & UPDATES
========================= */
function openDetails(taskId) {
  currentTaskId = taskId;
  const t = tasks.find(x => x.id === taskId);
  if (!t) return;
  
  detailsModal.classList.remove("hidden");
  detailsModal.classList.add("flex");
  
  dTitle.textContent = t.title;
  dMeta.textContent = `@${t.assigneeUsername} â€¢ ${t.status}`;
  dStatus.value = t.status;
  dSub.value = t.subaccountId;
  dAssignee.value = t.assigneeUsername;
  dDetails.value = t.details || "";

  // Show Client Approve/Reject if status is Review
  clientControls.classList.toggle("hidden", !(isClient() && t.status === "review"));
  
  // Expert controls generally hidden for clients, but we leave them open for flexibility in this simple version
  // except client usually shouldn't move things to "Done" directly unless approving.
  expertControls.classList.toggle("hidden", isClient());

  renderThread(t);
}
closeDetailsModal.onclick = () => { detailsModal.classList.add("hidden"); detailsModal.classList.remove("flex"); currentTaskId = null; };

function renderThread(t) {
  thread.innerHTML = "";
  (t.messages || []).forEach(m => {
    const div = document.createElement("div");
    div.className = "rounded-2xl bg-white border p-3";
    div.innerHTML = `<div class="text-xs font-bold text-slate-600">${m.by}</div><div class="mt-1 text-sm">${escapeHtml(m.text)}</div>`;
    thread.appendChild(div);
  });
}

sendMsgBtn.onclick = async () => {
  if (!currentTaskId) return;
  const text = clean(msgInput.value);
  if (!text) return;
  const t = tasks.find(x => x.id === currentTaskId);
  const msgs = [...(t.messages || []), { by: USER, role: ROLE, text, at: nowISO() }];
  
  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({
    messages: msgs, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value = "";
};

async function updateStatus(st) {
  if (!currentTaskId) return;
  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({ status: st });
  showToast("Status: " + st);
}
btnClarify.onclick = () => updateStatus("clarify");
btnProgress.onclick = () => updateStatus("progress");
btnReview.onclick = () => updateStatus("review");
btnDone.onclick = () => updateStatus("done");

btnApprove.onclick = () => updateStatus("done");
btnChanges.onclick = () => updateStatus("clarify");

saveTaskBtn.onclick = async () => {
  if (!currentTaskId) return;
  await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({
    details: clean(dDetails.value), assigneeUsername: clean(dAssignee.value), subaccountId: dSub.value, status: dStatus.value
  });
  showToast("Saved");
};

/* =========================
   EVENTS
========================= */
loginBtn.onclick = doLogin;
registerBtn.onclick = doRegister;
logoutBtn.onclick = async () => { clearSession(); await auth.signOut(); location.reload(); };
notifBtn.onclick = () => notifPanel.classList.toggle("hidden");
markAllReadBtn.onclick = async () => {
  const batch = db.batch();
  notifications.filter(n => !n.read).forEach(n => batch.update(db.collection("workspaces").doc(WS).collection("notifications").doc(n.id), { read: true }));
  await batch.commit();
};

addSubBtn.onclick = openSubModal;
newTaskBtn.onclick = openTaskModal;
searchInput.addEventListener("input", renderBoard);
filterSubaccount.addEventListener("change", renderBoard);

auth.onAuthStateChanged(u => {
  if (!u) { authModal.classList.remove("hidden"); return; }
  const s = loadSession();
  if (!s) { authModal.classList.remove("hidden"); return; }
  afterAuthSecure(s.WS, s.USER, u.uid);
});

</script>
</body>
</html>
