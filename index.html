<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KalamOps - Agency OS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    /* Base Styles */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Modern UI Components */
    .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    .glass-card { background: #ffffff; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s ease; }
    .glass-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.1); border-color: #818cf8; }

    /* Inputs & Buttons */
    .input-field { @apply w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-white text-slate-700; }
    .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl text-sm px-6 py-3 transition-all shadow-lg active:scale-95 flex justify-center items-center gap-2; }
    .btn-secondary { @apply bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold rounded-xl text-sm px-5 py-2.5 transition-all active:scale-95; }

    /* Sidebar Active States */
    .sub-item-main.active { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%) !important; color: white !important; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); border: none; }
    .sub-item-main:not(.active):hover { background-color: #f1f5f9; transform: translateX(3px); }
    .sub-item-main.active .sub-name { color: white !important; }
  </style>
</head>

<body class="h-screen overflow-hidden text-slate-800">

<div id="globalLoader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-50 text-indigo-600">
    <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
    <p class="text-xs font-bold tracking-widest uppercase text-slate-400 animate-pulse">Initializing System...</p>
</div>

<div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] hidden transition-all duration-300">
  <div class="flex items-center gap-3 px-6 py-3.5 rounded-full bg-slate-900/90 text-white shadow-2xl backdrop-blur-md">
    <span id="toastIcon">‚úÖ</span>
    <span id="toastText" class="font-medium text-sm">Action Successful</span>
  </div>
</div>

<div id="authContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-100 hidden">
  <div class="fade-in w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
    
    <div class="p-8 text-center bg-slate-50 border-b border-slate-100">
        <div class="inline-flex h-16 w-16 rounded-2xl bg-indigo-600 shadow-xl shadow-indigo-200 items-center justify-center text-3xl mb-4 text-white">üöÄ</div>
        <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">KalamOps</h1>
        <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mt-1">Agency Operating System</p>
    </div>

    <div class="p-8">
      <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
          <button onclick="setAuthMode('login')" id="tabLogin" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all">Sign In</button>
          <button onclick="setAuthMode('register')" id="tabRegister" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">Register Agency</button>
      </div>

      <div class="space-y-4">
        <div>
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">Agency Workspace</label>
            <div class="relative">
                <span class="absolute left-4 top-3 text-slate-400">üè¢</span>
                <input id="authWs" class="input-field pl-10" placeholder="e.g. BranhamCo" />
            </div>
        </div>
        <div>
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">Username</label>
            <div class="relative">
                <span class="absolute left-4 top-3 text-slate-400">üë§</span>
                <input id="authUser" class="input-field pl-10" placeholder="admin" />
            </div>
        </div>
        <div>
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">Password</label>
            <div class="relative">
                <span class="absolute left-4 top-3 text-slate-400">üîí</span>
                <input id="authPass" type="password" class="input-field pl-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
        </div>
        
        <div id="regFields" class="hidden animate-pulse">
            <div class="p-3 bg-indigo-50 rounded-xl text-xs text-indigo-700 font-medium border border-indigo-100">
                ‚ú® Creating a new Workspace. You will be the <b>Super Admin</b>.
            </div>
        </div>

        <button id="authBtn" class="btn-primary w-full mt-4 justify-center">Access Dashboard ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<div id="appInterface" class="hidden h-screen flex flex-col bg-slate-50">
    <header class="glass-panel sticky top-0 z-40 h-16 flex-none bg-white border-b border-slate-200">
      <div class="max-w-[1920px] mx-auto px-6 h-full flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-indigo-600 shadow-md flex items-center justify-center text-white font-bold text-lg">K</div>
          <div>
            <h1 class="text-sm font-extrabold text-slate-900 leading-none">KalamOps</h1>
            <div class="flex items-center gap-1.5 mt-0.5">
                <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                <p id="agencyDisplay" class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">...</p>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <input id="searchInput" type="text" class="hidden md:block w-64 input-field py-2 text-xs" placeholder="Search tasks...">
          <input type="hidden" id="filterSubaccount" value="" />

          <button id="newTaskBtn" style="display:none;" class="btn-primary py-2 px-4 text-xs h-9">
            <span>+</span> New Request
          </button>

          <div class="h-9 w-9 rounded-full bg-slate-200 border-2 border-white shadow-sm cursor-pointer overflow-hidden hover:ring-2 hover:ring-indigo-500 transition" id="logoutBtn" title="Logout">
            <img id="headerAvatar" class="w-full h-full object-cover" />
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden max-w-[1920px] mx-auto w-full px-6 py-6 gap-6">
      
      <aside class="w-72 flex-none flex flex-col gap-4 hidden lg:flex">
        <div class="bg-white border border-slate-200 rounded-3xl flex-1 flex flex-col overflow-hidden shadow-sm">
          <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
            <h2 class="font-bold text-xs text-slate-500 uppercase tracking-widest flex items-center gap-2">üìÇ Clients / Projects</h2>
            <button onclick="openAddClientModal()" class="text-[10px] font-bold bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 hover:border-indigo-200 rounded-lg px-2.5 py-1.5 transition shadow-sm">+ Add</button>
          </div>
          <div id="subList" class="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar"></div>
          
          <div id="adminPanelBtn" class="hidden border-t border-slate-100">
             <button onclick="openAgencySettings()" class="w-full p-4 flex items-center gap-3 hover:bg-slate-50 transition text-left group">
                <div class="h-8 w-8 rounded-lg bg-slate-100 text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 flex items-center justify-center transition">‚öôÔ∏è</div>
                <div>
                    <h4 class="font-bold text-xs text-slate-700 group-hover:text-indigo-700">Agency Settings</h4>
                    <p class="text-[9px] text-slate-400">Team & Pipeline</p>
                </div>
             </button>
          </div>
        </div>
        
        <div class="bg-white border border-slate-200 p-3 rounded-2xl flex items-center gap-3 shadow-sm">
          <img id="sidebarAvatar" class="h-10 w-10 rounded-full bg-slate-200" />
          <div class="min-w-0">
            <div id="userNameDisplay" class="font-bold text-sm text-slate-900 truncate">...</div>
            <div id="userRoleDisplay" class="text-[10px] uppercase font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full w-fit mt-0.5">...</div>
          </div>
        </div>
        <div class="text-center text-[10px] text-slate-300 py-1">System by <span class="font-bold text-slate-400">Abdul Kalam</span></div>
      </aside>

      <section class="flex-1 h-full overflow-x-auto overflow-y-hidden pb-2">
        <div id="board" class="h-full flex gap-6 min-w-max px-1"></div>
      </section>
    </div>
</div>

<div id="addClientModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="fade-in w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 border border-white">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-indigo-50 flex items-center justify-center text-xl">üè¢</div>
            <div>
                <h3 class="font-bold text-lg text-slate-800">Add Client</h3>
                <p class="text-xs text-slate-500">Create a new workspace bucket.</p>
            </div>
        </div>
        <button onclick="$('addClientModal').classList.add('hidden')" class="text-slate-400 hover:text-rose-500 transition">‚úï</button>
    </div>
    
    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Client Name</label>
    <input id="newClientInput" class="input-field" placeholder="e.g. Acme Solar Inc." />
    
    <div class="mt-6 flex justify-end gap-2">
      <button onclick="$('addClientModal').classList.add('hidden')" class="btn-secondary">Cancel</button>
      <button onclick="saveNewClient()" class="btn-primary">Create Client</button>
    </div>
  </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="fade-in w-full max-w-2xl bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
      <h3 class="font-bold text-lg text-slate-900">New Request</h3>
      <button onclick="$('taskModal').classList.add('hidden')" class="text-slate-400 hover:text-rose-500 transition">‚úï</button>
    </div>
    <div class="p-6 overflow-y-auto space-y-5">
      <input id="tTitle" class="input-field text-lg font-bold placeholder-slate-400 border-none px-0 focus:ring-0 bg-transparent" placeholder="Task Title..." />
      
      <div class="grid grid-cols-2 gap-4">
          <div><label class="text-[10px] font-bold text-slate-400 uppercase">Client</label><select id="tSub" class="input-field mt-1"></select></div>
          <div><label class="text-[10px] font-bold text-slate-400 uppercase">Assignee</label><select id="tAssignee" class="input-field mt-1"></select></div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
          <div><label class="text-[10px] font-bold text-slate-400 uppercase">Priority</label><select id="tPriority" class="input-field mt-1"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High üî•</option></select></div>
          <div><label class="text-[10px] font-bold text-slate-400 uppercase">Due Date</label><input type="date" id="tDate" class="input-field mt-1" /></div>
      </div>

      <div>
         <label class="text-[10px] font-bold text-slate-400 uppercase">Attachment (Img/PDF)</label>
         <div class="mt-1">
             <input type="file" id="tFile" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
         </div>
         <div id="uploadContainer" class="hidden mt-2">
            <div class="flex justify-between text-[10px] font-bold text-indigo-600 mb-1">
                <span>Uploading...</span>
                <span id="uploadPct">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-1.5">
                <div id="uploadBar" class="bg-indigo-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
         </div>
      </div>

      <div><label class="text-[10px] font-bold text-slate-400 uppercase">Description</label><textarea id="tDetails" rows="4" class="input-field mt-1 resize-none" placeholder="What needs to be done?"></textarea></div>
    </div>
    <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
      <button onclick="$('taskModal').classList.add('hidden')" class="btn-secondary">Cancel</button>
      <button id="createTaskBtn" class="btn-primary">Create Task</button>
    </div>
  </div>
</div>

<div id="agencyModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-md p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
    <div class="fade-in w-full max-w-4xl h-[80vh] bg-white rounded-2xl shadow-2xl flex overflow-hidden">
        <div class="w-64 bg-slate-50 border-r border-slate-200 p-6 flex flex-col gap-2">
            <h2 class="font-bold text-lg text-slate-800 mb-4 px-2">Admin Settings</h2>
            <button onclick="switchTab('tabTeam')" class="text-left px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition">üë• Team</button>
            <button onclick="switchTab('tabPipeline')" class="text-left px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition">üìä Pipeline</button>
        </div>
        <div class="flex-1 p-8 overflow-y-auto bg-white">
            <div id="tabTeam" class="settings-tab">
                <h3 class="font-bold text-xl text-slate-800 mb-2">Team Management</h3>
                <div class="flex gap-2 mb-6">
                    <input id="newMemberName" class="input-field flex-1" placeholder="Name (e.g. Kalam)">
                    <select id="newMemberRole" class="input-field w-40"><option value="expert">Expert</option><option value="manager">Manager</option><option value="client">Client</option></select>
                    <button onclick="addTeamMember()" class="btn-primary px-4">Add</button>
                </div>
                <div id="teamList" class="space-y-2"></div>
            </div>
            <div id="tabPipeline" class="settings-tab hidden">
                <h3 class="font-bold text-xl text-slate-800 mb-2">Pipeline Stages</h3>
                <div id="stageList" class="space-y-3 mb-6"></div>
                <button onclick="addStage()" class="w-full py-3 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 font-bold hover:border-indigo-300 hover:text-indigo-600 transition">+ Add Stage</button>
                <div class="mt-6 flex justify-end"><button onclick="savePipeline()" class="btn-primary">Save Changes</button></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- UTILS ---
const $ = (id) => document.getElementById(id);
const showToast = (msg, icon='‚úÖ') => { 
    $("toastText").textContent = msg; $("toastIcon").textContent = icon;
    $("toast").classList.remove('hidden'); setTimeout(() => $("toast").classList.add('hidden'), 3000); 
};
const getAvatar = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&bold=true`;

// --- FIREBASE CONFIG (REPLACE WITH YOURS) ---
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a"
};
if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// --- STATE ---
let USER=null, ROLE=null, AGENCY_ID=null;
let pipelineStages = [];
let teamMembers = [];
let authMode = "login";

const DEFAULT_STAGES = [
    {id: 'req', label: 'Requested', color: 'bg-sky-500'},
    {id: 'prog', label: 'In Progress', color: 'bg-indigo-500'},
    {id: 'rev', label: 'Review', color: 'bg-purple-500'},
    {id: 'done', label: 'Done', color: 'bg-emerald-500'}
];

// --- AUTH HANDLERS ---
function setAuthMode(mode) {
    authMode = mode;
    $("tabLogin").className = mode === 'login' ? 'flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all' : 'flex-1 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all';
    $("tabRegister").className = mode === 'register' ? 'flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all' : 'flex-1 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all';
    $("regFields").className = mode === 'register' ? 'block' : 'hidden';
    $("authBtn").textContent = mode === 'login' ? 'Access Dashboard ‚Üí' : 'Create New Agency';
}

$("authBtn").onclick = async () => {
    const ws = $("authWs").value.trim();
    const user = $("authUser").value.trim().toLowerCase();
    const pass = $("authPass").value;
    
    if(!ws || !user || !pass) return showToast("Please fill all fields", "‚ö†Ô∏è");
    
    const email = `${user}@${ws}.local`; // Virtual Email
    
    try {
        if(authMode === 'register') {
            const cred = await auth.createUserWithEmailAndPassword(email, pass);
            // Initialize Agency DB
            await db.collection("agencies").doc(ws).set({
                name: ws,
                owner: user,
                stages: DEFAULT_STAGES,
                members: [{name: user, role: 'owner'}]
            });
            showToast("Agency Created!");
        } else {
            await auth.signInWithEmailAndPassword(email, pass);
        }
    } catch(e) {
        showToast(e.message, "‚ùå");
    }
};

auth.onAuthStateChanged(u => {
    $("globalLoader").classList.add("hidden");
    if(u) {
        // Load App
        const parts = u.email.split('@');
        USER = parts[0];
        AGENCY_ID = parts[1].replace('.local','');
        
        $("authContainer").classList.add("hidden");
        $("appInterface").classList.remove("hidden");
        setTimeout(() => $("appInterface").classList.remove("opacity-0"), 50);
        
        $("agencyDisplay").textContent = AGENCY_ID;
        $("headerAvatar").src = getAvatar(USER);
        $("sidebarAvatar").src = getAvatar(USER);
        $("userNameDisplay").textContent = USER;
        
        loadAgencyData();
    } else {
        $("appInterface").classList.add("hidden");
        $("authContainer").classList.remove("hidden");
    }
});

// --- DATA LOGIC ---
function loadAgencyData() {
    // 1. Listen to Agency Config
    db.collection("agencies").doc(AGENCY_ID).onSnapshot(doc => {
        if(doc.exists) {
            const data = doc.data();
            pipelineStages = data.stages || DEFAULT_STAGES;
            teamMembers = data.members || [];
            
            const me = teamMembers.find(m => m.name === USER);
            ROLE = me ? me.role : 'client';
            $("userRoleDisplay").textContent = ROLE;
            
            if(ROLE === 'owner' || ROLE === 'admin') $("adminPanelBtn").classList.remove("hidden");
            if(ROLE !== 'client') $("newTaskBtn").style.display = "flex";
            
            renderBoard();
            renderTeamSettings();
            renderPipelineSettings();
        }
    });

    // 2. Listen to Subaccounts
    db.collection("agencies").doc(AGENCY_ID).collection("subaccounts").onSnapshot(snap => {
        const subs = snap.docs.map(d => ({id:d.id, ...d.data()}));
        renderSubList(subs);
    });

    // 3. Listen to Tasks
    db.collection("agencies").doc(AGENCY_ID).collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
        window.allTasks = snap.docs.map(d => ({id:d.id, ...d.data()}));
        renderBoard();
    });
}

// --- RENDERERS ---
function renderSubList(subs) {
    const list = $("subList"); list.innerHTML = "";
    const select = $("tSub"); select.innerHTML = "";
    
    subs.forEach(s => {
        const btn = document.createElement("button");
        btn.className = "sub-item-main w-full text-left px-4 py-3 rounded-xl text-xs font-bold text-slate-600 transition mb-1 flex items-center justify-between";
        btn.innerHTML = `<span class="sub-name">${s.name}</span>`;
        btn.onclick = () => {
            document.querySelectorAll(".sub-item-main").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");
            $("filterSubaccount").value = s.id;
            renderBoard();
        };
        list.appendChild(btn);
        
        const opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.name;
        select.appendChild(opt);
    });
}

function renderBoard() {
    const board = $("board"); board.innerHTML = "";
    const filter = $("filterSubaccount").value;
    const tasks = (window.allTasks || []).filter(t => !filter || t.subaccountId === filter);

    pipelineStages.forEach(stage => {
        const col = document.createElement("div");
        col.className = "w-80 shrink-0 flex flex-col h-full rounded-[1.5rem] bg-slate-100/50 border border-white shadow-inner";
        
        const stageTasks = tasks.filter(t => t.status === stage.id);
        
        col.innerHTML = `
            <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="h-2 w-2 rounded-full ${stage.color}"></div>
                    <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">${stage.label}</span>
                </div>
                <span class="text-[10px] font-bold bg-white px-2 py-0.5 rounded text-slate-400">${stageTasks.length}</span>
            </div>
            <div class="flex-1 overflow-y-auto px-3 pb-3 space-y-3" id="col_${stage.id}"></div>
        `;
        
        const zone = col.querySelector(`#col_${stage.id}`);
        stageTasks.forEach(t => {
            let fileIcon = "";
            if(t.attachmentUrl) {
                // PDF/Doc Logic
                const isImg = t.attachmentUrl.match(/\.(jpeg|jpg|gif|png)$/) != null;
                fileIcon = isImg ? 'üì∑' : 'üìÑ';
            }
            
            const card = document.createElement("div");
            card.className = "glass-card p-4 rounded-2xl cursor-pointer hover:border-indigo-400 group relative";
            card.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 uppercase">${t.priority}</span>
                    ${fileIcon ? `<span class="text-xs">${fileIcon}</span>` : ''}
                </div>
                <h4 class="font-bold text-sm text-slate-800 leading-snug">${t.title}</h4>
                <div class="mt-3 flex items-center justify-between pt-2 border-t border-slate-50">
                    <span class="text-[10px] text-slate-400 font-medium">
                        ${t.dueDate ? 'üìÖ '+new Date(t.dueDate).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : new Date(t.createdAt?.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                    </span>
                    <div class="h-5 w-5 rounded-full overflow-hidden bg-slate-200">
                        <img src="${getAvatar(t.assigneeUsername || '?')}" />
                    </div>
                </div>
            `;
            zone.appendChild(card);
        });
        
        if(ROLE !== 'client') {
            new Sortable(zone, { group: 'shared', animation: 200, onEnd: (evt) => {
                // Update Status Logic
                const t = tasks.find(x => x.title === evt.item.querySelector('h4').textContent); // Simple find
                if(t) db.collection("agencies").doc(AGENCY_ID).collection("tasks").doc(t.id).update({status: stage.id});
            }});
        }
        board.appendChild(col);
    });
}

// --- ADD CLIENT LOGIC ---
function openAddClientModal() { $("addClientModal").classList.remove("hidden"); }
async function saveNewClient() {
    const name = $("newClientInput").value;
    if(!name) return showToast("Name required", "‚ö†Ô∏è");
    await db.collection("agencies").doc(AGENCY_ID).collection("subaccounts").add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
    $("addClientModal").classList.add("hidden");
    $("newClientInput").value = "";
    showToast("Client Added");
}

// --- TASK LOGIC (Fixed Upload) ---
$("newTaskBtn").onclick = () => $("taskModal").classList.remove("hidden");

$("createTaskBtn").onclick = async () => {
    const btn = $("createTaskBtn");
    btn.innerHTML = `<span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span> Creating...`; 
    btn.disabled = true;
    
    const file = $("tFile").files[0];
    let attachmentUrl = "";
    
    if(file) {
        $("uploadContainer").classList.remove("hidden");
        const ref = storage.ref(`agencies/${AGENCY_ID}/${Date.now()}_${file.name}`);
        const task = ref.put(file);
        
        await new Promise((resolve, reject) => {
            task.on('state_changed', 
                (snap) => {
                    const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
                    $("uploadBar").style.width = pct + "%";
                    $("uploadPct").textContent = Math.round(pct) + "%";
                },
                (err) => { showToast("Upload Failed", "‚ùå"); btn.disabled=false; reject(err); },
                async () => { attachmentUrl = await task.snapshot.ref.getDownloadURL(); resolve(); }
            );
        });
    }
    
    await db.collection("agencies").doc(AGENCY_ID).collection("tasks").add({
        title: $("tTitle").value,
        subaccountId: $("tSub").value,
        assigneeUsername: $("tAssignee").value,
        priority: $("tPriority").value,
        dueDate: $("tDate").value,
        details: $("tDetails").value,
        status: pipelineStages[0].id,
        attachmentUrl,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    $("taskModal").classList.add("hidden");
    btn.textContent = "Create Task"; btn.disabled = false;
    $("uploadContainer").classList.add("hidden"); $("uploadBar").style.width = "0%"; $("tTitle").value = "";
    showToast("Task Created");
};

// --- SETTINGS LOGIC ---
function renderTeamSettings() {
    const list = $("teamList"); list.innerHTML = "";
    const sel = $("tAssignee"); sel.innerHTML = "";
    
    teamMembers.forEach((m, i) => {
        list.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg mb-2"><span class="text-sm font-bold text-slate-700">${m.name} <span class="text-[10px] text-slate-400 uppercase ml-2">${m.role}</span></span><button onclick="removeMember(${i})" class="text-rose-500 text-xs">Remove</button></div>`;
        if(m.role !== 'client') sel.innerHTML += `<option value="${m.name}">${m.name}</option>`;
    });
}
async function addTeamMember() {
    const name = $("newMemberName").value;
    const role = $("newMemberRole").value;
    if(name) {
        await db.collection("agencies").doc(AGENCY_ID).update({members: [...teamMembers, {name, role}]});
        $("newMemberName").value = "";
    }
}
async function removeMember(idx) {
    if(confirm("Remove?")) {
        const newM = [...teamMembers]; newM.splice(idx, 1);
        await db.collection("agencies").doc(AGENCY_ID).update({members: newM});
    }
}

// Pipeline
function renderPipelineSettings() {
    const list = $("stageList"); list.innerHTML = "";
    pipelineStages.forEach((s, i) => {
        list.innerHTML += `<div class="flex gap-2 mb-2"><div class="w-6 h-6 rounded ${s.color}"></div><input class="flex-1 input-field py-1" value="${s.label}" onchange="updateStage(${i}, this.value)"><button onclick="removeStage(${i})" class="text-rose-500">‚úï</button></div>`;
    });
}
function updateStage(i, val) { pipelineStages[i].label = val; }
function removeStage(i) { pipelineStages.splice(i, 1); renderPipelineSettings(); }
function addStage() { pipelineStages.push({id: 'stg_'+Date.now(), label:'New', color:'bg-slate-400'}); renderPipelineSettings(); }
async function savePipeline() { await db.collection("agencies").doc(AGENCY_ID).update({stages: pipelineStages}); showToast("Pipeline Saved"); }

function openAgencySettings() { $("agencyModal").classList.remove("hidden"); renderTeamSettings(); renderPipelineSettings(); }
function switchTab(t) { document.querySelectorAll(".settings-tab").forEach(e=>e.classList.add("hidden")); $(t).classList.remove("hidden"); }

$("logoutBtn").onclick = () => auth.signOut();
</script>
</body>
</html>
