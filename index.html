<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subaccount Change Tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    ::-webkit-scrollbar{ width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); border-radius: 999px; }
    ::-webkit-scrollbar-track{ background: transparent; }

    .fade-in { animation: fadeIn .18s ease-out both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px) scale(.99);} to {opacity:1; transform:none;} }

    .toast-in { animation: toastIn .18s ease-out both; }
    @keyframes toastIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform:none;} }

    .glass { backdrop-filter: blur(10px); }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 10px 30px rgba(2, 6, 23, .08)",
            lift: "0 18px 45px rgba(2, 6, 23, .14)"
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen text-slate-900 bg-[radial-gradient(1200px_600px_at_20%_0%,rgba(99,102,241,.10),transparent_55%),radial-gradient(900px_500px_at_85%_10%,rgba(168,85,247,.10),transparent_50%),linear-gradient(to_bottom,rgba(248,250,252,1),rgba(241,245,249,1))]">

<!-- ===================== TOAST ===================== -->
<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] hidden">
  <div class="toast-in rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm shadow-soft flex items-center gap-2">
    <span id="toastText">Saved</span>
  </div>
</div>

<!-- ===================== AUTH MODAL (UPDATED: FULL CONTENT) ===================== -->
<div id="authModal" class="fixed inset-0 z-50 bg-black/40 glass flex items-center justify-center p-4">
  <div class="fade-in w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-5 border-b border-slate-100">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
        <div class="min-w-0">
          <div class="font-extrabold leading-tight">Subaccount Change Tracker</div>
          <div class="text-xs text-slate-500">Login/Register (workspace-based)</div>
        </div>
      </div>
    </div>

    <div class="p-5 space-y-3">
      <div>
        <label class="text-xs font-semibold text-slate-600">Workspace</label>
        <input id="wsInput" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., romatech" autocomplete="off" />
        <div class="mt-1 text-[11px] text-slate-500">Workspace controls data separation (Firestore path).</div>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Username</label>
        <input id="usernameInput" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul" autocomplete="username" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Password</label>
        <input id="passwordInput" type="password"
          class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="Min 6 characters" autocomplete="current-password" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Role</label>
        <select id="roleInput"
          class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
          <option value="builder">builder (Admin)</option>
          <option value="ghl_expert">ghl_expert</option>
          <option value="client">client</option>
        </select>
        <div class="mt-1 text-[11px] text-slate-500">
          Builder can add subaccounts & create tasks. Expert can move tasks. Client can approve only in Client Review.
        </div>
      </div>

      <div id="authMsg" class="text-sm text-rose-600 hidden"></div>

      <div class="pt-1 flex gap-2">
        <button id="loginBtn"
          class="flex-1 rounded-2xl bg-slate-900 text-white px-4 py-2.5 text-sm font-bold hover:bg-slate-800 active:scale-[.99] transition">
          Login
        </button>
        <button id="registerBtn"
          class="flex-1 rounded-2xl bg-indigo-600 text-white px-4 py-2.5 text-sm font-bold hover:bg-indigo-700 active:scale-[.99] transition">
          Register
        </button>
      </div>

      <div class="text-xs text-slate-500">
        Tip: If you deploy on Vercel/Netlify, ensure your domain is added in Firebase Auth â†’ Authorized domains.
      </div>
    </div>
  </div>
</div>

<!-- ===================== HEADER ===================== -->
<header class="sticky top-0 z-40 border-b border-slate-200/70 bg-white/70 glass">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-500 shadow-soft"></div>
      <div class="min-w-0">
        <h1 class="text-base font-extrabold leading-tight truncate">Subaccount Change Tracker</h1>
        <p class="text-xs text-slate-500 truncate">Requested â†’ Clarification â†’ In Progress â†’ Client Review â†’ Done</p>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div class="relative hidden lg:block">
        <input id="searchInput" type="text" placeholder="Search tasks, users, notesâ€¦"
          class="w-[360px] rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
        <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">âŒ˜K</div>
      </div>

      <select id="filterSubaccount"
        class="rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300">
        <option value="">All</option>
      </select>

      <button id="newTaskBtn"
        class="rounded-2xl bg-indigo-600 px-4 py-2.5 text-sm font-bold text-white shadow-soft hover:bg-indigo-700 active:scale-[.99] transition">
        + Task
      </button>

      <div class="relative">
        <button id="notifBtn"
          class="rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition flex items-center gap-2">
          ðŸ”” <span id="notifCount" class="hidden text-xs font-bold px-2 py-0.5 rounded-full bg-rose-600 text-white">0</span>
        </button>

        <div id="notifPanel" class="hidden absolute right-0 mt-2 w-[380px] max-w-[92vw] rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
          <div class="p-3 border-b border-slate-100 flex items-center justify-between">
            <div class="font-semibold">Notifications</div>
            <button id="markAllReadBtn" class="text-xs font-semibold px-2 py-1 rounded-2xl border border-slate-200 hover:bg-slate-50">
              Mark all read
            </button>
          </div>
          <div id="notifList" class="max-h-[380px] overflow-auto bg-slate-50 p-2 space-y-2"></div>
          <div class="p-2 border-t border-slate-100 bg-white text-xs text-slate-500">
            In-app notifications (reliable). Push notifications need FCM later.
          </div>
        </div>
      </div>

      <button id="logoutBtn"
        class="rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
        Logout
      </button>

      <div class="hidden xl:block text-sm text-slate-600 whitespace-nowrap">
        <span id="userBadge" class="font-semibold"></span>
        <span id="wsBadge" class="text-slate-400"></span>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 pb-4 lg:hidden">
    <input id="searchInputMobile" type="text" placeholder="Search tasksâ€¦"
      class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />
  </div>
</header>

<!-- ===================== MAIN ===================== -->
<main class="max-w-7xl mx-auto px-5 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- SIDEBAR -->
    <aside class="lg:col-span-3">
      <div class="rounded-3xl bg-white border border-slate-100 shadow-soft overflow-hidden">
        <div class="p-4 flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Subaccounts</h2>
            <p class="text-xs text-slate-500">Click to filter</p>
          </div>
          <button id="addSubBtn"
            class="rounded-2xl border border-slate-200 px-3 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
            + Add
          </button>
        </div>

        <div id="subList" class="px-3 pb-3 space-y-1"></div>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
          <div class="rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-600">
            Tip: Client can approve only in <b>Client Review</b>.
          </div>
        </div>
      </div>
    </aside>

    <!-- BOARD (UPDATED: horizontal scroll friendly) -->
    <section class="lg:col-span-9">
      <div class="overflow-x-auto pb-2">
        <div id="board" class="min-w-max grid grid-flow-col auto-cols-max gap-4"></div>
      </div>
    </section>

  </div>
</main>

<!-- ===================== SUB MODAL ===================== -->
<div id="subModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-lg rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">Add Subaccount</h3>
        <p class="text-sm text-slate-500">Example: VIP Tires - Ohio</p>
      </div>
      <button id="closeSubModalBtn" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="p-4">
      <label class="text-xs font-semibold text-slate-600">Subaccount name</label>
      <input id="subNameInput"
        class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
        placeholder="Type subaccount name..." />

      <div id="subErr" class="mt-2 text-sm text-rose-600 hidden"></div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="cancelSubBtn" class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">
          Cancel
        </button>
        <button id="saveSubBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== TASK MODAL ===================== -->
<div id="taskModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-2xl rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-center justify-between">
      <div>
        <h3 class="font-semibold">New Task</h3>
        <p class="text-sm text-slate-500">Log a client change request</p>
      </div>
      <button id="closeTaskModal" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Title</label>
        <input id="tTitle" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., Remove promo messages after appointment booked" />
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Subaccount</label>
        <select id="tSub" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>
      </div>

      <div>
        <label class="text-xs font-semibold text-slate-600">Assignee (username)</label>
        <input id="tAssignee" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="e.g., abdul" />
      </div>

      <div class="md:col-span-2">
        <label class="text-xs font-semibold text-slate-600">Details</label>
        <textarea id="tDetails" rows="4" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
          placeholder="Paste the client message + what to change..."></textarea>
      </div>

      <div id="taskErr" class="md:col-span-2 text-sm text-rose-600 hidden"></div>

      <div class="md:col-span-2 flex items-center justify-end gap-2">
        <button id="cancelTaskBtn" class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 active:scale-[.99] transition">Cancel</button>
        <button id="createTaskBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 active:scale-[.99] transition">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== DETAILS MODAL ===================== -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 glass p-4">
  <div class="fade-in w-full max-w-5xl rounded-3xl bg-white border border-slate-200 shadow-lift overflow-hidden">
    <div class="p-4 border-b border-slate-100 flex items-start justify-between gap-3">
      <div class="min-w-0">
        <h3 id="dTitle" class="font-semibold text-lg truncate">Task</h3>
        <p id="dMeta" class="text-sm text-slate-500 truncate">â€”</p>
      </div>
      <button id="closeDetailsModal" class="p-2 rounded-2xl hover:bg-slate-100">âœ•</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12">
      <!-- Left -->
      <div class="lg:col-span-4 border-b lg:border-b-0 lg:border-r border-slate-100 p-4 bg-slate-50">
        <div class="space-y-3">
          <div class="rounded-3xl bg-white border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-500">Status</div>
            <select id="dStatus" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>

            <div class="mt-3 text-xs font-semibold text-slate-500">Subaccount</div>
            <select id="dSub" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></select>

            <div class="mt-3 text-xs font-semibold text-slate-500">Assignee</div>
            <input id="dAssignee" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300" />

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="btnClarify" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">Clarify</button>
              <button id="btnProgress" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition">In Progress</button>
              <button id="btnReview" class="rounded-2xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800 transition col-span-2">Send to Review</button>
              <button id="btnDone" class="rounded-2xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition col-span-2">Mark Done</button>
            </div>

            <div id="clientControls" class="hidden mt-3 grid grid-cols-2 gap-2">
              <button id="btnApprove" class="rounded-2xl bg-emerald-600 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-700 transition col-span-2">Approve Done âœ…</button>
              <button id="btnChanges" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50 transition col-span-2">Request Changes</button>
            </div>

            <button id="saveTaskBtn" class="mt-3 w-full rounded-2xl bg-indigo-600 text-white px-3 py-2 text-sm font-semibold hover:bg-indigo-700 transition">Save Changes</button>
          </div>

          <div class="rounded-3xl bg-white border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-500">Details</div>
            <textarea id="dDetails" rows="7" class="mt-2 w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"></textarea>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="lg:col-span-8 p-4">
        <div class="rounded-3xl border border-slate-200 overflow-hidden bg-white">
          <div class="p-3 border-b border-slate-100 flex items-center justify-between">
            <div>
              <div class="font-semibold">Conversation</div>
              <div class="text-sm text-slate-500">Clean thread, easy for client</div>
            </div>
          </div>

          <div id="thread" class="p-3 space-y-2 max-h-[520px] overflow-auto bg-slate-50"></div>

          <div class="p-3 border-t border-slate-100 bg-white">
            <div class="flex gap-2">
              <input id="msgInput" class="flex-1 rounded-2xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-300"
                placeholder="Write an update..." />
              <button id="sendMsgBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm font-semibold hover:bg-indigo-700 transition">Send</button>
            </div>
            <div class="mt-2 text-xs text-slate-500">Press Enter to send.</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
/* =========================================================
   FIREBASE INIT
========================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================================================
   HELPERS
========================================================= */
const $ = id => document.getElementById(id);
const clean = v => (v || "").trim();
const nowISO = () => new Date().toISOString();

function escapeHtml(str){
  return (str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   STATE
========================================================= */
let WS=null, USER=null, ROLE=null, UID=null;
let subaccounts=[], tasks=[], notifications=[];
let currentTaskId=null;

const STATUS = [
  {id:"requested", label:"Requested"},
  {id:"clarify", label:"Clarification"},
  {id:"progress", label:"In Progress"},
  {id:"review", label:"Client Review"},
  {id:"done", label:"Done"}
];

const isBuilder = () => ROLE==="builder";
const isExpert  = () => ROLE==="ghl_expert";
const isClient  = () => ROLE==="client";
const canCreate = () => isBuilder();
const canMove   = () => isBuilder() || isExpert();
const canApprove= () => isClient();

/* =========================================================
   FIRESTORE REFS
========================================================= */
const wsDoc   = () => db.collection("workspaces").doc(WS);
const usersRef= () => wsDoc().collection("users");
const subRef  = () => wsDoc().collection("subaccounts");
const taskRef = () => wsDoc().collection("tasks");
const notifRef= () => wsDoc().collection("notifications");

/* =========================================================
   SESSION
========================================================= */
const SESSION_KEY="sct_session_v1";

function saveSession(){
  localStorage.setItem(SESSION_KEY, JSON.stringify({WS,USER,ROLE}));
}
function loadSession(){
  try{ return JSON.parse(localStorage.getItem(SESSION_KEY)); }
  catch{ return null; }
}
function clearSession(){
  localStorage.removeItem(SESSION_KEY);
}

/* =========================================================
   AUTH
========================================================= */
const makeEmail=(u,w)=>`${u.toLowerCase()}@${w.toLowerCase()}.local`;

async function doLogin(){
  const ws=clean(wsInput.value);
  const u =clean(usernameInput.value).toLowerCase();
  const p =passwordInput.value;
  if(!ws||!u||!p) return showAuthErr("All fields required");

  try{
    const cred=await auth.signInWithEmailAndPassword(makeEmail(u,ws),p);
    await afterAuth(ws,u,roleInput.value,cred.user.uid);
  }catch(e){ showAuthErr(e.message); }
}

async function doRegister(){
  const ws=clean(wsInput.value);
  const u =clean(usernameInput.value).toLowerCase();
  const p =passwordInput.value;
  if(p.length<6) return showAuthErr("Min 6 chars");

  try{
    const cred=await auth.createUserWithEmailAndPassword(makeEmail(u,ws),p);
    await afterAuth(ws,u,roleInput.value,cred.user.uid);
  }catch(e){ showAuthErr(e.message); }
}

async function afterAuth(ws,u,r,uid){
  WS=ws; USER=u; ROLE=r; UID=uid;
  saveSession();

  await usersRef().doc(uid).set({
    username:u, role:r,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  authModal.classList.add("hidden");
  userBadge.textContent=`${USER} (${ROLE})`;
  wsBadge.textContent=` â€¢ ${WS}`;

  addSubBtn.style.display= isBuilder()?"inline-flex":"none";
  newTaskBtn.style.display= canCreate()?"inline-flex":"none";

  dStatus.innerHTML=STATUS.map(s=>`<option value="${s.id}">${s.label}</option>`).join("");
  bindRealtime();
  showToast("Welcome");
}

function showAuthErr(m){
  authMsg.textContent=m;
  authMsg.classList.remove("hidden");
}

/* =========================================================
   REALTIME
========================================================= */
let unsubA=null,unsubT=null,unsubN=null;

function bindRealtime(){
  unsubA?.(); unsubT?.(); unsubN?.();

  unsubA=subRef().onSnapshot(s=>{
    subaccounts=s.docs.map(d=>({id:d.id,...d.data()}));
    renderSubaccounts(); renderBoard();
  });

  unsubT=taskRef().onSnapshot(s=>{
    tasks=s.docs.map(d=>({id:d.id,...d.data()}));
    renderSubaccounts(); renderBoard();
    if(currentTaskId){
      const t=tasks.find(x=>x.id===currentTaskId);
      if(t) renderDetails(t);
    }
  });

  unsubN=notifRef()
    .where("toUsername","==",USER)
    .orderBy("createdAt","desc")
    .onSnapshot(s=>{
      notifications=s.docs.map(d=>({id:d.id,...d.data()}));
      renderNotifications();
    });
}

/* =========================================================
   NOTIFICATIONS (CORE)
========================================================= */
async function createNotification(to,title,body,taskId=null){
  if(!to||to===USER) return;
  await notifRef().add({
    toUsername:to,
    title, body,
    taskId,
    read:false,
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    createdAtText:new Date().toLocaleString()
  });
}

function renderNotifications(){
  notifList.innerHTML="";
  const unread=notifications.filter(n=>!n.read).length;
  notifCount.textContent=unread;
  notifCount.classList.toggle("hidden",unread===0);

  if(!notifications.length){
    notifList.innerHTML=`<div class="p-3 text-sm text-slate-500">No notifications yet.</div>`;
    return;
  }

  notifications.forEach(n=>{
    const btn=document.createElement("button");
    btn.className=`w-full text-left rounded-2xl p-3 border ${n.read?"bg-white":"bg-indigo-50 border-indigo-200"}`;
    btn.innerHTML=`
      <div class="font-semibold">${escapeHtml(n.title)}</div>
      <div class="text-xs text-slate-600 mt-1">${escapeHtml(n.body)}</div>
      <div class="text-[11px] text-slate-400 mt-1">${n.createdAtText}</div>
    `;
    btn.onclick=async()=>{
      if(!n.read) await notifRef().doc(n.id).update({read:true});
      if(n.taskId) openDetails(n.taskId);
    };
    notifList.appendChild(btn);
  });
}

/* =========================================================
   TASK CREATION
========================================================= */
async function createTask(){
  const title=clean(tTitle.value);
  const details=clean(tDetails.value);
  const assignee=clean(tAssignee.value).toLowerCase();
  const subId=tSub.value;
  if(!title||!assignee) return;

  const ref=await taskRef().add({
    title,details,
    subaccountId:subId,
    status:"requested",
    createdByUsername:USER,
    assigneeUsername:assignee,
    messages:[{by:USER,role:ROLE,text:"Task created",at:nowISO()}],
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await createNotification(
    assignee,
    "New task assigned",
    `Task: "${title}"\nAssigned by ${USER}`,
    ref.id
  );

  showToast("Task created");
}

/* =========================================================
   COMMENTS / STATUS UPDATES
========================================================= */
async function sendMessage(){
  const text=clean(msgInput.value);
  if(!text||!currentTaskId) return;

  msgInput.value="";
  const t=tasks.find(x=>x.id===currentTaskId);

  await taskRef().doc(currentTaskId).update({
    messages:firebase.firestore.FieldValue.arrayUnion({
      by:USER,role:ROLE,text,at:nowISO()
    })
  });

  if(t?.assigneeUsername)
    await createNotification(t.assigneeUsername,"New comment",text,currentTaskId);
  if(t?.createdByUsername)
    await createNotification(t.createdByUsername,"New comment",text,currentTaskId);
}

async function saveTask(){
  const t=tasks.find(x=>x.id===currentTaskId);
  if(!t) return;

  const newStatus=dStatus.value;
  const newAssignee=dAssignee.value.toLowerCase();

  await taskRef().doc(currentTaskId).update({
    status:newStatus,
    assigneeUsername:newAssignee
  });

  if(t.createdByUsername)
    await createNotification(
      t.createdByUsername,
      "Task updated",
      `Status â†’ ${newStatus}\nBy ${USER}`,
      currentTaskId
    );

  if(newAssignee!==t.assigneeUsername)
    await createNotification(
      newAssignee,
      "Task assigned to you",
      `Task: ${t.title}`,
      currentTaskId
    );

  showToast("Saved");
}

/* =========================================================
   EVENTS
========================================================= */
loginBtn.onclick=doLogin;
registerBtn.onclick=doRegister;
sendMsgBtn.onclick=sendMessage;
saveTaskBtn.onclick=saveTask;

logoutBtn.onclick=async()=>{
  await auth.signOut();
  clearSession();
  location.reload();
};

/* =========================================================
   BOOT
========================================================= */
auth.onAuthStateChanged(user=>{
  const sess=loadSession();
  if(user&&sess){
    WS=sess.WS; USER=sess.USER; ROLE=sess.ROLE; UID=user.uid;
    authModal.classList.add("hidden");
    bindRealtime();
  }
});
<script/>
</body>
</html>

