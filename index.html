<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agency Task Tracker (Branham & Co)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    /* --- Typography & Base --- */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    
    /* --- Custom Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }

    /* --- Animations --- */
    .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    @keyframes fadeInUp { 
      from { opacity: 0; transform: translateY(20px) scale(0.98); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- Animated Background --- */
    @keyframes bgPulse {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .animated-bg {
        background-size: 200% 200%;
        animation: bgPulse 15s ease infinite;
    }

    /* --- Glassmorphism --- */
    .glass-panel {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
    }
    
    .glass-card {
      background: #ffffff;
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.15);
      border-color: #818cf8;
    }

    /* --- Sidebar Item Logic --- */
    .sub-item-container { transition: all 0.2s; }

    /* Active State (Selected for filtering) */
    .sub-item-main.active {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        border: none;
    }

    /* Hover State */
    .sub-item-main:not(.active):hover { background-color: #f8fafc; transform: translateX(2px); }

    /* Inner Text Colors - Forced White when active */
    .sub-item-main.active .sub-name { color: white !important; }
    .sub-item-main.active .sub-count { background-color: white !important; color: #4f46e5 !important; }
    .sub-item-main.active .sub-arrow { color: rgba(255,255,255,0.6) !important; }

    /* Settings Gear Icon */
    .settings-btn { opacity: 0.4; transition: all 0.2s; }
    .sub-item-container:hover .settings-btn { opacity: 1; }
    .settings-btn:hover { background-color: #e2e8f0; color: #4f46e5; transform: rotate(30deg); }

    /* Drag & Drop */
    .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; transform: scale(0.95); }
    .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.05) rotate(2deg); z-index: 50; }
  </style>
</head>

<body class="min-h-screen text-slate-800 bg-gradient-to-br from-indigo-50 via-slate-50 to-purple-50 animated-bg selection:bg-indigo-100 selection:text-indigo-700 overflow-hidden">

<div id="globalLoader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-50 text-indigo-600 transition-opacity duration-500">
    <svg class="animate-spin h-10 w-10 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-sm font-bold tracking-widest uppercase text-slate-400">Loading System...</p>
</div>

<div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] hidden">
  <div class="fade-in-up flex items-center gap-3 px-6 py-3.5 rounded-full bg-slate-900/90 text-white shadow-2xl backdrop-blur-md">
    <div class="bg-emerald-500 rounded-full p-1"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
    <span id="toastText" class="font-medium text-sm tracking-wide">Action Successful</span>
  </div>
</div>

<div id="authContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-xl hidden">
  <div class="fade-in-up w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border border-white/50 relative">
    <div class="h-32 bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
        <div class="text-white text-center z-10">
            <div class="text-4xl mb-1">üöÄ</div>
            <h2 class="font-bold text-lg tracking-wide" id="authTitle">Welcome Back</h2>
        </div>
    </div>
    <div class="p-8 pt-6 space-y-4">
      <div class="space-y-1">
        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Workspace</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div>
            <input id="wsInput" class="w-full pl-10 bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 block p-3 outline-none transition-all" placeholder="e.g. BranhamCo">
        </div>
      </div>
      <div class="space-y-1">
        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Username</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
            <input id="usernameInput" class="w-full pl-10 bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 block p-3 outline-none transition-all" placeholder="e.g. branham" autocomplete="username">
        </div>
      </div>
      <div class="space-y-1">
        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Password</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
            <input id="passwordInput" type="password" class="w-full pl-10 bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 block p-3 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
      </div>
      <div id="roleField" class="space-y-1 hidden">
        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Role</label>
        <select id="roleInput" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 block p-3 outline-none transition-all">
          <option value="client">Agency Owner (Branham)</option>
          <option value="ghl_expert">GHL Expert</option>
          <option value="builder">Builder (Admin)</option>
        </select>
      </div>
      <div id="authMsg" class="hidden p-3 rounded-xl bg-rose-50 text-rose-600 text-xs font-bold text-center border border-rose-100"></div>
      <button id="authActionBtn" class="w-full text-white bg-slate-900 hover:bg-slate-800 focus:ring-4 focus:ring-slate-200 font-bold rounded-xl text-sm px-5 py-3.5 text-center transition-all shadow-lg active:scale-95 mt-2">Sign In</button>
      <div class="text-center pt-2">
          <button id="authToggleBtn" class="text-xs text-indigo-600 font-bold hover:underline">Don't have an account? Create one</button>
      </div>
    </div>
  </div>
</div>

<div id="appInterface" class="hidden opacity-0 transition-opacity duration-500">
    <header class="glass-panel sticky top-0 z-40">
      <div class="max-w-[1920px] mx-auto px-4 sm:px-6 h-18 flex items-center justify-between gap-4 h-16">
        <div class="flex items-center gap-3 pl-2">
          <div class="h-9 w-9 rounded-xl bg-indigo-600 shadow-md shadow-indigo-200 flex items-center justify-center text-white">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          </div>
          <div class="hidden md:block">
            <h1 class="text-sm font-extrabold text-slate-900 leading-none tracking-tight">TaskFlow</h1>
            <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5">Branham & Co</p>
          </div>
        </div>

        <div class="flex items-center gap-4 flex-1 justify-end">
          <div class="relative hidden md:block w-72 group">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input id="searchInput" type="text" class="block w-full p-2.5 pl-10 text-sm text-slate-700 border border-slate-200 rounded-xl bg-white/50 focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all placeholder-slate-400 shadow-sm" placeholder="Search tasks...">
          </div>
          
          <input type="hidden" id="filterSubaccount" value="" />

          <button id="newTaskBtn" style="display:none;" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-2.5 px-5 rounded-xl text-xs shadow-lg shadow-slate-200 transition-all hover:-translate-y-0.5 active:scale-95 flex items-center gap-2">
            <span class="bg-white/20 rounded-full p-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></span>
            New Request
          </button>

          <div class="relative">
            <button id="notifBtn" class="p-2.5 rounded-xl bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-indigo-600 transition-all shadow-sm relative">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
              <span id="notifCount" class="absolute top-2 right-2.5 h-2 w-2 rounded-full bg-rose-500 border border-white hidden"></span>
            </button>
            <div id="notifPanel" class="hidden absolute right-0 mt-4 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 overflow-hidden z-50 fade-in-up origin-top-right ring-1 ring-black/5">
              <div class="px-4 py-3 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">Notifications</h3>
                <button id="markAllReadBtn" class="text-[10px] text-indigo-600 font-bold hover:underline">Clear all</button>
              </div>
              <div id="notifList" class="max-h-80 overflow-y-auto"></div>
            </div>
          </div>

          <div class="h-9 w-9 rounded-xl border border-slate-200 shadow-sm flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-indigo-500 transition-all overflow-hidden bg-slate-100" id="logoutBtn" title="Logout">
            <img id="userAvatar" class="w-full h-full object-cover" src="" alt="User" />
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-[1920px] mx-auto px-4 sm:px-6 py-6 h-[calc(100vh-64px)] flex flex-col lg:flex-row gap-6 overflow-hidden">
      
      <aside class="hidden lg:flex flex-col w-72 shrink-0 h-full gap-4 pb-2">
        <div class="glass-panel flex-1 rounded-3xl flex flex-col overflow-hidden shadow-sm hover:shadow-md transition-shadow">
          <div class="p-5 border-b border-white/50 flex items-center justify-between bg-white/30 backdrop-blur-md">
            <div class="flex items-center gap-2 text-slate-700">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                <h2 class="font-bold text-sm">Subaccounts</h2>
            </div>
            <button id="addSubBtn" class="text-[10px] font-bold bg-white/80 border border-white text-slate-600 hover:text-indigo-600 hover:bg-white rounded-lg px-2.5 py-1.5 transition-all shadow-sm">+ Add</button>
          </div>
          <div id="subList" class="flex-1 overflow-y-auto p-3 custom-scrollbar"></div>
        </div>
        
        <div class="glass-panel p-4 rounded-2xl flex items-center gap-3 shadow-sm border border-white/60 bg-white/60">
          <div class="h-10 w-10 rounded-full bg-slate-200 overflow-hidden shadow-sm">
              <img id="userBadgeAvatar" class="w-full h-full object-cover" src="" />
          </div>
          <div class="min-w-0">
            <div id="userBadge" class="font-bold text-sm text-slate-900 truncate">Loading...</div>
            <div id="wsBadge" class="text-xs text-slate-500 truncate opacity-80">Workspace</div>
          </div>
        </div>
        <div class="mt-auto pt-4 border-t border-indigo-100 text-[10px] text-slate-400 text-center">
          System developed by <span class="font-bold text-indigo-500">Abdul Kalam</span>
        </div>
      </aside>

      <section class="flex-1 h-full overflow-x-auto overflow-y-hidden pb-4">
        <div id="board" class="h-full flex gap-6 min-w-max px-2"></div>
      </section>
    </main>
</div>

<div id="subDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-md p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
    <div class="fade-in-up w-full max-w-4xl h-[80vh] bg-slate-50 rounded-[2rem] shadow-2xl flex overflow-hidden border border-white/40">
        <div class="w-72 bg-white border-r border-slate-200 flex flex-col p-6">
            <div class="h-14 w-14 rounded-2xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 mb-4 shadow-sm">
                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>
            <h2 class="font-bold text-lg text-slate-800 mb-1">Manage Subaccount</h2>
            <p class="text-xs text-slate-400 font-medium mb-6">Edit settings or delete.</p>
            <div class="space-y-4 mb-auto">
                <div>
                   <label class="text-[10px] font-bold uppercase text-slate-400">Subaccount Name</label>
                   <input id="editSubName" class="w-full mt-1 border border-slate-200 rounded-lg p-2.5 text-sm font-bold text-slate-700 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                </div>
                <button id="btnUpdateSub" class="w-full py-2.5 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 transition shadow-sm">Save Changes</button>
            </div>
            <div class="mt-8 pt-6 border-t border-slate-100">
                <button id="btnDeleteSub" class="w-full py-3 rounded-xl bg-rose-50 border border-rose-100 text-rose-600 text-sm font-bold hover:bg-rose-100 transition shadow-sm flex items-center justify-center gap-2">Delete Account</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-700">Project Progress Overview</h3>
                <button onclick="$('subDetailsModal').classList.add('hidden')" class="h-8 w-8 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-500 transition">‚úï</button>
            </div>
            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Backend / API</span><span id="progBackend" class="text-xs font-bold text-indigo-600">0%</span></div>
                    <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div id="barBackend" class="h-full bg-indigo-500 w-0 transition-all duration-1000"></div></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Frontend / UI</span><span id="progFrontend" class="text-xs font-bold text-pink-600">0%</span></div>
                    <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div id="barFrontend" class="h-full bg-pink-500 w-0 transition-all duration-1000"></div></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500 uppercase">AI Agents</span><span id="progAI" class="text-xs font-bold text-emerald-600">0%</span></div>
                    <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div id="barAI" class="h-full bg-emerald-500 w-0 transition-all duration-1000"></div></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Pipeline / Auto</span><span id="progPipe" class="text-xs font-bold text-amber-600">0%</span></div>
                    <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div id="barPipe" class="h-full bg-amber-500 w-0 transition-all duration-1000"></div></div>
                </div>
            </div>
            <h3 class="font-bold text-lg text-slate-700 mb-4">Request History</h3>
            <div id="sdHistoryList" class="space-y-3"></div>
        </div>
    </div>
</div>

<div id="subModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="fade-in-up w-full max-w-sm bg-white rounded-3xl shadow-2xl p-6 border border-white">
    <h3 class="font-bold text-lg mb-1">Add Subaccount</h3>
    <input id="subNameInput" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-xl p-3 mt-4 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g. Acme Solar - Texas" />
    <div class="mt-6 flex justify-end gap-2">
      <button id="closeSubModalBtn" class="px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50">Cancel</button>
      <button id="saveSubBtn" class="px-5 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200">Create</button>
    </div>
  </div>
</div>

<div id="taskModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="fade-in-up w-full max-w-2xl bg-white rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-white/50">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
        </div>
        <div>
            <h3 class="font-bold text-lg text-slate-900">New Request</h3>
            <p class="text-xs text-slate-500">Submit a task for the GHL Expert</p>
        </div>
      </div>
      <button id="closeTaskModal" class="h-8 w-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-rose-500 transition">‚úï</button>
    </div>
    
    <div class="p-6 overflow-y-auto space-y-5">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Task Title</label>
          <input id="tTitle" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Short summary..." />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Subaccount</label>
          <select id="tSub" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"></select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
         <div class="space-y-1">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Priority</label>
            <select id="tPriority" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                <option value="low">Low Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="high">High Priority üî•</option>
            </select>
         </div>
         <div class="space-y-1">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Due Date</label>
            <input type="date" id="tDate" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white" />
         </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Category</label>
          <select id="tCategory" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
             <option value="general">General Request</option>
             <option value="backend">Backend / API</option>
             <option value="frontend">Frontend / UI</option>
             <option value="ai_agent">AI Agent / Bot</option>
             <option value="pipeline">Pipeline / Automation</option>
          </select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Assign Expert</label>
          <select id="tAssignee" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
            <option value="kalam">Kalam</option>
            <option value="yashfa">Yashfa</option>
          </select>
        </div>
      </div>

      <div class="space-y-1">
         <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Upload File</label>
         <input type="file" id="tFile" class="w-full border border-slate-200 rounded-xl px-3.5 py-2 text-sm focus:ring-2 focus:ring-indigo-500 bg-white file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Details</label>
        <textarea id="tDetails" rows="4" class="w-full border border-slate-200 rounded-xl px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="Describe what needs to be done..."></textarea>
      </div>
    </div>

    <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
      <button id="cancelTaskBtn" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition">Cancel</button>
      <button id="createTaskBtn" class="px-6 py-2.5 rounded-xl text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition transform active:scale-95">Create & Notify</button>
    </div>
  </div>
</div>

<div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm p-4 hidden" onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="fade-in-up w-full max-w-5xl h-[85vh] bg-white rounded-3xl shadow-2xl flex overflow-hidden border border-white/50">
    <div class="w-full lg:w-1/3 bg-slate-50/80 border-r border-slate-200 flex flex-col">
      <div class="p-6 border-b border-slate-200 bg-white/50">
        <div class="flex justify-between items-start mb-1">
          <div class="flex flex-col">
             <h3 id="dTitle" class="font-bold text-lg text-slate-900 leading-tight">Task Title</h3>
             <div id="dMeta" class="text-xs font-medium text-slate-500 mt-1 flex items-center gap-2"></div>
          </div>
          <div class="flex items-center gap-2">
             <button id="btnDeleteTask" class="p-1.5 rounded-lg text-slate-400 hover:text-rose-600 hover:bg-rose-50 transition" title="Delete Task">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
             </button>
             <button id="closeDetailsModal" class="p-2 text-slate-400 hover:text-slate-700 transition">‚úï</button>
          </div>
        </div>
        <a id="dAttachLink" href="#" target="_blank" class="hidden mt-3 inline-flex items-center gap-2 px-3 py-2 bg-white text-indigo-600 text-xs font-bold rounded-xl border border-indigo-100 hover:border-indigo-300 shadow-sm transition-all hover:-translate-y-0.5"><span>üîó</span> View Attachment</a>
      </div>

      <div class="flex-1 overflow-y-auto p-6 space-y-5 custom-scrollbar">
        <div class="space-y-1">
          <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Status</label>
          <select id="dStatus" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></select>
        </div>

        <div class="grid grid-cols-2 gap-3">
             <div class="space-y-1">
                <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Priority</label>
                <select id="dPriority" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High üî•</option>
                </select>
             </div>
             <div class="space-y-1">
                <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Due Date</label>
                <input type="date" id="dDate" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" />
             </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Subaccount</label>
          <select id="dSub" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></select>
        </div>
        <div class="space-y-1">
          <label class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Description</label>
          <textarea id="dDetails" rows="6" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
        </div>

        <div id="expertControls" class="grid grid-cols-2 gap-2 pt-2">
          <button onclick="updateStatus('clarify')" class="p-2.5 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-600 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200 transition shadow-sm">‚ö†Ô∏è Clarify</button>
          <button onclick="updateStatus('progress')" class="p-2.5 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition shadow-sm">üî® In Progress</button>
          <button onclick="updateStatus('review')" class="col-span-2 p-3 rounded-xl bg-slate-800 text-white text-xs font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200">üëÄ Send for Review</button>
          <button onclick="updateStatus('done')" class="col-span-2 p-3 rounded-xl bg-emerald-600 text-white text-xs font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">‚úÖ Mark Done</button>
        </div>
        <div id="clientControls" class="hidden grid grid-cols-2 gap-2 pt-2">
          <button onclick="updateStatus('done')" class="col-span-2 p-3 rounded-xl bg-emerald-600 text-white text-sm font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition">Approve & Close ‚úÖ</button>
          <button onclick="updateStatus('clarify')" class="col-span-2 p-3 rounded-xl border border-rose-200 text-rose-600 bg-rose-50 text-sm font-bold hover:bg-rose-100 transition">Request Changes</button>
        </div>
        <button id="saveTaskBtn" class="w-full py-3 rounded-xl bg-white border border-indigo-100 text-indigo-600 text-sm font-bold hover:bg-indigo-50 transition mt-2 shadow-sm">Save Edits</button>
      </div>
    </div>
    <div class="w-full lg:w-2/3 flex flex-col bg-white">
      <div class="p-4 border-b border-slate-100 bg-slate-50/30 flex items-center gap-2">
        <span class="text-lg">üí¨</span>
        <h4 class="font-bold text-sm text-slate-700">Discussion Log</h4>
      </div>
      <div id="thread" class="flex-1 overflow-y-auto p-5 space-y-4 bg-white custom-scrollbar"></div>
      <div class="p-4 border-t border-slate-100 bg-slate-50">
        <div class="flex gap-2">
          <input id="msgInput" class="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition shadow-sm" placeholder="Write a comment..." />
          <button id="sendMsgBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 rounded-xl font-bold transition shadow-md shadow-indigo-200 active:scale-95">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =================================================================
   ‚ö°Ô∏è CONFIGURATION
   ================================================================= */
const EMAIL_WEBHOOK_URL = "https://jalil3-sherani.app.n8n.cloud/webhook/task-notification"; 
const EXPERT_EMAILS = { "kalam": "kalamshar786@gmail.com", "yashfa": "missperfect.mine@gmail.com" };

/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDHL0tVJ7tm4lK4r7gQrZ7McPJwFOaRulc",
  authDomain: "romatech-system.firebaseapp.com",
  projectId: "romatech-system",
  storageBucket: "romatech-system.firebasestorage.app",
  messagingSenderId: "368102739583",
  appId: "1:368102739583:web:92baa7b3abf14e7653b94a",
  measurementId: "G-7CWF4D2V3T"
};
if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* =========================
   HELPERS & UTILS
========================= */
const $ = (id) => document.getElementById(id);
const clean = (s) => (s || "").trim();
const nowISO = () => new Date().toISOString();
const escapeHtml = (str) => (str ?? "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");

function linkify(text) {
  const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  return escapeHtml(text).replace(urlRegex, (url) => {
    return `<a href="${url}" target="_blank" class="text-indigo-600 font-semibold hover:underline break-all relative z-10" onclick="event.stopPropagation()">${url}</a>`;
  });
}

function showToast(msg) {
  const t = $("toast");
  $("toastText").textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(window.toastTimer);
  window.toastTimer = setTimeout(() => t.classList.add("hidden"), 2500);
}

// Generate Avatar URL
function getAvatar(name) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&bold=true`;
}

async function notifyWebhook(actionType, taskTitle, details, targetUser, attachmentUrl) {
    if(!EMAIL_WEBHOOK_URL) return;
    const recipient = EXPERT_EMAILS[targetUser] || "kalamshar786@gmail.com";
    const bodyText = `Action by: ${USER} (${ROLE})\n\n${details}\n\n${attachmentUrl ? "üìé File: " + attachmentUrl : ""}`;
    try {
        await fetch(EMAIL_WEBHOOK_URL, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ recipient, subject: `[Tracker] ${actionType}: ${taskTitle}`, message: bodyText, sentAt: new Date().toLocaleString() })
        });
    } catch(e) { console.error(e); }
}

// Global State
let WS = null, USER = null, ROLE = null, UID = null;
let subaccounts = [], tasks = [], notifications = [];
let currentTaskId = null;
let currentSubId = null; 
let authMode = "login"; // "login" or "register"

const COLUMNS = [
  { id: "requested", label: "Requested", color: "bg-sky-500" },
  { id: "clarify", label: "Clarification", color: "bg-amber-500" },
  { id: "progress", label: "In Progress", color: "bg-indigo-500" },
  { id: "review", label: "Client Review", color: "bg-fuchsia-500" },
  { id: "done", label: "Done", color: "bg-emerald-500" }
];

const isBuilder = () => ROLE === "builder";
const isClient = () => ROLE === "client";
const canCreate = () => isClient() || isBuilder();

/* =========================
   AUTH LOGIC
========================= */
// Switch between Login and Register views
function toggleAuth() {
    authMode = authMode === "login" ? "register" : "login";
    
    if(authMode === "login") {
        $("authTitle").textContent = "Welcome Back";
        $("authActionBtn").textContent = "Sign In";
        $("authToggleBtn").textContent = "Don't have an account? Create one";
        $("roleField").classList.add("hidden");
    } else {
        $("authTitle").textContent = "Create Account";
        $("authActionBtn").textContent = "Register";
        $("authToggleBtn").textContent = "Already have an account? Sign In";
        $("roleField").classList.remove("hidden");
    }
}

$("authToggleBtn").onclick = toggleAuth;

// Auth Action (Login or Register based on mode)
$("authActionBtn").onclick = async () => {
  const ws = clean($("wsInput").value);
  const username = clean($("usernameInput").value).toLowerCase();
  const password = $("passwordInput").value;
  const role = $("roleInput").value;

  if (!ws || !username || !password) return alert("All fields required");
  const email = `${username}@${ws}.local`; 
  
  try {
    let userCred;
    if (authMode === "register") {
      userCred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection("workspaces").doc(ws).collection("users").doc(userCred.user.uid).set({
        username, role, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } else {
      userCred = await auth.signInWithEmailAndPassword(email, password);
    }
    await loadUserProfile(ws, username, userCred.user.uid);
  } catch (e) {
    $("authMsg").textContent = e.message;
    $("authMsg").classList.remove("hidden");
  }
};

async function loadUserProfile(ws, username, uid) {
  WS = ws; USER = username; UID = uid;
  const snap = await db.collection("workspaces").doc(WS).collection("users").doc(UID).get();
  ROLE = snap.exists ? snap.data().role : "client";

  // Hide Login/Loading, Show App
  $("globalLoader").classList.add("hidden");
  $("authContainer").classList.add("hidden");
  
  $("appInterface").classList.remove("hidden");
  setTimeout(() => $("appInterface").classList.remove("opacity-0"), 50);

  $("userBadge").textContent = USER;
  $("wsBadge").textContent = WS;
  
  const av = getAvatar(USER);
  $("userAvatar").src = av;
  $("userBadgeAvatar").src = av;

  $("newTaskBtn").style.display = canCreate() ? "flex" : "none";
  initRealtime();
}

$("logoutBtn").onclick = () => { auth.signOut(); location.reload(); };

/* =========================
   DATA & RENDER
========================= */
function initRealtime() {
  const root = db.collection("workspaces").doc(WS);
  
  root.collection("subaccounts").orderBy("createdAt", "desc").onSnapshot(snap => {
    subaccounts = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderSubs(); renderBoard(); updateDropdowns();
  });

  root.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snap => {
    tasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderBoard();
    renderSubs(); 
    if (currentTaskId) { const t = tasks.find(x => x.id === currentTaskId); if(t) renderDetails(t); else { $("detailsModal").classList.add("hidden"); currentTaskId = null; } }
    if (currentSubId && !$("subDetailsModal").classList.contains("hidden")) { renderSubDetails(currentSubId); }
  });

  root.collection("notifications").where("toUsername", "==", USER).orderBy("createdAt", "desc").limit(20).onSnapshot(snap => {
    notifications = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderNotifs();
  });
}

function updateDropdowns() {
  const opts = subaccounts.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
  $("tSub").innerHTML = opts;
  $("dSub").innerHTML = opts;
  $("dStatus").innerHTML = COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join("");
}

function renderSubs() {
  const list = $("subList");
  list.innerHTML = "";
  if (subaccounts.length === 0) { list.innerHTML = `<div class="text-xs text-slate-400 p-4 text-center italic border-2 border-dashed border-slate-200 rounded-xl m-2">No subaccounts yet.</div>`; return; }

  const currentFilter = $("filterSubaccount").value;

  subaccounts.forEach(s => {
     const open = tasks.filter(t => t.subaccountId === s.id && t.status !== 'done').length;
     const isActive = currentFilter === s.id;
     
     const container = document.createElement("div");
     container.className = `sub-item-container flex gap-2 items-center mb-2 px-1`;

     const btn = document.createElement("button");
     btn.className = `sub-item-main flex-1 text-left px-4 py-3 rounded-xl text-sm font-medium flex justify-between items-center border border-transparent transition-all duration-200 ${isActive ? 'active' : 'text-slate-600'}`;
     btn.innerHTML = `
        <span class="sub-name truncate font-semibold tracking-tight">${escapeHtml(s.name)}</span> 
        ${open > 0 ? `<span class="sub-count px-2 py-0.5 rounded-full text-[10px] font-bold ${isActive ? 'bg-white text-indigo-600' : 'bg-indigo-100 text-indigo-700'}">${open}</span>` : `<span class="sub-arrow h-5 w-5 rounded-full flex items-center justify-center text-slate-300">‚ûú</span>`}
     `;
     btn.onclick = () => { 
        $("filterSubaccount").value = isActive ? "" : s.id; 
        renderBoard(); renderSubs(); 
     };

     const settingsBtn = document.createElement("button");
     settingsBtn.className = `settings-btn h-8 w-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all`;
     settingsBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`; 
     settingsBtn.onclick = (e) => { e.stopPropagation(); openSubDetails(s.id); };

     container.appendChild(btn);
     container.appendChild(settingsBtn);
     list.appendChild(container);
  });
}

function renderBoard() {
  const board = $("board");
  board.innerHTML = "";
  const filterSub = $("filterSubaccount").value;
  const search = $("searchInput").value.toLowerCase();
  
  const filtered = tasks.filter(t => {
    if (filterSub && t.subaccountId !== filterSub) return false;
    if (search && !t.title.toLowerCase().includes(search)) return false;
    return true;
  });

  COLUMNS.forEach(col => {
    const colTasks = filtered.filter(t => (t.status || 'requested') === col.id);
    const colDiv = document.createElement("div");
    colDiv.className = "w-80 shrink-0 flex flex-col h-full rounded-[1.5rem] bg-white/40 border border-white/60 shadow-inner overflow-hidden backdrop-blur-sm";
    colDiv.innerHTML = `
      <div class="p-4 flex items-center justify-between shrink-0 border-b border-white/40">
         <div class="flex items-center gap-2.5">
            <div class="h-3 w-3 rounded-full ${col.color} shadow-sm ring-2 ring-white"></div>
            <h3 class="font-bold text-xs text-slate-700 uppercase tracking-widest">${col.label}</h3>
         </div>
         <span class="text-[10px] font-bold text-slate-500 bg-white/80 px-2.5 py-1 rounded-full shadow-sm ring-1 ring-slate-100">${colTasks.length}</span>
      </div>
      <div class="flex-1 overflow-y-auto px-3 pb-3 space-y-3 pt-3 scroll-smooth custom-scrollbar" id="col_${col.id}" data-status="${col.id}"></div>
    `;
    const zone = colDiv.querySelector(`#col_${col.id}`);
    colTasks.forEach(t => {
       const subName = subaccounts.find(s => s.id === t.subaccountId)?.name || "‚Äî";
       
       let prioBadge = "";
       if(t.priority === "high") prioBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border border-rose-200 bg-rose-50 text-rose-600">HIGH</span>`;
       else if(t.priority === "medium") prioBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border border-amber-200 bg-amber-50 text-amber-600">MED</span>`;
       else prioBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border border-slate-200 bg-slate-50 text-slate-500">LOW</span>`;

       // üü¢ UPDATED: Show Time Created logic
       let dateDisplay = "";
       if(t.dueDate) {
           const d = new Date(t.dueDate);
           const isOverdue = d < new Date() && t.status !== 'done';
           dateDisplay = `<span class="text-[10px] font-medium ${isOverdue ? 'text-rose-600 font-bold' : 'text-slate-400'}">Due: ${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})} ${isOverdue ? '‚ö†Ô∏è' : ''}</span>`;
       } else {
           // Show created time if no due date
           const createdObj = new Date(t.createdAt?.seconds * 1000 || Date.now());
           const createdStr = createdObj.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
           dateDisplay = `<span class="text-[10px] text-slate-400 font-medium" title="Created At">${createdStr}</span>`;
       }

       const card = document.createElement("div");
       card.className = "glass-card p-4 rounded-2xl cursor-pointer relative group";
       card.setAttribute("data-id", t.id);
       card.innerHTML = `
         <div class="flex justify-between items-start mb-2.5">
            <div class="flex gap-1">
                <span class="text-[9px] font-bold text-indigo-600 bg-indigo-50/80 px-2 py-1 rounded-lg border border-indigo-100 truncate max-w-[100px] uppercase tracking-wide backdrop-blur-sm">${escapeHtml(subName)}</span>
                ${prioBadge}
            </div>
            <div class="h-6 w-6 rounded-full bg-slate-100 overflow-hidden shadow-sm border border-white">
                <img src="${getAvatar(t.assigneeUsername||'?')}" class="w-full h-full object-cover" />
            </div>
         </div>
         <h4 class="font-bold text-sm text-slate-800 leading-snug mb-3 pr-2 group-hover:text-indigo-600 transition-colors">${escapeHtml(t.title)}</h4>
         ${t.category ? `<div class="text-[10px] text-slate-400 mb-2 font-mono">#${t.category}</div>` : ''}
         <div class="flex items-center justify-between pt-3 border-t border-slate-100/50">
             <div class="flex items-center gap-2">
                ${t.attachmentUrl ? `<span class="text-xs bg-slate-100 p-1 rounded-md">üìé</span>` : ''}
                ${dateDisplay}
             </div>
             <div class="flex items-center gap-1.5 text-slate-400 group-hover:text-indigo-500 transition-colors bg-slate-50 px-2 py-0.5 rounded-full">
                <span class="text-[10px] font-bold">üí¨ ${(t.messages||[]).length}</span>
             </div>
         </div>
       `;
       card.addEventListener('click', () => openDetails(t.id));
       zone.appendChild(card);
    });
    board.appendChild(colDiv);
    new Sortable(zone, {
        group: 'shared', animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true,
        onEnd: function (evt) {
            const taskId = evt.item.getAttribute('data-id');
            const newStatus = evt.to.getAttribute('data-status');
            if (newStatus !== evt.from.getAttribute('data-status')) {
                const t = tasks.find(x => x.id === taskId);
                db.collection("workspaces").doc(WS).collection("tasks").doc(taskId).update({status: newStatus});
                notifyWebhook("Status Change", t?.title, `Moved to ${newStatus}`, t?.assigneeUsername, t?.attachmentUrl);
                showToast(`Moved to ${newStatus}`);
            }
        }
    });
  });
}

function renderNotifs() {
  const list = $("notifList");
  list.innerHTML = "";
  const unread = notifications.filter(n => !n.read).length;
  const badge = $("notifCount");
  if (unread > 0) { badge.textContent = ""; badge.classList.remove("hidden"); badge.classList.add("animate-pulse"); } else { badge.classList.add("hidden"); }
  if(notifications.length === 0) { list.innerHTML = `<div class="p-6 text-center text-xs text-slate-400 italic">No notifications yet.</div>`; return; }
  notifications.forEach(n => {
     const div = document.createElement("div");
     div.className = `p-3 border-b border-slate-50 text-xs cursor-pointer transition-colors hover:bg-slate-50 ${n.read ? 'opacity-60 bg-white' : 'bg-indigo-50/30'}`;
     div.innerHTML = `<div class="font-bold ${n.read?'text-slate-700':'text-indigo-700'}">${escapeHtml(n.title)}</div><div class="text-slate-500 truncate mt-0.5">${escapeHtml(n.body)}</div>`;
     div.onclick = async () => { await db.collection("workspaces").doc(WS).collection("notifications").doc(n.id).update({read:true}); if(n.taskId) openDetails(n.taskId); };
     list.appendChild(div);
  });
}

/* =========================
   SUBACCOUNT DETAILS DASHBOARD
========================= */
function openSubDetails(subId) {
    currentSubId = subId;
    renderSubDetails(subId);
    $("subDetailsModal").classList.remove("hidden");
    $("subDetailsModal").classList.add("flex");
}

function renderSubDetails(subId) {
    const sub = subaccounts.find(s => s.id === subId);
    if (!sub) return;
    $("editSubName").value = sub.name; 
    const subTasks = tasks.filter(t => t.subaccountId === subId);
    const calcProgress = (cat) => {
        const catTasks = subTasks.filter(t => t.category === cat);
        if (catTasks.length === 0) return 0;
        const done = catTasks.filter(t => t.status === 'done').length;
        return Math.round((done / catTasks.length) * 100);
    };
    const cats = { backend: calcProgress('backend'), frontend: calcProgress('frontend'), ai_agent: calcProgress('ai_agent'), pipeline: calcProgress('pipeline') };
    $("progBackend").textContent = `${cats.backend}%`; $("barBackend").style.width = `${cats.backend}%`;
    $("progFrontend").textContent = `${cats.frontend}%`; $("barFrontend").style.width = `${cats.frontend}%`;
    $("progAI").textContent = `${cats.ai_agent}%`; $("barAI").style.width = `${cats.ai_agent}%`;
    $("progPipe").textContent = `${cats.pipeline}%`; $("barPipe").style.width = `${cats.pipeline}%`;
    const list = $("sdHistoryList");
    list.innerHTML = "";
    if(subTasks.length === 0) { list.innerHTML = `<div class="text-center text-slate-400 text-sm py-4">No requests found.</div>`; }
    subTasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl hover:shadow-md transition cursor-pointer";
        const statusColors = { requested:'bg-sky-100 text-sky-700', done:'bg-emerald-100 text-emerald-700', progress:'bg-indigo-100 text-indigo-700', clarify:'bg-amber-100 text-amber-700', review:'bg-fuchsia-100 text-fuchsia-700' };
        div.innerHTML = `<div><div class="font-bold text-slate-800 text-sm">${escapeHtml(t.title)}</div><div class="text-[10px] text-slate-400 mt-1">${new Date(t.createdAt?.seconds*1000).toLocaleDateString()} ‚Ä¢ #${t.category||'general'}</div></div><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${statusColors[t.status]||'bg-slate-100'}">${t.status}</span>`;
        div.onclick = () => { $("subDetailsModal").classList.add("hidden"); openDetails(t.id); };
        list.appendChild(div);
    });
}

$("btnUpdateSub").onclick = async () => {
    const newName = clean($("editSubName").value);
    if(!newName || !currentSubId) return;
    await db.collection("workspaces").doc(WS).collection("subaccounts").doc(currentSubId).update({name: newName});
    showToast("Subaccount Name Updated");
};

$("btnDeleteSub").onclick = async () => {
    if(!confirm(`Are you sure you want to DELETE this subaccount? This cannot be undone.`)) return;
    await db.collection("workspaces").doc(WS).collection("subaccounts").doc(currentSubId).delete();
    $("subDetailsModal").classList.add("hidden");
    $("filterSubaccount").value = ""; 
    renderSubs(); renderBoard();
    showToast("Subaccount Deleted");
};

/* =========================
   ACTIONS
========================= */
$("addSubBtn").onclick = () => { $("subModal").classList.remove("hidden"); $("subModal").classList.add("flex"); };
$("closeSubModalBtn").onclick = () => $("subModal").classList.add("hidden");
$("saveSubBtn").onclick = async () => {
   const name = clean($("subNameInput").value);
   if(!name) return;
   await db.collection("workspaces").doc(WS).collection("subaccounts").add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
   $("subModal").classList.add("hidden");
   showToast("Subaccount added");
};

$("newTaskBtn").onclick = () => { 
    if(!isClient() && !isBuilder()) return alert("Only Clients can request.");
    $("taskModal").classList.remove("hidden"); $("taskModal").classList.add("flex"); 
};
$("closeTaskModal").onclick = () => $("taskModal").classList.add("hidden");
$("cancelTaskBtn").onclick = () => $("taskModal").classList.add("hidden");

$("createTaskBtn").onclick = async () => {
    const title = clean($("tTitle").value);
    const subId = $("tSub").value;
    const category = $("tCategory").value; 
    const assignee = clean($("tAssignee").value);
    const details = clean($("tDetails").value);
    const priority = $("tPriority").value;
    const dueDate = $("tDate").value;
    const file = $("tFile").files[0];
    let attachmentUrl = "";

    if(!title || !subId || !assignee) return alert("Title, Subaccount, and Assignee are required.");
    const btn = $("createTaskBtn"); btn.disabled = true; btn.textContent = "Processing...";

    if (file) {
        try {
            const ref = storage.ref(`workspaces/${WS}/files/${Date.now()}_${file.name}`);
            await ref.put(file);
            attachmentUrl = await ref.getDownloadURL();
        } catch(e) { console.error("Upload failed", e); }
    }

    const ref = await db.collection("workspaces").doc(WS).collection("tasks").add({
        title, details, subaccountId: subId, category, priority, dueDate, assigneeUsername: assignee, attachmentUrl,
        status: 'requested', createdBy: USER, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        messages: [{by: USER, role: ROLE, text: "Request created.", at: nowISO()}]
    });

    await db.collection("workspaces").doc(WS).collection("notifications").add({
        toUsername: assignee, title: "New Task", body: title, taskId: ref.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    notifyWebhook("New Task", title, details, assignee, attachmentUrl);
    
    $("taskModal").classList.add("hidden");
    $("tTitle").value = ""; $("tDetails").value = ""; $("tFile").value = ""; $("tDate").value = "";
    btn.disabled = false; btn.textContent = "Create & Notify";
    showToast("Task Created");
};

function openDetails(id) {
    currentTaskId = id;
    const t = tasks.find(x => x.id === id);
    if(!t) return;
    $("detailsModal").classList.remove("hidden"); $("detailsModal").classList.add("flex");
    $("dTitle").textContent = t.title;
    
    // üü¢ UPDATED: Specific Created Time logic
    const createdObj = new Date(t.createdAt?.seconds * 1000 || Date.now());
    const createdStr = createdObj.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    $("dMeta").textContent = `@${t.assigneeUsername} ‚Ä¢ Created on ${createdStr}`;

    $("dStatus").value = t.status;
    $("dSub").value = t.subaccountId;
    $("dDetails").value = t.details || "";
    $("dPriority").value = t.priority || "medium"; 
    $("dDate").value = t.dueDate || ""; 
    
    if(t.attachmentUrl) { $("dAttachLink").href = t.attachmentUrl; $("dAttachLink").classList.remove("hidden"); $("dAttachLink").classList.add("inline-flex"); } else { $("dAttachLink").classList.add("hidden"); }
    
    if(isClient() && t.status === 'review') { $("clientControls").classList.remove("hidden"); $("expertControls").classList.add("hidden"); } 
    else { $("clientControls").classList.add("hidden"); $("expertControls").classList.remove("hidden"); }
    renderThread(t);
}

$("closeDetailsModal").onclick = () => { $("detailsModal").classList.add("hidden"); currentTaskId = null; };

$("btnDeleteTask").onclick = async () => {
    if(!currentTaskId) return;
    if(confirm("Are you sure you want to delete this task permanently?")) {
        const t = tasks.find(x => x.id === currentTaskId);
        notifyWebhook("Task Deleted", t?.title, "Deleted", t?.assigneeUsername, "");
        await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).delete();
        showToast("Task Deleted");
        $("detailsModal").classList.add("hidden");
        currentTaskId = null;
    }
};

function renderThread(t) {
    const div = $("thread"); div.innerHTML = "";
    if(t.details) {
        const d = document.createElement("div"); d.className = "p-4 rounded-2xl bg-slate-50/80 border border-slate-100 mb-6";
        d.innerHTML = `<div class="text-[10px] font-bold uppercase text-slate-400 mb-2">Original Request</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${linkify(t.details)}</div>`;
        div.appendChild(d);
    }
    (t.messages||[]).forEach(m => {
        const isMe = m.by === USER;
        const msg = document.createElement("div");
        msg.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-3`;
        msg.innerHTML = `
            <div class="max-w-[85%] px-4 py-3 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-100 rounded-tl-none text-slate-700'}">${linkify(m.text)}</div>
            <div class="text-[10px] text-slate-400 mt-1 px-1 font-medium">${m.by}</div>
        `;
        div.appendChild(msg);
    });
    div.scrollTop = div.scrollHeight;
}

$("sendMsgBtn").onclick = async () => {
    const txt = clean($("msgInput").value);
    if(!txt || !currentTaskId) return;
    const t = tasks.find(x => x.id === currentTaskId);
    const msgs = [...(t.messages||[]), {by: USER, role: ROLE, text: txt, at: nowISO()}];
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({messages: msgs});
    $("msgInput").value = "";
    const target = t.assigneeUsername || "kalam";
    notifyWebhook("New Comment", t.title, `${USER}: ${txt}`, target, "");
    if(t.assigneeUsername !== USER) {
        await db.collection("workspaces").doc(WS).collection("notifications").add({ toUsername: t.assigneeUsername, title: "New Comment", body: `${USER} commented on ${t.title}`, taskId: t.id, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
};

async function updateStatus(st) {
    if(!currentTaskId) return;
    const t = tasks.find(x => x.id === currentTaskId);
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({status: st});
    notifyWebhook("Status Change", t.title, `Moved to ${st}`, t.assigneeUsername, "");
    showToast("Status Updated");
    if(st === 'done') $("detailsModal").classList.add("hidden");
}

$("saveTaskBtn").onclick = async () => {
    if(!currentTaskId) return;
    await db.collection("workspaces").doc(WS).collection("tasks").doc(currentTaskId).update({ 
        details: clean($("dDetails").value), 
        subaccountId: $("dSub").value, 
        status: $("dStatus").value,
        priority: $("dPriority").value, 
        dueDate: $("dDate").value       
    });
    showToast("Changes Saved");
};

$("markAllReadBtn").onclick = async () => {
    const batch = db.batch();
    notifications.filter(n=>!n.read).forEach(n => batch.update(db.collection("workspaces").doc(WS).collection("notifications").doc(n.id), {read:true}));
    await batch.commit();
}

$("searchInput").addEventListener("input", renderBoard);
$("notifBtn").onclick = () => $("notifPanel").classList.toggle("hidden");

/* ===================================================
   üí° INTELLIGENT AUTH STATE HANDLER (Fixes Flashing)
   =================================================== */
auth.onAuthStateChanged(u => {
    // 1. Always hide the global loader once Firebase responds
    $("globalLoader").classList.add("hidden");

    if(!u) { 
        // 2. Not Logged In? Show Auth Screen, Hide App
        $("authContainer").classList.remove("hidden");
        $("appInterface").classList.add("hidden");
    } else {
        // 3. Logged In? Hide Auth Screen, Show App
        // Logic handled in loadUserProfile(), but safe to ensure here too if session persists
        // Note: loadUserProfile is called by login, but on reload, this listener fires.
        // We need to re-fetch profile if just reloading.
        if(!USER) { 
             // Quick re-fetch for reload scenario
             const parts = u.email.split('@'); 
             const username = parts[0];
             const ws = parts[1].replace('.local','');
             loadUserProfile(ws, username, u.uid);
        }
    }
});
</script>
</body>
</html>
